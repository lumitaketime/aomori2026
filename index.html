<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é’æ£®å‡½é¤¨å†¬æ—… 2026</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FAF9F6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;900&family=Zen+Maru+Gothic:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #FAF9F6;
            --text-main: #2C2C2C;
            --text-sub: #8E8E93;
            --accent-gold: #C5A059;
            --accent-red: #D32F2F;
            --line-color: #E0E0E0;
            --card-shadow: 0 8px 24px rgba(0,0,0,0.06);
            --safe-area-bottom: env(safe-area-inset-bottom);
            --info-blue: #42A5F5; /* For Info boxes/Smart Reminders */
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0; padding-bottom: calc(90px + var(--safe-area-bottom));
            overscroll-behavior-y: none;
        }

        h1, h2, h3, .serif { font-family: 'Noto Serif TC', serif; }

        /* --- HEADER & DATE NAV --- */
        .header {
            padding: 50px 20px 10px; background: var(--bg-color); position: sticky; top: 0; z-index: 100;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .app-title { text-align: center; font-size: 1.4rem; font-weight: 900; letter-spacing: 2px; margin-bottom: 5px; }
        .app-meta { display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; font-size: 0.8rem; color: var(--text-sub); }

        /* Date Navigator */
        .date-nav { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .date-item {
            display: flex; flex-direction: column; align-items: center; min-width: 50px; padding: 8px 0; border-radius: 25px; transition: 0.3s; color: #BBB;
        }
        .date-item.active { color: var(--text-main); background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .date-weekday { font-size: 0.7rem; font-weight: bold; margin-bottom: 2px; }
        .date-day { font-size: 1.1rem; font-family: 'Noto Serif TC', serif; font-weight: bold; }
        .date-dot { width: 4px; height: 4px; background: var(--accent-gold); border-radius: 50%; margin-top: 4px; opacity: 0; }
        .date-item.active .date-dot { opacity: 1; }

        /* --- SMART REMINDER BAR --- */
        #smart-reminder {
            background: #FFECB3; color: #E65100; padding: 10px 20px; text-align: center; font-size: 0.9rem;
            font-weight: 700; position: sticky; top: 75px; z-index: 90;
            display: none; /* Only show when triggered by JS */
        }
        
        /* --- ITINERARY HERO (New) --- */
        .day-hero-banner {
            width: 100%; height: 200px; position: relative; overflow: hidden; margin-bottom: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        .hero-img { width: 100%; height: 100%; object-fit: cover; filter: brightness(0.9); }
        .hero-content {
            position: absolute; bottom: 0; left: 0; right: 0; padding: 20px;
            background: linear-gradient(transparent, rgba(0,0,0,0.6));
            color: white;
        }
        .hero-day-tag { font-size: 0.8rem; font-weight: 700; margin-bottom: 5px; background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px; display: inline-block; }
        .hero-title { font-size: 1.6rem; font-family: 'Noto Serif TC', serif; font-weight: 900; margin: 0; text-shadow: 1px 1px 3px #000; }

        /* --- WEATHER & ADVICE --- */
        .weather-advice-box {
            background: #E8F5E9; border-radius: 12px; padding: 15px; margin: 0 20px 20px;
            border-left: 5px solid #4CAF50; box-shadow: var(--card-shadow);
        }
        .wa-title { font-weight: bold; color: #388E3C; font-size: 0.9rem; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
        .wa-text { font-size: 0.85rem; line-height: 1.5; color: #333; }

        /* --- TIMELINE LAYOUT --- */
        .timeline-container { padding: 0 20px; }
        .timeline-row { display: flex; gap: 15px; margin-bottom: 25px; position: relative; }
        .t-time-col { 
            width: 50px; flex-shrink: 0; text-align: right; font-family: 'Noto Serif TC', serif; font-size: 1.1rem; font-weight: bold; color: var(--text-main);
            padding-top: 5px;
        }
        .t-line-col { width: 2px; background: var(--line-color); position: relative; margin-top: 10px; margin-bottom: -35px; }
        .t-dot { width: 10px; height: 10px; background: var(--bg-color); border: 2px solid var(--text-main); border-radius: 50%; position: absolute; left: 50%; top: 0; transform: translateX(-50%); z-index: 2; }
        .timeline-row:last-child .t-line-col { display: none; } 
        .t-content-col { flex: 1; min-width: 0; }
        
        .trip-card {
            background: white; border-radius: 16px; padding: 20px; box-shadow: var(--card-shadow);
            transition: transform 0.2s; cursor: pointer; position: relative; overflow: hidden;
        }
        .trip-card.special { border: 1px solid var(--accent-gold); background: linear-gradient(to bottom right, #FFFCF5, #FFF); }
        .special-tag { color: var(--accent-gold); font-size: 0.65rem; font-weight: bold; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
        .c-tag { font-size: 0.7rem; font-weight: bold; color: #999; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 8px; border: 1px solid #EEE; display: inline-block; padding: 2px 8px; border-radius: 4px; }
        .c-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 5px; line-height: 1.3; font-family: 'Noto Serif TC', serif; }

        /* --- EXPENSES TAB --- */
        .exp-header { background: var(--text-main); color: white; padding: 20px; margin: 20px; border-radius: 16px; text-align: center; }
        .exp-totals { display: flex; justify-content: space-around; padding: 10px 0; margin: 0 20px 20px; background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .exp-stat { text-align: center; }
        .exp-label { font-size: 0.75rem; color: #999; }
        .exp-val { font-size: 1rem; font-weight: bold; color: var(--accent-gold); }
        .e-btn { width: 100%; padding: 15px; background: var(--accent-gold); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 1rem; }

        /* --- TOOLS TAB (Hand-drawn) --- */
        .tool-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px; }
        .tool-card { 
            background: #FFFCF5; border: 2px dashed #D4B69C; padding: 20px 10px; border-radius: 16px; text-align: center; 
            box-shadow: 2px 2px 0px 0px #D4B69C; transition: all 0.1s; cursor: pointer;
        }
        .tool-card:active { transform: translate(1px, 1px); box-shadow: 1px 1px 0px 0px #D4B69C; }
        .tool-icon { font-size: 2rem; display: block; margin-bottom: 8px; color: var(--text-main); }
        
        /* --- INFO TAB --- */
        .info-section { padding: 20px; }
        .info-box { background: white; padding: 20px; border-radius: 16px; margin-bottom: 15px; box-shadow: var(--card-shadow); }
        .info-title { font-family: 'Noto Serif TC', serif; font-size: 1.2rem; font-weight: 600; margin-bottom: 10px; }
        .info-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #EEE; }
        .info-contact { color: var(--accent-red); font-weight: bold; }

        /* --- NAV BAR --- */
        .nav-bar {
            position: fixed; bottom: 0; width: 100%; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px);
            border-top: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-around;
            padding: 10px 0 calc(10px + var(--safe-area-bottom)); z-index: 1000;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #CCC; font-size: 0.7rem; gap: 4px; transition: 0.3s; width: 25%; }
        .nav-item.active { color: var(--text-main); }
        .nav-icon { font-size: 1.4rem; }

    </style>
</head>
<body>

    <div class="header">
        <div class="app-title">é’æ£®å‡½é¤¨å†¬æ—…</div>
        <div class="app-meta">
            <span><i class="fa-solid fa-hourglass-half"></i> <span id="days-left">--</span> Days</span>
            <span><i class="fa-solid fa-yen-sign"></i> <span id="rate-disp">0.22</span></span>
        </div>
        
        <div class="date-nav" id="date-nav"></div>
    </div>

    <div id="smart-reminder" style="display:none;"></div>

    <div class="weather-strip" id="weather-strip">
        <div class="w-item"><div class="w-time">Now</div><div class="w-icon"><i class="fa-solid fa-cloud"></i></div><div class="w-temp">-2Â°</div></div>
        <div class="w-item"><div class="w-time">13:00</div><div class="w-icon"><i class="fa-regular fa-snowflake"></i></div><div class="w-temp">-3Â°</div></div>
        <div class="w-item"><div class="w-time">14:00</div><div class="w-icon"><i class="fa-regular fa-snowflake"></i></div><div class="w-temp">-3Â°</div></div>
        <div class="w-item"><div class="w-time">15:00</div><div class="w-icon"><i class="fa-solid fa-wind"></i></div><div class="w-temp">-4Â°</div></div>
        <div class="w-item"><div class="w-time">16:00</div><div class="w-icon"><i class="fa-solid fa-moon"></i></div><div class="w-temp">-5Â°</div></div>
    </div>

    <div id="tab-trip" class="tab-content active" onpointerdown="handleTouchStart(event)" onpointermove="handleTouchMove(event)" onpointerup="handleTouchEnd(event)">
        <div id="timeline-container" class="timeline-container"></div>
    </div>

    <div id="tab-money" class="tab-content" style="display:none;">
        <div class="exp-header">
            <div style="font-size:0.8rem; opacity:0.7;">1 JPY â‰ˆ <span id="rate-big">0.22</span> TWD</div>
            <div style="font-size:2rem; font-weight:bold; font-family:'Noto Serif TC';" id="total-spend">Â¥0</div>
            <div style="font-size:0.8rem; margin-top:5px;">ç¸½æ”¯å‡º (TWD ä¼°ç®—: $<span id="total-twd">0</span>)</div>
        </div>
        
        <div class="exp-totals">
            <div class="exp-stat"><div class="exp-label">YK ä»£å¢Š</div><div class="exp-val" id="total-yk">$0</div></div>
            <div class="exp-stat"><div class="exp-label">YY ä»£å¢Š</div><div class="exp-val" id="total-yy">$0</div></div>
            <div class="exp-stat"><div class="exp-label">YS ä»£å¢Š</div><div class="exp-val" id="total-ys">$0</div></div>
        </div>

        <div class="exp-input-group">
            <input type="text" id="ex-item" class="e-input" placeholder="é …ç›® (å¦‚: æ™šé¤)">
            <input type="number" id="ex-price" class="e-input" placeholder="é‡‘é¡ (JPY)">
            <select id="ex-who" class="e-input">
                <option value="YK">YK</option><option value="YY">YY</option><option value="YS">YS</option>
            </select>
            <button class="e-btn" onclick="addExpense()">+ è¨˜ä¸€ç­†</button>
        </div>
        <div id="expense-list" style="padding:20px;"></div>
    </div>

    <div id="tab-tools" class="tab-content" style="display:none;">
        <div style="padding:20px;">
            <input type="text" id="trans-input" class="e-input" placeholder="è¼¸å…¥ä¸­æ–‡...">
            <button class="e-btn" style="background:#444;" onclick="translateCustom()">ç¿»è­¯æˆæ—¥æ–‡</button>
        </div>
        <div class="tool-grid">
            <div class="tool-card" onclick="openTransModal('æˆ‘ä¸åƒè‚‰é¡ (æµ·é®®å¯ä»¥)', 'è±šè‚‰ã¯é£Ÿã¹ã‚‰ã‚Œã¾ã›ã‚“ï¼ˆé­šä»‹é¡ã¯å¤§ä¸ˆå¤«ã§ã™ï¼‰')">
                <span class="tool-icon"><i class="fa-solid fa-fish"></i></span><span class="tool-text">é£²é£Ÿç¦å¿Œ</span>
            </div>
            <div class="tool-card" onclick="openTransModal('éº»ç…©çµå¸³', 'ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™')">
                <span class="tool-icon"><i class="fa-solid fa-file-invoice-dollar"></i></span><span class="tool-text">çµå¸³</span>
            </div>
            <div class="tool-card" onclick="openTransModal('è«‹å•å»æ‰€åœ¨å“ªè£¡', 'ã™ã¿ã¾ã›ã‚“ã€ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹ï¼Ÿ')">
                <span class="tool-icon"><i class="fa-solid fa-restroom"></i></span><span class="tool-text">æ‰¾å»æ‰€</span>
            </div>
            <div class="tool-card" onclick="openTransModal('æˆ‘è¦é€™å€‹ (æŒ‡è‘—)', 'ã“ã‚Œã‚’ãŠé¡˜ã„ã—ã¾ã™')">
                <span class="tool-icon"><i class="fa-solid fa-hand-point-right"></i></span><span class="tool-text">æˆ‘è¦é€™å€‹</span>
            </div>
            <div class="tool-card" onclick="openTransModal('èƒ½å¹«æˆ‘å€‘æ‹ç…§å—ï¼Ÿ', 'å†™çœŸã‚’æ’®ã£ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹ï¼Ÿ', 'medium')">
                <span class="tool-icon"><i class="fa-solid fa-camera"></i></span><span class="tool-text">å¹«å¿™æ‹ç…§</span>
            </div>
            <div class="tool-card" onclick="openTransModal('è«‹å•æœ‰è©¦åƒå—ï¼Ÿ', 'è©¦é£Ÿã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ', 'medium')">
                <span class="tool-icon"><i class="fa-solid fa-utensils"></i></span><span class="tool-text">æœ‰è©¦åƒå—ï¼Ÿ</span>
            </div>
        </div>
    </div>
    
    <div id="tab-info" class="tab-content" style="display:none;">
        <div class="info-section">
            <h2 class="serif" style="margin-top:0;">ç·Šæ€¥è¯çµ¡èˆ‡é‡è¦è³‡è¨Š</h2>

            <div class="info-box">
                <div class="info-title">ç·Šæ€¥æ±‚åŠ© (æ—¥æœ¬åœ‹å…§)</div>
                <div class="info-item"><div class="info-label">è­¦å¯Ÿ (Police)</div><div class="info-contact"><a href="tel:110">110</a></div></div>
                <div class="info-item"><div class="info-label">æ•‘è­·è»Š/ç«è­¦</div><div class="info-contact"><a href="tel:119">119</a></div></div>
                <div class="info-item"><div class="info-label">å¤–åœ‹äººå°ˆç”¨ç†±ç·š (JNTO)</div><div class="info-contact"><a href="tel:05038162787">050-3816-2787</a></div></div>
            </div>

            <div class="info-box">
                <div class="info-title">å°ç£é§æ—¥è¾¦äº‹è™• (æ”¯æ´é’æ£®)</div>
                <div class="info-item"><div class="info-label">é§æ©«æ¿±è¾¦äº‹è™• (è² è²¬æ±åŒ—)</div><div class="info-contact"><a href="tel:+81456417730">+81-45-641-7730</a></div></div>
                <div class="info-item"><div class="info-label">ç·Šæ€¥è¯çµ¡æ‰‹æ©Ÿ (24H)</div><div class="info-contact"><a href="tel:+819039634771">+81-90-3963-4771</a></div></div>
                <div style="font-size:0.8rem; color:#888; margin-top:10px;">(é ˜å‹™è½„å€åŒ…å«é’æ£®ç¸£)</div>
            </div>
            
            <div class="info-box">
                <div class="info-title">å…¥å¢ƒèˆ‡é˜²ç–« (Visit Japan)</div>
                <button class="e-btn" style="background:#5D5D5D;" onclick="window.open('https://www.vjw.digital.go.jp/main/#/', '_blank')">
                    Visit Japan Web ç™»éŒ„
                </button>
            </div>
        </div>
    </div>


    <div class="modal-overlay" id="modal-overlay" onclick="closeModal()"></div>
    <div class="detail-modal" id="detail-modal">
        <div class="m-header">
            <span class="m-tag" id="m-tag">SIGHTSEEING</span>
            <div class="m-close" onclick="closeModal()">âœ•</div>
        </div>
        
        <div class="m-title-block">
            <div class="m-title" id="m-title">Title</div>
            <div class="m-address" id="m-address"><i class="fa-solid fa-location-dot"></i> <span id="m-addr-text">Address</span></div>
        </div>

        <img src="" id="m-hero" class="m-hero">

        <div class="ps-section">
            <div class="sec-title">æŒ‡å·®ã—ä¼šè©± (POINT & SPEAK)</div>
            <div id="ps-container"></div>
            <div id="gps-container" style="display:none;">
                <div class="gps-box">
                    <div class="gps-icon"><i class="fa-solid fa-car"></i></div>
                    <div><div class="gps-label">CAR GPS PHONE</div><div class="gps-num" id="gps-num">000-000-000</div></div>
                </div>
            </div>
            <div id="res-container" style="display:none; background:#F9F9F9; padding:15px; border-radius:12px; margin-bottom:20px;">
                <div style="font-size:0.7rem; color:#999; font-weight:bold; letter-spacing:1px; margin-bottom:5px;">RESERVATION NO.</div>
                <div style="font-size:1.2rem; font-weight:bold; font-family:monospace;" id="res-num">--</div>
            </div>

            <button class="map-btn" onclick="openMap()"><i class="fa-solid fa-map-location-dot"></i> é–‹å•Ÿ Google Maps å°èˆª</button>

            <div class="sec-title">é—œæ–¼æ­¤è™• (ABOUT)</div>
            <div class="info-text" id="m-desc">Description</div>
        </div>
    </div>

    <div style="position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:80%; background:white; padding:30px; border-radius:20px; text-align:center; z-index:2200; box-shadow:0 10px 40px rgba(0,0,0,0.3); display:none;" id="trans-pop">
        <div style="font-size:1rem; color:#888; margin-bottom:10px;" id="tp-cn">CN</div>
        <div style="font-size:2rem; font-weight:900; margin-bottom:20px; font-family:'Noto Serif TC';" id="tp-jp">JP</div>
        <button onclick="closeAllModals()" class="e-btn">é—œé–‰</button>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchTab('trip', this)">
            <i class="fa-solid fa-map nav-icon"></i><span>è¡Œç¨‹</span>
        </div>
        <div class="nav-item" onclick="switchTab('money', this)">
            <i class="fa-solid fa-wallet nav-icon"></i><span>è¨˜å¸³</span>
        </div>
        <div class="nav-item" onclick="switchTab('tools', this)">
            <i class="fa-solid fa-comments nav-icon"></i><span>ç¿»è­¯</span>
        </div>
        <div class="nav-item" onclick="switchTab('info', this)">
            <i class="fa-solid fa-circle-exclamation nav-icon"></i><span>è³‡è¨Š</span>
        </div>
    </div>

    <script>
        // --- DATA STRUCTURE ---
        const tripData = [
            {
                day: 1, date: "2/2", week: "MON",
                heroTitle: "å‡½é¤¨ï¼šè³¼ç‰©èˆ‡ç™¾è¬å¤œæ™¯",
                heroImg: "image-day1-nightview.jpg",
                events: [
                    { 
                        time: "11:10", title: "æŠµé”å‡½é¤¨æ©Ÿå ´ (HKD)", tag: "TRANSPORT", 
                        desc: "ã€å…¥å¢ƒæ‰‹çºŒã€‘é ˜å–è¡Œæã€‚æ³¨æ„æ™‚é–“ï¼Œæº–å‚™æ­ä¹˜æ©Ÿå ´å·´å£«ã€‚",
                        addr: "Hakodate Airport",
                        img: "image-day1-airport.jpg",
                    },
                    { 
                        time: "12:30", title: "æ©Ÿå ´å·´å£«è‡³ JR å‡½é¤¨ç«™", tag: "TRANSPORT", 
                        desc: "è»Šç¨‹ç´„ 20-30 åˆ†é˜ï¼Œåœ¨å‡½é¤¨ç«™ä¸‹è»Šã€‚",
                        addr: "JR Hakodate Station"
                    },
                    { 
                        time: "13:35", title: "UNIQLO & Bic Camera æ¡è³¼", tag: "SHOPPING",
                        desc: "ã€è³¼ç‰©ä»»å‹™ã€‘å¾é£¯åº—/è»Šç«™æ­è¨ˆç¨‹è»Šä¾†å›ï¼Œæ•ˆç‡æœ€é«˜ã€‚æ¡è³¼é˜²å¯’ç”¨å“èˆ‡é›»å™¨ã€‚",
                        addr: "Kojima x Bic Camera å‡½é¤¨åº—",
                        img: "image-day1-shopping.jpg",
                        pointSpeak: [{ cn: "è«‹è¼‰æˆ‘åˆ° Bic Camera", jp: "ãƒ“ãƒƒã‚¯ã‚«ãƒ¡ãƒ©ã¾ã§ãŠé¡˜ã„ã—ã¾ã™" }]
                    },
                    { 
                        time: "15:45", title: "é‡‘æ£®ç´…ç£šå€‰åº«", tag: "SIGHTSEEING",
                        desc: "é£¯åº—å¸è²¨å¾Œï¼Œæ­å¸‚é›»å‰å¾€ã€‚éŠè¦½ç£å€ä¸¦å°‹æ‰¾æ™šé¤åœ°é»ã€‚",
                        addr: "é‡‘æ£®èµ¤ãƒ¬ãƒ³ã‚¬å€‰åº«",
                        img: "image-day1-warehouse.jpg"
                    },
                    { 
                        time: "17:00", title: "å‡½é¤¨å±±çºœè»Š (å¤œæ™¯)", tag: "SIGHTSEEING",
                        desc: "æ¬£è³ç™¾è¬å¤œæ™¯ã€‚è§€æ™¯å°æˆ¶å¤–é¢¨å¤§ï¼Œå‹™å¿…æˆ´æ‰‹å¥—ã€å¸½å­ã€‚",
                        addr: "Hakodate Ropeway",
                        img: "image-day1-nightview.jpg",
                        gps: "0138-23-3105",
                        pointSpeak: [{ cn: "å…©å¼µå¤§äººç¥¨", jp: "å¤§äºº2æšãŠé¡˜ã„ã—ã¾ã™" }]
                    },
                    { 
                        time: "ä½å®¿", title: "JR Inn Hakodate", tag: "HOTEL",
                        desc: "é£¯åº— Check-inã€‚ä½æ–¼å‡½é¤¨ç«™æ—ã€‚",
                        addr: "JR Inn Hakodate",
                        bookingId: "HAKO-JRI-0202",
                        img: "image-day1-hotel.jpg"
                    }
                ]
            },
            {
                day: 2, date: "2/3", week: "TUE",
                heroTitle: "é’æ£®ç§»å‹•æ—¥ï¼šç¾è¡“é¤¨èˆ‡é„‰åœŸæ–™ç†",
                heroImg: "image-day2-museum.jpg",
                events: [
                    { 
                        time: "08:00", title: "å‡½é¤¨æœå¸‚ æ—©é¤", tag: "FOOD",
                        desc: "æ­¥è¡Œå‰å¾€ã€‚æµ·é®®ä¸¼ã€é‡£çƒè³Šã€‚æ³¨æ„åœ°é¢æ¿•æ»‘ã€‚",
                        addr: "Hakodate Morning Market",
                        img: "image-day2-market.jpg",
                        gps: "0138-22-7981",
                        pointSpeak: [{ cn: "æˆ‘è¦æµ·è†½", jp: "ã‚¦ãƒ‹ã‚’ãã ã•ã„" }]
                    },
                    { 
                        time: "10:00", title: "JR æ–°å¹¹ç·šç§»å‹•è‡³é’æ£®", tag: "TRANSPORT",
                        desc: "å¾å‡½é¤¨ç«™å‡ºç™¼ã€‚æ­ä¹˜æ–°å¹¹ç·šç­‰ï¼Œé è¨ˆ 13:45 æŠµé”é’æ£®ç«™ã€‚",
                        addr: "JR Hakodate Station -> JR Aomori Station",
                        img: "image-day2-shinkansen.jpg"
                    },
                    { 
                        time: "14:15", title: "Dormy Inn æ”¾è¡Œæ", tag: "HOTEL",
                        desc: "æŠµé”é’æ£®ç«™å¾Œï¼Œæ­è¨ˆç¨‹è»Šè‡³ Dormy Inn æ”¾ä¸‹è¡Œæã€‚",
                        addr: "Dormy Inn Aomori",
                        bookingId: "AOM-DOR-0203"
                    },
                    { 
                        time: "14:40", title: "é’æ£®ç¸£ç«‹ç¾è¡“é¤¨", tag: "SIGHTSEEING",
                        desc: "æ­è¨ˆç¨‹è»Šå‰å¾€ã€‚åƒè§€å¥ˆè‰¯ç¾æ™ºçš„ã€Œé’æ£®çŠ¬ã€ã€‚ç¾è¡“é¤¨ 17:00 é–‰é¤¨ (L.E. 16:30)ã€‚",
                        addr: "Aomori Museum of Art",
                        img: "image-day2-museum.jpg",
                        gps: "017-783-3000"
                    },
                    { 
                        time: "18:00", title: "æ™šé¤ï¼šé’æ£®é„‰åœŸæ–™ç†", tag: "FOOD",
                        desc: "æ­¥è¡Œå°‹æ‰¾æ™šé¤ï¼Œæ¨è–¦é’æ£®æ‰‡è²å°å±‹ã€‚",
                        addr: "Aomori Station Area",
                        pointSpeak: [{ cn: "é’æ£®æ‰‡è²å°å±‹", jp: "ã‚ãŠã‚‚ã‚Šå¸†ç«‹å°å±‹" }]
                    },
                    { 
                        time: "19:30", title: "å”å‰è¨¶å¾· (è³¼ç‰©å‚™æ¡ˆ)", tag: "SHOPPING",
                        desc: "æ­¥è¡Œå‰å¾€ï¼Œé›¢é£¯åº—è¿‘ã€‚å¯é€›è»Šç«™ LOVINA/THREE ç™¾è²¨ã€‚",
                        addr: "ãƒ‰ãƒ³ãƒ»ã‚­ãƒ›ãƒ¼ãƒ† é’æ£®æ–°ç”ºåº—"
                    }
                ]
            },
            {
                day: 3, date: "2/4", week: "WED",
                heroTitle: "æ´¥è¼•éµé“ï¼šæš–çˆåˆ—è»Šèˆ‡å¼˜å‰è˜‹æœæ´¾",
                heroImg: "image-day3-stove-train.jpg",
                events: [
                    { 
                        time: "09:00", title: "é’æ£®ç«™å–è»Š (4WD)", tag: "TRANSPORT",
                        desc: "ã€ç§Ÿè»Šé–‹å§‹ã€‘å› Dormy Inn è¼‰äººèˆ‡è¡Œæã€‚",
                        addr: "JRé§…ãƒ¬ãƒ³ã‚¿ã‚«ãƒ¼é’æ£®å–¶æ¥­æ‰€",
                        bookingId: "CAR-AOM-0204",
                        gps: "017-722-3930",
                        pointSpeak: [{ cn: "æˆ‘æœ‰é ç´„", jp: "äºˆç´„ã—ã¦ã„ã¾ã™" }]
                    },
                    { 
                        time: "10:15", title: "3COINS+plus æ¡è²·", tag: "SHOPPING",
                        desc: "æŠµé” ELM è³¼ç‰©ä¸­å¿ƒã€‚é™æ™‚ 35 åˆ†é˜æ¡è²·ã€‚",
                        addr: "ELM Shopping Center",
                        img: "image-day3-shopping.jpg"
                    },
                    { 
                        time: "12:30", title: "æ´¥è¼•éµé“ ã€Œæš–çˆåˆ—è»Šã€", tag: "SPECIAL EXPERIENCE",
                        isSpecial: true,
                        desc: "ã€ä»»å‹™ 2ã€‘çƒ¤é­·é­šé«”é©—ã€‚å‹™å¿…ç¢ºèªæ™‚åˆ»è¡¨ã€‚å–è»Šå¾Œé–‹å¾€æ´¥è¼•äº”æ‰€å·åŸç«™ã€‚",
                        addr: "æ´¥è»½äº”æ‰€å·åŸé§…",
                        img: "image-day3-stove-train.jpg",
                        pointSpeak: [{ cn: "è«‹çµ¦æˆ‘çƒ¤é­·é­š", jp: "ã‚¹ãƒ«ãƒ¡ï¼ˆSurumeï¼‰ã‚’ãã ã•ã„" }]
                    },
                    { 
                        time: "15:30", title: "è—¤ç”°ç´€å¿µåº­åœ’", tag: "SIGHTSEEING",
                        desc: "ã€ä»»å‹™ 3ï¼šCRITICALã€‘å¤§æ­£æµªæ¼«å–«èŒ¶å®¤ï¼Œ16:00 å‰å®Œæˆé»é¤ã€‚æ¬£è³å¼˜å‰åŸç™½å¤©é›ªæ™¯ã€‚",
                        addr: "è—¤ç”°è¨˜å¿µåº­åœ’",
                        img: "image-day3-garden.jpg",
                        gps: "0172-37-5525",
                        pointSpeak: [{ cn: "æˆ‘è¦è˜‹æœæ´¾", jp: "ã‚¢ãƒƒãƒ—ãƒ«ãƒ‘ã‚¤ã‚’ãã ã•ã„" }]
                    },
                    { 
                        time: "17:30", title: "é–‹è»Šè¿”å› Dormy Inn", tag: "TRANSPORT",
                        desc: "ã€å¤œé–“æ…¢è¡Œã€‘é ç•™ 1.5 å°æ™‚é›ªåœ°è»Šç¨‹ã€‚",
                        addr: "å¼˜å‰ -> Dormy Inn Aomori"
                    }
                ]
            },
            {
                day: 4, date: "2/5", week: "THU",
                heroTitle: "å…«ç”²ç”°æ¨¹å†°èˆ‡æ»‘é›ªåˆé«”é©—",
                heroImg: "image-day4-snowmonster.jpg",
                events: [
                    { 
                        time: "09:00", title: "å¤å·å¸‚å ´ ã®ã£ã‘ä¸¼ æ—©é¤", tag: "FOOD",
                        desc: "è‡ªé§•ï¼Œå¿«å»å¿«å›ã€‚",
                        addr: "é’æ£®é­šèœã‚»ãƒ³ã‚¿ãƒ¼",
                        img: "image-day4-food.jpg",
                        pointSpeak: [{ cn: "æˆ‘è¦å…©å€‹ã®ã£ã‘ä¸¼", jp: "ã®ã£ã‘ä¸¼ã‚’äºŒã¤ãŠé¡˜ã„ã—ã¾ã™" }]
                    },
                    { 
                        time: "10:40", title: "å…«ç”²ç”°æ¨¹å†°çºœè»Š", tag: "SIGHTSEEING",
                        desc: "æ­çºœè»Šçœ‹ Snow Monstersã€‚å±±é ‚æ¥µå†·ï¼Œå‹™å¿…å…¨å‰¯æ­¦è£ã€‚",
                        addr: "å…«ç”²ç”°ãƒ­ãƒ¼ãƒ—ã‚¦ã‚§ãƒ¼",
                        img: "image-day4-snowmonster.jpg",
                        gps: "017-738-0343"
                    },
                    { 
                        time: "13:30", title: "é¦¬é–€æº«æ³‰æ»‘é›ªå ´", tag: "ACTIVITY",
                        desc: "ã€æ»‘é›ªé«”é©—ã€‘åœ¨ 8 åº¦ç·©å¡ç·´ç¿’æ»‘é›ª (ç§Ÿå€Ÿè£å‚™)ã€‚è»Šç¨‹ç´„ 1 å°æ™‚ã€‚",
                        addr: "é¦¬é–€æº«æ³‰æ»‘é›ªå ´",
                        img: "image-day4-ski.jpg",
                        gps: "0176-74-2131"
                    },
                    { 
                        time: "16:15", title: "æŠµé” æ˜Ÿé‡é’æ£®å±‹ Check-in", tag: "HOTEL",
                        desc: "æ­¸é‚„è£å‚™ï¼Œé–‹è»Šå‰å¾€ã€‚",
                        addr: "æ˜Ÿé‡ãƒªã‚¾ãƒ¼ãƒˆ é’æ£®å±‹",
                        bookingId: "HOSHINO-AOM-0205",
                        gps: "0176-51-1111",
                        pointSpeak: [{ cn: "æˆ‘è¦è¾¦ç†å…¥ä½", jp: "ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚’ãŠé¡˜ã„ã—ã¾ã™" }]
                    },
                    { 
                        time: "17:30", title: "æ™šé¤ï¼šNore Sore é£Ÿå ‚", tag: "FOOD",
                        desc: "å·²é ç´„è‡ªåŠ©é¤ã€‚",
                        addr: "æ˜Ÿé‡ãƒªã‚¾ãƒ¼ãƒˆ é’æ£®å±‹"
                    }
                ]
            },
            {
                day: 5, date: "2/6", week: "FRI",
                heroTitle: "æ˜Ÿé‡å…¨æ—¥ï¼šæš–çˆé¦¬è»Šèˆ‡ç¥­å…¸å±‹",
                heroImg: "image-day5-matsuri.jpg",
                events: [
                    { 
                        time: "10:00", title: "æš–çˆé¦¬è»Š (Stove Carriage)", tag: "SPECIAL EXPERIENCE",
                        isSpecial: true,
                        desc: "ã€é£¯åº—æ´»å‹•ã€‘éœ€é ç´„ï¼Œç’°ç¹é£¯åº—åœ’å€ã€‚",
                        addr: "æ˜Ÿé‡ãƒªã‚¾ãƒ¼ãƒˆ é’æ£®å±‹",
                        img: "image-day5-horse-carriage.jpg"
                    },
                    { 
                        time: "12:00", title: "åˆé¤ï¼šå…«é£Ÿä¸­å¿ƒ", tag: "FOOD",
                        desc: "é£¯åº—å…§æˆ–é–‹è»Šå‰å¾€å…«é£Ÿä¸­å¿ƒ (35 åˆ†é˜)ã€‚ä¸ƒè¼ªç‚­çƒ¤æµ·é®®ã€‚",
                        addr: "å…«é£Ÿã‚»ãƒ³ã‚¿ãƒ¼",
                        img: "image-day5-hasshoku.jpg",
                        gps: "0178-28-9311",
                        pointSpeak: [{ cn: "æˆ‘è¦ç§Ÿç‚­ç«çˆ", jp: "ä¸ƒè¼ªï¼ˆShichirinï¼‰ã‚’ä½¿ã„ãŸã„ã§ã™" }]
                    },
                    { 
                        time: "20:00", title: "é™¸å¥§ç¥­å…¸å±‹ è¡¨æ¼”", tag: "ACTIVITY",
                        desc: "ã€æ–‡åŒ–é«”é©—ã€‘è§€è³é’æ£®å››å¤§ç¥­å…¸è¡¨æ¼”ï¼Œéœ€é ç´„ã€‚æ­¥è¡Œå‰å¾€ã€‚",
                        addr: "æ˜Ÿé‡ãƒªã‚¾ãƒ¼ãƒˆ é’æ£®å±‹",
                        img: "image-day5-matsuri.jpg"
                    }
                ]
            },
            {
                day: 6, date: "2/7", week: "SAT",
                heroTitle: "æœ€çµ‚éµå¾‹ï¼šå®‰å…¨è¿”ç¨‹",
                heroImg: "image-day6-airport.jpg",
                events: [
                    { 
                        time: "10:00", title: "é–‹è»Šé›¢é–‹é£¯åº— (æœ€çµ‚éµå¾‹)", tag: "TRANSPORT",
                        desc: "ã€æœ€çµ‚éµå¾‹ã€‘æº–æ™‚é›¢é–‹ï¼Œç¢ºä¿å……è¶³çš„é›ªåœ°ç·©è¡æ™‚é–“ (3.5 å°æ™‚)ã€‚ä¸Šè·¯è«‹é–‹å¤§ç‡ˆï¼Œæ¥µè‡´æ…¢é€Ÿå®‰å…¨é§•é§›ã€‚",
                        addr: "æ˜Ÿé‡ãƒªã‚¾ãƒ¼ãƒˆ é’æ£®å±‹ -> é’æ£®ç©ºæ¸¯",
                        gps: "0176-51-1111"
                    },
                    { 
                        time: "13:00", title: "é’æ£®æ©Ÿå ´ (AOJ) é‚„è»Š", tag: "TRANSPORT",
                        desc: "æŠµé”é’æ£®æ©Ÿå ´ã€‚é‚„è»Šæ‰‹çºŒï¼Œè¨˜å¾—åŠ æ»¿æ²¹ã€‚",
                        addr: "Aomori Airport"
                    },
                    { 
                        time: "14:00", title: "å…ç¨…åº—/åœŸç”¢åº—æ¡è²·", tag: "SHOPPING",
                        desc: "ã€æœ€çµ‚ä»»å‹™ã€‘æ¡è²·ä¼´æ‰‹ç¦®ã€‚é ç•™å……è£•æ™‚é–“ã€‚",
                        addr: "é’æ£®ç©ºæ¸¯"
                    },
                    { 
                        time: "15:30", title: "æ­æ©Ÿè¿”å° (BR 121)", tag: "TRANSPORT",
                        desc: "ç™»æ©Ÿæ‰‹çºŒã€‚",
                        addr: "é’æ£®ç©ºæ¸¯"
                    }
                ]
            }
        ];

        // --- GLOBAL VARS ---
        let currentDayIdx = 0;
        let expenses = JSON.parse(localStorage.getItem('trip_v7_expenses')) || [];
        let rate = 0.22;
        let initialX = null;

        // --- INIT ---
        window.onload = function() {
            renderDateNav();
            renderTimeline();
            updateMeta();
            renderExpenses();
            // Fetch Rate
            fetch('https://api.exchangerate-api.com/v4/latest/JPY')
                .then(r=>r.json()).then(d=> { 
                    if(d.rates.TWD) { 
                        rate = d.rates.TWD; 
                        document.getElementById('rate-disp').innerText = rate.toFixed(2);
                        document.getElementById('rate-big').innerText = rate.toFixed(3);
                        renderExpenses();
                    }
                });
        };

        function updateMeta() {
            const startDate = new Date("2026-02-02"); 
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            const days = Math.max(0, Math.ceil((startDate - today) / (1000 * 60 * 60 * 24)));
            document.getElementById('days-left').innerText = days;
            
            // Initial Smart Reminder Call
            checkSmartReminder();
            setInterval(checkSmartReminder, 60000); // Check every minute
        }

        // --- RENDER & SWIPE FUNCTIONS ---
        function renderDateNav() {
            const nav = document.getElementById('date-nav');
            nav.innerHTML = tripData.map((d, i) => `
                <div class="date-item ${i === currentDayIdx ? 'active' : ''}" onclick="switchDay(${i})">
                    <div class="date-weekday">${d.week}</div>
                    <div class="date-day">${d.date.split('/')[1]}</div>
                    <div class="date-dot"></div>
                </div>
            `).join('');
            
            const activeItem = document.querySelector('.date-item.active');
            if (activeItem) {
                const nav = document.getElementById('date-nav');
                nav.scrollLeft = activeItem.offsetLeft - nav.offsetWidth / 2 + activeItem.offsetWidth / 2;
            }
        }

        function switchDay(i) {
            if (i >= 0 && i < tripData.length) {
                currentDayIdx = i;
                renderDateNav();
                renderTimeline();
                window.scrollTo(0,0); // Scroll to top on day switch
            }
        }

        function renderTimeline() {
            const container = document.getElementById('timeline-container');
            const day = tripData[currentDayIdx];
            
            // 1. Hero Banner
            const heroBanner = `
                <div class="day-hero-banner">
                    <img src="${window.location.href.replace(/[^/]*$/, '') + day.heroImg}" class="hero-img">
                    <div class="hero-content">
                        <div class="hero-day-tag">DAY ${day.day} (${day.date.split('/')[1]})</div>
                        <div class="hero-title serif">${day.heroTitle}</div>
                    </div>
                </div>
            `;
            
            // 2. Weather/Advice Box
            const weatherAdvice = `
                <div class="weather-advice-box">
                    <div class="wa-title"><i class="fa-solid fa-bell"></i> ä»Šæ—¥è¡Œç¨‹æé†’èˆ‡å»ºè­°</div>
                    <div class="wa-text">${day.events[0].time} - ${day.events[day.events.length-1].time}</div>
                </div>
            `;
            
            // 3. Timeline Events
            const timelineEvents = day.events.map(ev => {
                const dataStr = encodeURIComponent(JSON.stringify(ev));
                const specialClass = ev.isSpecial ? 'special' : '';
                const thumbHtml = ev.img ? `<img src="${window.location.href.replace(/[^/]*$/, '') + ev.img}" class="c-thumb show">` : '';
                const specialTag = ev.isSpecial ? `<div class="special-tag"><i class="fa-solid fa-crown"></i> SPECIAL EXPERIENCE</div>` : '';
                
                return `
                <div class="timeline-row">
                    <div class="t-time-col">${ev.time}</div>
                    <div class="t-line-col"><div class="t-dot"></div></div>
                    <div class="t-content-col">
                        <div class="trip-card ${specialClass}" onclick="openDetail('${dataStr}')">
                            ${specialTag}
                            <span class="c-tag">${ev.tag}</span>
                            <div class="c-title">${ev.title}</div>
                            <div class="c-desc">${ev.desc}</div>
                            ${thumbHtml}
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            container.innerHTML = heroBanner + weatherAdvice + timelineEvents;
        }

        // Swipe Functionality
        function handleTouchStart(evt) {
            initialX = evt.clientX || evt.touches[0].clientX;
        }

        function handleTouchMove(evt) {
            if (initialX === null) return;
            const currentX = evt.clientX || evt.touches[0].clientX;
            const diffX = initialX - currentX;

            // Optional: Visually show drag effect if desired
            // container.style.transform = `translateX(${-diffX}px)`; 
        }

        function handleTouchEnd(evt) {
            if (initialX === null) return;
            const currentX = evt.clientX || evt.changedTouches[0].clientX;
            const diffX = initialX - currentX;
            initialX = null; // Reset initial position

            const threshold = 50; // Minimum swipe distance in pixels

            if (Math.abs(diffX) > threshold) {
                if (diffX > 0) { // Swipe Left (Next Day)
                    switchDay(currentDayIdx + 1);
                } else { // Swipe Right (Previous Day)
                    switchDay(currentDayIdx - 1);
                }
            }
        }


        // --- SMART REMINDER LOGIC (New) ---
        function checkSmartReminder() {
            const reminderBar = document.getElementById('smart-reminder');
            const now = new Date();
            const currentDayDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tripStartDate = new Date("2026-02-02");
            const diffDays = Math.ceil((currentDayDate.getTime() - tripStartDate.getTime()) / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0 || diffDays >= tripData.length) {
                reminderBar.style.display = 'none';
                return; // Not on a trip day yet
            }

            const currentDayEvents = tripData[diffDays].events;
            let reminderMessage = null;

            for (let i = 0; i < currentDayEvents.length; i++) {
                const event = currentDayEvents[i];
                const [eventHour, eventMinute] = event.time.split(':').map(Number);
                
                // Convert event time to today's date + event time
                const eventTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), eventHour, eventMinute);
                const timeDiffMinutes = (eventTime.getTime() - now.getTime()) / (1000 * 60);

                // --- Logic Triggers ---
                if (timeDiffMinutes >= -15 && timeDiffMinutes <= 20) { // Within 15 min late to 20 min early
                    
                    if (timeDiffMinutes > 0 && timeDiffMinutes <= 15) {
                        reminderMessage = `ğŸ”” ${event.title} é‚„æœ‰ ${Math.round(timeDiffMinutes)} åˆ†é˜é–‹å§‹ï¼è«‹æº–å‚™å‰å¾€ã€‚`;
                        break;
                    } else if (timeDiffMinutes >= -15 && timeDiffMinutes <= 0) {
                        reminderMessage = `ğŸš¨ ${event.title} æ‡‰è©²åœ¨ ${Math.abs(Math.round(timeDiffMinutes))} åˆ†é˜å‰é–‹å§‹äº†ï¼è«‹åŠ å¿«è…³æ­¥ã€‚`;
                        break;
                    }
                }
            }
            
            if (reminderMessage) {
                reminderBar.innerText = reminderMessage;
                reminderBar.style.display = 'block';
            } else {
                reminderBar.style.display = 'none';
            }
        }


        // --- DETAIL MODAL LOGIC (retained) ---
        let currentEv = null;
        function openDetail(dataStr) {
            currentEv = JSON.parse(decodeURIComponent(dataStr));
            
            document.getElementById('m-tag').innerText = currentEv.tag;
            document.getElementById('m-title').innerText = currentEv.title;
            document.getElementById('m-desc').innerText = currentEv.desc;
            document.getElementById('m-addr-text').innerText = currentEv.addr;
            document.getElementById('m-hero').src = currentEv.img ? window.location.href.replace(/[^/]*$/, '') + currentEv.img : ''; 

            const psContainer = document.getElementById('ps-container');
            if(currentEv.pointSpeak && currentEv.pointSpeak.length > 0) {
                psContainer.innerHTML = currentEv.pointSpeak.map(ps => `<div class="ps-card"><div class="ps-cn">${ps.cn}</div><div class="ps-jp">${ps.jp}</div></div>`).join('');
            } else {
                psContainer.innerHTML = '<div style="color:#CCC; text-align:center; padding:10px;">ç„¡ç‰¹å®šæŒ‡å·®æœƒè©±</div>';
            }

            const gpsBox = document.getElementById('gps-container');
            if(currentEv.gps) {
                gpsBox.style.display = 'block';
                document.getElementById('gps-num').innerText = currentEv.gps;
            } else {
                gpsBox.style.display = 'none';
            }

            const resBox = document.getElementById('res-container');
            if(currentEv.bookingId) {
                resBox.style.display = 'block';
                document.getElementById('res-num').innerText = currentEv.bookingId;
            } else {
                resBox.style.display = 'none';
            }

            document.getElementById('modal-overlay').classList.add('open');
            document.getElementById('detail-modal').classList.add('open');
        }

        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('open');
            document.getElementById('detail-modal').classList.remove('open');
            document.getElementById('trans-pop').style.display = 'none';
        }
        
        function closeAllModals() {
            document.querySelectorAll('.open').forEach(el => el.classList.remove('open'));
            document.getElementById('trans-pop').style.display = 'none';
            document.getElementById('modal-overlay').classList.remove('open');
        }

        function openMap() {
            if(currentEv && currentEv.addr) {
                window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(currentEv.addr)}`);
            }
        }
        
        // --- EXPENSES (retained) ---
        function addExpense() {
            const item = document.getElementById('ex-item').value;
            const price = document.getElementById('ex-price').value;
            const who = document.getElementById('ex-who').value;
            if(item && price && parseInt(price) > 0) {
                expenses.unshift({ item, price: parseInt(price), who, date: new Date() });
                renderExpenses();
                document.getElementById('ex-item').value = '';
                document.getElementById('ex-price').value = '';
            }
        }

        function renderExpenses() {
            const list = document.getElementById('expense-list');
            let totalJPY = 0;
            let totalTWD = 0;
            let totals = { YK: 0, YY: 0, YS: 0 };
            
            list.innerHTML = expenses.map((ex,i) => {
                const twdValue = ex.price * rate;
                totalJPY += ex.price;
                totalTWD += twdValue;
                totals[ex.who] += twdValue;

                return `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:15px 0; border-bottom:1px solid #EEE;">
                    <div><span style="font-weight:bold;">${ex.item}</span> <span style="font-size:0.8rem; color:#999;">(${ex.who})</span></div>
                    <div style="text-align:right;">
                        <div style="font-weight:bold;">Â¥${ex.price.toLocaleString()}</div>
                        <div style="font-size:0.7rem; color:#AAA;">â‰ˆ $${twdValue.toFixed(0)} TWD</div>
                    </div>
                    <div style="color:red; margin-left:10px; cursor:pointer;" onclick="delEx(${i})">âœ•</div>
                </div>`;
            }).join('');
            
            document.getElementById('total-spend').innerText = 'Â¥' + totalJPY.toLocaleString();
            document.getElementById('total-twd').innerText = totalTWD.toFixed(0);
            
            document.getElementById('total-yk').innerText = '$' + totals.YK.toFixed(0);
            document.getElementById('total-yy').innerText = '$' + totals.YY.toFixed(0);
            document.getElementById('total-ys').innerText = '$' + totals.YS.toFixed(0);

            localStorage.setItem('trip_v7_expenses', JSON.stringify(expenses));
        }
        function delEx(i) { if(confirm('ç¢ºå®šåˆªé™¤é€™ç­†æ”¯å‡ºå—ï¼Ÿ')){expenses.splice(i,1); renderExpenses();}}

        // --- NAV ---
        function switchTab(t, el) {
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.getElementById('tab-'+t).style.display = 'block';
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
        }
    </script>
</body>
</html>
