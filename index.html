<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>L'VOYAGE | é’æ£®å‡½é¤¨ è˜‹æœä¹‹æ—…</title>
    <meta name="theme-color" content="#1a1a1a">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Noto+Serif+TC:wght@300;500;700&family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Palette: Luxury Winter */
            --bg-body: #F9F8F4; /* æº«æš–çš„ç´™ç™½è‰² */
            --bg-card: #FFFFFF;
            --text-primary: #1A1A1A;
            --text-secondary: #666666;
            --accent-main: #1C2541; /* åˆå¤œè— */
            --accent-gold: #B49B67; /* é¦™æª³é‡‘ */
            --line-light: #E0E0E0;
            --shadow-soft: 0 10px 40px -10px rgba(0,0,0,0.08);
            --font-serif: 'Cormorant Garamond', 'Noto Serif TC', serif;
            --font-sans: 'Noto Sans TC', sans-serif;
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: var(--font-sans);
            padding-bottom: calc(80px + var(--safe-bottom));
            overflow-x: hidden;
        }

        /* --- TYPOGRAPHY --- */
        h1, h2, h3, .serif { font-family: var(--font-serif); }
        .italic { font-style: italic; }

        /* --- COVER SCREEN (INTRO) --- */
        #intro-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: var(--accent-main); color: white;
            z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            transition: transform 1s cubic-bezier(0.77, 0, 0.175, 1);
        }
        .intro-text { 
            text-align: center; 
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* INTRO COUNTDOWN STYLES */
        .intro-countdown-block {
            margin-bottom: 40px;
            opacity: 0;
            animation: fadeIn 1.5s ease forwards 0.3s;
        }
        
        .countdown-value {
            font-size: 8rem; /* Extremely large */
            line-height: 1;
            font-weight: 300;
            color: var(--accent-gold);
            font-family: var(--font-serif);
        }
        
        .countdown-label-intro {
            font-size: 1rem;
            letter-spacing: 3px;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            text-align: center;
            margin-top: 10px;
        }

        .intro-title-block {
            text-align: center; 
            opacity: 0; 
            animation: fadeIn 1.5s ease forwards 0.8s;
        }

        .intro-title { font-size: 3rem; letter-spacing: 5px; margin-bottom: 10px; font-weight: 300; }
        .intro-sub { font-size: 0.9rem; letter-spacing: 3px; color: var(--accent-gold); text-transform: uppercase; }
        .intro-btn {
            margin-top: 40px; padding: 15px 40px; border: 1px solid rgba(255,255,255,0.3);
            background: transparent; color: white; font-family: var(--font-serif);
            font-size: 1.1rem; letter-spacing: 2px; cursor: pointer; transition: 0.3s;
            opacity: 0; animation: fadeIn 1.5s ease forwards 1s;
        }
        .intro-btn:hover { background: white; color: var(--accent-main); }

        @keyframes fadeIn { to { opacity: 1; } }

        /* --- HEADER --- */
        .elegant-header {
            padding: 40px 20px 20px;
            background: linear-gradient(to bottom, #F9F8F4 80%, rgba(249,248,244,0));
            position: sticky; top: 0; z-index: 100;
        }
        .top-meta { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; }
        .brand { font-family: var(--font-serif); font-size: 1.5rem; font-weight: 700; letter-spacing: 1px; color: var(--accent-main); }
        
        /* NEW HEADER STATUS BAR */
        #countdown-status { text-align: right; }
        .status-value { font-family: var(--font-serif); font-size: 3rem; line-height: 1; color: var(--accent-gold); }
        .status-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; color: var(--text-secondary); margin-top: 5px; }

        .weather-reminder-strip {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-card); padding: 10px 15px; border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin: 0 0 10px 0;
            border-left: 3px solid var(--accent-gold);
        }
        .weather-icon { font-size: 1.2rem; color: #42A5F5; margin-right: 10px; }
        .reminder-text { font-size: 0.85rem; color: var(--text-primary); font-weight: 500; }

        /* --- DATE NAV (Minimalist) --- */
        .date-scroller { display: flex; gap: 20px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .date-scroller::-webkit-scrollbar { display: none; }
        .d-item { 
            min-width: 60px; text-align: center; opacity: 0.4; transition: 0.4s; cursor: pointer; 
            display: flex; flex-direction: column; align-items: center;
        }
        .d-item.active { opacity: 1; transform: scale(1.1); }
        .d-week { font-size: 0.7rem; letter-spacing: 1px; margin-bottom: 5px; text-transform: uppercase; }
        .d-num { font-family: var(--font-serif); font-size: 1.5rem; position: relative; }
        .d-item.active .d-num::after {
            content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%);
            width: 4px; height: 4px; background: var(--accent-gold); border-radius: 50%;
        }

        /* --- MAIN CONTENT --- */
        .container { padding: 0 20px; max-width: 600px; margin: 0 auto; }
        
        .hero-card {
            position: relative; height: 300px; border-radius: 2px; overflow: hidden; margin-bottom: 40px;
            box-shadow: var(--shadow-soft);
        }
        .hero-img { width: 100%; height: 100%; object-fit: cover; transition: transform 10s ease; }
        .hero-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; padding: 30px;
            background: linear-gradient(to top, rgba(28,37,65,0.9), transparent); color: white;
        }
        .hero-day { font-size: 0.8rem; letter-spacing: 3px; color: var(--accent-gold); margin-bottom: 10px; text-transform: uppercase; }
        .hero-title { font-size: 1.8rem; margin: 0; line-height: 1.3; font-weight: 500; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }

        /* Timeline Redesign */
        .timeline-block { position: relative; padding-left: 20px; border-left: 1px solid var(--line-light); margin-left: 10px; }
        
        .event-node { margin-bottom: 40px; position: relative; opacity: 0; transform: translateY(20px); transition: 0.6s ease; }
        .event-node.visible { opacity: 1; transform: translateY(0); }
        
        .time-dot { 
            position: absolute; left: -25px; top: 0; width: 9px; height: 9px; 
            background: var(--bg-body); border: 2px solid var(--accent-main); border-radius: 50%; 
        }
        
        .time-label { 
            font-family: var(--font-serif); font-size: 1.1rem; color: var(--accent-gold); font-style: italic; margin-bottom: 5px; 
        }

        .event-card {
            background: var(--bg-card); padding: 25px; border-radius: 4px; /* Shaper corners for elegance */
            box-shadow: var(--shadow-soft); cursor: pointer; transition: 0.3s;
            border-bottom: 2px solid transparent;
        }
        .event-card:hover { transform: translateY(-3px); border-bottom: 2px solid var(--accent-gold); }
        .event-card.special-event { border: 1px solid var(--accent-gold); background: linear-gradient(to bottom right, #FFFCF5, #FFFFFF); }
        
        .event-tag { 
            font-size: 0.6rem; text-transform: uppercase; letter-spacing: 2px; color: var(--text-secondary); margin-bottom: 10px; display: block; 
        }
        .event-title { font-family: var(--font-serif); font-size: 1.3rem; margin-bottom: 8px; color: var(--accent-main); font-weight: 700; }
        .event-desc { font-size: 0.95rem; color: var(--text-secondary); line-height: 1.6; font-weight: 300; }
        .event-img { width: 100%; height: 150px; object-fit: cover; margin-top: 15px; filter: grayscale(10%); transition: 0.3s; }
        .event-card:hover .event-img { filter: grayscale(0%); }

        /* Image Config Button */
        .image-config-btn {
            position: absolute; top: 10px; right: 10px;
            background: rgba(255, 255, 255, 0.9);
            color: var(--accent-main); border: none;
            width: 30px; height: 30px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; z-index: 5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: 0.2s;
        }
        .image-config-btn:hover { background: var(--accent-gold); color: white; }
        .hero-config-btn { top: auto; bottom: 20px; right: 20px; width: 40px; height: 40px; background: rgba(255, 255, 255, 0.1); color: white; border: 1px solid rgba(255, 255, 255, 0.5); }


        /* --- FLOATING NAV --- */
        .glass-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px;
            background: rgba(28, 37, 65, 0.9); backdrop-filter: blur(10px);
            border-radius: 50px; padding: 15px 30px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 1000;
        }
        .nav-btn { color: rgba(255,255,255,0.5); font-size: 1.2rem; cursor: pointer; transition: 0.3s; position: relative; }
        .nav-btn.active { color: var(--accent-gold); transform: translateY(-2px); }
        .nav-btn.active::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            width: 4px; height: 4px; background: var(--accent-gold); border-radius: 50%;
        }

        /* --- MODAL (General) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 1900;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }

        /* Detail Modal */
        .modal-full {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); z-index: 2000;
            opacity: 0; pointer-events: none; transition: 0.4s ease;
            overflow-y: auto;
        }
        .modal-full.active { opacity: 1; pointer-events: auto; }
        
        .modal-hero { height: 40vh; width: 100%; object-fit: cover; }
        .modal-content { padding: 40px 20px; transform: translateY(50px); transition: 0.5s ease; opacity: 0; max-width: 600px; margin: 0 auto; }
        .modal-full.active .modal-content { transform: translateY(0); opacity: 1; transition-delay: 0.2s; }
        
        .close-fab {
            position: fixed; top: 20px; right: 20px; width: 40px; height: 40px;
            background: white; border-radius: 50%; display: flex; justify-content: center; align-items: center;
            box-shadow: var(--shadow-soft); cursor: pointer; z-index: 2100; color: var(--accent-main);
        }

        /* Image Config Modal */
        #img-config-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            width: 90%; max-width: 400px; background: var(--bg-card);
            padding: 30px; border-radius: 12px; z-index: 2000;
            opacity: 0; visibility: hidden; transition: 0.3s;
            box-shadow: 0 15px 50px rgba(0,0,0,0.3);
        }
        #img-config-modal.active { opacity: 1; visibility: visible; transform: translate(-50%, -50%) scale(1); }

        /* --- UTILS --- */
        .hidden { display: none; }
        .money-display { text-align: center; padding: 40px 0; background: white; margin-bottom: 20px; }
        .input-elegant { 
            width: 100%; border: none; border-bottom: 1px solid var(--line-light); 
            padding: 15px 0; font-family: var(--font-serif); font-size: 1.1rem; 
            background: transparent; margin-bottom: 20px; outline: none; border-radius: 0;
        }
        .btn-elegant {
            width: 100%; padding: 15px; background: var(--accent-main); color: white;
            border: none; letter-spacing: 2px; font-family: var(--font-serif); cursor: pointer;
        }

    </style>
</head>
<body>

    <!-- Intro Screen -->
    <div id="intro-screen">
        <div class="intro-text">
            
            <!-- COUNTDOWN ADDED HERE -->
            <div class="intro-countdown-block">
                <div class="countdown-value" id="intro-days-left">--</div>
                <div class="countdown-label-intro">è·é›¢å‡ºç™¼ (DAYS LEFT)</div>
            </div>
            <!-- END COUNTDOWN -->
            
            <div class="intro-title-block">
                <div class="intro-sub">AOMORI & HAKODATE</div>
                <div class="intro-title serif">é’æ£®å‡½é¤¨<br>è˜‹æœä¹‹æ—…</div>
            </div>
            
            <button class="intro-btn" onclick="enterApp()">é–‹å•Ÿæ—…ç¨‹</button>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app-container">
        
        <div class="elegant-header">
            <div class="top-meta">
                <div class="brand">é’æ£®å‡½é¤¨ è˜‹æœä¹‹æ—…</div>
                <div id="countdown-status">
                    <!-- Status generated by JS: Countdown or Day X -->
                </div>
            </div>
            
            <!-- NEW: Weather and Reminder Strip -->
            <div id="weather-and-reminder" class="weather-reminder-strip">
                <div style="display: flex; align-items: center;">
                    <i class="fa-solid fa-cloud-showers-heavy weather-icon" style="color: #42A5F5;"></i>
                    <span class="reminder-text" id="weather-status">é’æ£®: -2Â°C | ä»Šæ—¥é™é›ª</span>
                </div>
                <div>
                    <span class="reminder-text" id="smart-reminder-text">ç„¡ç•¶å‰æé†’</span>
                </div>
            </div>
            
            <div class="date-scroller" id="date-nav">
                <!-- Dates generated by JS -->
            </div>
        </div>

        <!-- TRIP TAB (Now supports horizontal swiping) -->
        <div id="view-trip" class="view-section" 
             onpointerdown="handleTouchStart(event)" 
             onpointermove="handleTouchMove(event)" 
             onpointerup="handleTouchEnd(event)">
            <div class="container" id="timeline-container">
                <!-- Timeline content generated by JS -->
            </div>
        </div>

        <!-- WALLET TAB -->
        <div id="view-wallet" class="view-section hidden">
            <div class="container">
                <div class="hero-card" style="height: 200px;">
                    <img src="https://placehold.co/800x400/1C2541/FFFFFF?text=Travel+Wallet" class="hero-img">
                    <div class="hero-overlay">
                        <div class="hero-title serif">æ—…è²»ç®¡å®¶</div>
                    </div>
                </div>
                
                <div class="money-display">
                    <!-- Exchange Rate Display -->
                    <div style="font-size: 0.9rem; color: var(--text-secondary); letter-spacing: 1px;">
                        1 JPY â‰ˆ <span id="current-rate">0.22</span> TWD
                    </div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary); letter-spacing: 1px;">ç¸½æ”¯å‡º TOTAL EXPENDITURE</div>
                    <div class="serif" style="font-size: 2.5rem; color: var(--accent-main); margin: 10px 0;" id="total-jpy">Â¥0</div>
                    <div style="color: var(--accent-gold);">â‰ˆ TWD <span id="total-twd">0</span></div>
                </div>

                <div style="background: white; padding: 30px; box-shadow: var(--shadow-soft);">
                    <input type="text" id="ex-item" class="input-elegant" placeholder="é …ç›®åç¨± (ä¾‹å¦‚ï¼šæ™šé¤)">
                    <input type="number" id="ex-price" class="input-elegant" placeholder="é‡‘é¡ (æ—¥å¹£)">
                    <button class="btn-elegant" onclick="addExpense()">è¨˜éŒ„æ”¯å‡º</button>
                </div>

                <div id="expense-list" style="margin-top: 40px;"></div>
            </div>
        </div>

        <!-- TOOLS TAB -->
        <div id="view-tools" class="view-section hidden">
            <div class="container">
                <div style="padding: 40px 0;">
                    <h2 class="serif" style="text-align: center; color: var(--accent-main); margin-bottom: 40px;">æ—…è¡Œéš¨èº«ç§˜æ›¸</h2>
                    
                    <div class="event-card" style="margin-bottom: 20px;" onclick="openDetail(JSON.stringify({title:'å¯¦ç”¨ç¿»è­¯', desc:'é¤å»³é»é¤èˆ‡æ—¥å¸¸å°è©±', pointSpeak:[{cn:'éº»ç…©çµå¸³', jp:'ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™'}, {cn:'æˆ‘ä¸åƒè±¬è‚‰', jp:'è±šè‚‰ã¯é£Ÿã¹ã‚‰ã‚Œã¾ã›ã‚“'}]}))">
                        <div class="event-title"><i class="fa-solid fa-language"></i> å¿«é€Ÿç¿»è­¯</div>
                        <div class="event-desc">é»é¤ã€å•è·¯å¿…å‚™çš„æ—¥æ–‡çŸ­å¥ã€‚</div>
                    </div>
                    
                    <div class="event-card" style="margin-bottom: 20px;">
                        <div class="event-title"><i class="fa-solid fa-cloud-sun"></i> å¤©æ°£é å ±</div>
                        <div class="event-desc">æŸ¥è©¢é’æ£®ã€å‡½é¤¨çš„é™é›ªæ©Ÿç‡èˆ‡æ°£æº«ã€‚</div>
                    </div>

                    <div class="event-card">
                        <div class="event-title"><i class="fa-solid fa-suitcase-medical"></i> ç·Šæ€¥è¯çµ¡</div>
                        <div class="event-desc">è­¦å¯Ÿ: 110, æ•‘è­·è»Š: 119, é§æ—¥è¾¦äº‹è™•è³‡è¨Šã€‚</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Floating Navigation -->
    <div class="glass-nav">
        <div class="nav-btn active" onclick="switchView('trip', this)"><i class="fa-solid fa-map"></i></div>
        <div class="nav-btn" onclick="switchView('wallet', this)"><i class="fa-solid fa-wallet"></i></div>
        <div class="nav-btn" onclick="switchView('tools', this)"><i class="fa-solid fa-compass"></i></div>
    </div>

    <!-- Full Screen Detail Modal -->
    <div class="modal-full" id="detail-modal">
        <div class="close-fab" onclick="closeModal()"><i class="fa-solid fa-times"></i></div>
        <img src="" id="m-img" class="modal-hero" onerror="this.onerror=null; this.src='https://placehold.co/800x600/F4F4F4/CCCCCC?text=No+Image+Set';">
        <div class="modal-content">
            <div id="m-tag" style="color: var(--accent-gold); letter-spacing: 2px; font-size: 0.8rem; font-weight: bold; margin-bottom: 10px;">TAG</div>
            <h1 id="m-title" class="serif" style="font-size: 2.2rem; margin: 0 0 20px 0; line-height: 1.2;">Title</h1>
            <p id="m-desc" style="font-size: 1.1rem; line-height: 1.8; color: #444;">Description</p>
            
            <div id="m-ps-area" style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #EEE;">
                <h3 class="serif">æŒ‡å·®æœƒè©± Communication</h3>
                <div id="m-ps-content"></div>
            </div>
        </div>
    </div>

    <!-- Image Configuration Modal -->
    <div id="img-config-modal">
        <h3 class="serif" style="color:var(--accent-main); margin-top:0;">åœ–ç‰‡é€£çµè¨­å®š</h3>
        <p id="img-config-title" style="font-size: 0.9rem; color: #666;"></p>
        <input type="text" id="img-config-url" class="input-elegant" placeholder="è²¼ä¸Šåœ–ç‰‡ URL é€£çµ">
        <div style="font-size: 0.75rem; color: var(--accent-gold); margin-bottom: 20px;">æ³¨æ„ï¼šåœ–ç‰‡å¿…é ˆæ˜¯ HTTPS é€£çµæ‰èƒ½æ­£å¸¸é¡¯ç¤ºã€‚</div>
        <button class="btn-elegant" id="img-config-save">å„²å­˜åœ–ç‰‡</button>
        <button class="btn-elegant" style="background: #999; margin-top: 10px;" onclick="closeModal()">å–æ¶ˆ</button>
    </div>

    <!-- General Overlay -->
    <div class="modal-overlay" id="modal-overlay" onclick="closeModal()"></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE SETUP ---
        let db, auth, userId = null;
        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        let userImages = {}; // Cache for user-defined image URLs
        let isAuthReady = false;
        let exchangeRate = 0.22; // Default rate

        async function setupFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in with custom token or anonymously
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("Firebase Auth Ready. User ID:", userId);
                        loadUserImages();
                    } else {
                        isAuthReady = true; // Still ready, but anonymous/unauthorized
                        console.warn("Firebase: User logged out or anonymous sign-in.");
                        renderTrip(); // Render static content as fallback
                    }
                });

                // Fetch exchange rate on setup
                fetchExchangeRate();

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                isAuthReady = true;
                renderTrip(); // Fallback: render static content if Firebase fails
            }
        }
        
        async function fetchExchangeRate() {
            try {
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                const data = await response.json();
                if (data.rates && data.rates.TWD) {
                    exchangeRate = data.rates.TWD;
                    console.log("Fetched exchange rate:", exchangeRate);
                    // Update wallet view if it's currently visible
                    if (document.getElementById('view-wallet').classList.contains('hidden') === false) {
                        renderExpenses();
                    }
                }
            } catch (error) {
                console.warn("Failed to fetch exchange rate, using default 0.22.", error);
            }
        }


        function getImageConfigDocRef() {
            // Path: artifacts/{appId}/users/{userId}/settings/image_config (6 segments)
            if (!db || !userId) return null;
            return doc(db, 'artifacts', appId, 'users', userId, 'settings', 'image_config');
        }

        function loadUserImages() {
            const userDocRef = getImageConfigDocRef();
            
            if (!userDocRef) {
                renderTrip(); // Only render static if DB/user not ready
                return; 
            }

            // Listen for changes to the user's image configuration document
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    userImages = docSnap.data().images || {};
                    console.log("Loaded user images from Firestore. Keys:", Object.keys(userImages).length);
                } else {
                    userImages = {};
                    console.log("No custom image configuration found.");
                }
                // Re-render the trip to apply new images
                renderTrip();
            }, (error) => {
                console.error("Error listening to user images:", error);
                renderTrip();
            });
        }

        async function saveUserImage(dayIndex, eventIndex, newUrl, isHero) {
            const userDocRef = getImageConfigDocRef();
            
            if (!userDocRef) {
                 console.error("ç„¡æ³•å„²å­˜ï¼šFirebase å°šæœªåˆå§‹åŒ–æˆ–ä½¿ç”¨è€…æœªç™»å…¥ã€‚");
                 return;
            }
            
            // Key format: 'dayX-eventY' or 'dayX-hero'
            const key = isHero ? `day${dayIndex}-hero` : `day${dayIndex}-event${eventIndex}`;
            
            // Update local cache and prepare Firestore data
            const updatedImages = { ...userImages, [key]: newUrl };
            
            try {
                // Set the document with the updated map of images
                await setDoc(userDocRef, { images: updatedImages }, { merge: true });
                console.log("Image saved successfully for key:", key);
                userImages = updatedImages; // Update local cache immediately
                renderTrip(); // Re-render to show immediate update
                closeModal();
            } catch (error) {
                console.error("Error saving image to Firestore:", error);
            }
        }
        
        // --- DATA ---
        const tripData = [
            {
                day: 1, date: "02.02", week: "MON",
                heroTitle: "å‡½é¤¨ï¼šåŒ—åœ‹çš„èµ·é»èˆ‡ç™¾è¬å¤œæ™¯",
                heroImg: "https://placehold.co/800x600/1C2541/FFFFFF?text=Set+Day+1+Hero+Image",
                events: [
                    { time: "11:10", title: "æŠµé”å‡½é¤¨æ©Ÿå ´ (HKD)", tag: "Transport", desc: "å…¥å¢ƒæ‰‹çºŒï¼Œé ˜å–è¡Œæã€‚æ­ä¹˜ 12:30 æ©Ÿå ´å·´å£«å‰å¾€ JR å‡½é¤¨ç«™ã€‚", img: "https://placehold.co/600x300/B49B67/FFFFFF?text=Airport" },
                    { time: "13:35", title: "è³¼ç‰©ä»»å‹™ï¼šUNIQLO & Bic Camera", tag: "Shopping", desc: "æ­è¨ˆç¨‹è»Šå‰å¾€ã€‚æ¡è³¼é˜²å¯’ç”¨å“èˆ‡é›»å™¨ã€‚å‹™å¿…å¿«ç‹ æº–ï¼Œ15:15 å‰çµæŸã€‚", pointSpeak: [{cn:"è«‹è¼‰æˆ‘åˆ° Bic Camera", jp:"ãƒ“ãƒƒã‚¯ã‚«ãƒ¡ãƒ©ã¾ã§ãŠé¡˜ã„ã—ã¾ã™"}], img: "https://placehold.co/600x300/42A5F5/FFFFFF?text=Shopping" },
                    { time: "15:45", title: "é‡‘æ£®ç´…ç£šå€‰åº«", tag: "Sightseeing", desc: "é£¯åº—å¸è²¨å¾Œï¼Œæ­å¸‚é›»å‰å¾€ã€‚æ„Ÿå—æ¸¯é‚Šé¢¨æƒ…ã€‚", img: "https://placehold.co/600x300/964B00/FFFFFF?text=Red+Brick+Warehouse" },
                    { time: "17:00", title: "å‡½é¤¨å±±ç™¾è¬å¤œæ™¯", tag: "Experience", desc: "æ­ä¹˜çºœè»Šä¸Šå±±ã€‚å±±ä¸Šé¢¨å¤§è«‹æ³¨æ„ä¿æš–ã€‚æ™šé¤æ–¼ç£å€äº«ç”¨ã€‚", img: "https://placehold.co/600x300/1C2541/FFFFFF?text=Mt+Hakodate" },
                    { time: "å®¿", title: "JR Inn Hakodate", tag: "Hotel", desc: "å‡½é¤¨ç«™æ—ï¼Œäº¤é€šä¾¿åˆ©ã€‚", img: "https://placehold.co/600x200/555/FFF?text=JR+Inn" }
                ]
            },
            {
                day: 2, date: "02.03", week: "TUE",
                heroTitle: "ç©¿è¶Šæ™‚å…‰åˆ—è»Šï¼šå¾æµ·æ¸¯åˆ°è—è¡“ä¹‹éƒ½",
                heroImg: "https://placehold.co/800x600/DDDDDD/333333?text=Set+Day+2+Hero+Image",
                events: [
                    { time: "08:00", title: "å‡½é¤¨æœå¸‚æ—©é¤", tag: "Cuisine", desc: "äº«ç”¨æ–°é®®æµ·é®®ä¸¼ã€‚æ­¥è¡Œå‰å¾€ã€‚", pointSpeak: [{cn:"æˆ‘è¦æµ·è†½", jp:"ã‚¦ãƒ‹ã‚’ãã ã•ã„"}], img: "https://placehold.co/600x300/FFA500/FFF?text=Morning+Market" },
                    { time: "10:00", title: "ç§»å‹•è‡³é’æ£®", tag: "Transport", desc: "æ­ä¹˜æ–°å¹¹ç·šç©¿è¶Šæ´¥è¼•æµ·å³½ã€‚13:45 æŠµé”é’æ£®ç«™ã€‚", img: "https://placehold.co/600x300/333/FFF?text=Shinkansen" },
                    { time: "14:40", title: "é’æ£®ç¸£ç«‹ç¾è¡“é¤¨", tag: "Art", desc: "æ­è¨ˆç¨‹è»Šå‰å¾€ã€‚æ¢è¨ªå¥ˆè‰¯ç¾æ™ºè‘—åçš„ã€Œé’æ£®çŠ¬ã€ã€‚", img: "https://placehold.co/600x300/FFF/333?text=Aomori+Dog" },
                    { time: "18:00", title: "æ™šé¤ï¼šé’æ£®é„‰åœŸæ–™ç†", tag: "Cuisine", desc: "æ­¥è¡Œå‰å¾€å¸‚å€é¤å»³äº«ç”¨åœ¨åœ°ç¾é£Ÿã€‚", pointSpeak: [{cn:"æœ‰æ¨è–¦çš„é„‰åœŸæ–™ç†å—ï¼Ÿ", jp:"ãŠã™ã™ã‚ã®éƒ·åœŸæ–™ç†ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ"}] },
                    { time: "19:30", title: "å”å‰è¨¶å¾·è³¼ç‰©", tag: "Shopping", desc: "é›¢é£¯åº—è¿‘ï¼Œä½œç‚ºæ™šé¤å¾Œçš„æ•£æ­¥è¡Œç¨‹ã€‚", img: "https://placehold.co/600x200/FFD700/333?text=Don+Quijote" },
                    { time: "å®¿", title: "Dormy Inn Aomori", tag: "Hotel", desc: "äº«å—æº«æ³‰èˆ‡å¤œé³´æ‹‰éºµã€‚", img: "https://placehold.co/600x200/555/FFF?text=Dormy+Inn" }
                ]
            },
            {
                day: 3, date: "02.04", week: "WED",
                heroTitle: "æ´¥è¼•éµé“èˆ‡å¼˜å‰é›ªæ™¯",
                heroImg: "https://placehold.co/800x600/B49B67/FFFFFF?text=Set+Day+3+Hero+Image",
                events: [
                    { time: "09:00", title: "ç§Ÿè»Šé–‹å§‹", tag: "Transport", desc: "é’æ£®ç«™å–è»Šï¼Œè‡ªé§•é–‹å§‹ã€‚å›é£¯åº—è¼‰è¡Œæã€‚", img: "https://placehold.co/600x300/555/FFF?text=Car+Rental" },
                    { time: "10:15", title: "ELM è³¼ç‰©ä¸­å¿ƒ", tag: "Shopping", desc: "ã€ä»»å‹™ 1ã€‘3COINS+plus æ¡è²·ï¼Œé™æ™‚ 35 åˆ†é˜ã€‚", pointSpeak: [{cn:"è«‹å• 3COINS åœ¨å“ªè£¡ï¼Ÿ", jp:"3COINSã¯ã©ã“ã§ã™ã‹ï¼Ÿ"}] },
                    { time: "12:30", title: "æš–çˆåˆ—è»Š (æ´¥è¼•éµé“)", tag: "Journey", desc: "ã€ä»»å‹™ 2ã€‘é«”é©—å¾©å¤æš–çˆåˆ—è»Šï¼Œè»Šä¸Šäº«ç”¨çƒ¤é­·é­šã€‚", img: "https://placehold.co/600x300/A52A2A/FFF?text=Stove+Train+Experience" },
                    { time: "15:30", title: "è—¤ç”°ç´€å¿µåº­åœ’", tag: "Cuisine", desc: "ã€ä»»å‹™ 3ï¼šCRITICALã€‘å¤§æ­£æµªæ¼«å–«èŒ¶å®¤ï¼Œ16:00 å‰å¿…é ˆå®Œæˆé»é¤ã€‚å“åšè˜‹æœæ´¾ã€‚", pointSpeak: [{cn:"æˆ‘è¦è˜‹æœæ´¾", jp:"ã‚¢ãƒƒãƒ—ãƒ«ãƒ‘ã‚¤ã‚’ãã ã•ã„"}], img: "https://placehold.co/600x300/FFA500/FFF?text=Apple+Pie" },
                    { time: "16:30", title: "å¼˜å‰åŸç™½å¤©é›ªæ™¯", tag: "Sightseeing", desc: "åœ¨é›ªä¸­æ¼«æ­¥å¼˜å‰å…¬åœ’ã€‚", img: "https://placehold.co/600x300/FFF/333?text=Hirosaki+Castle" },
                    { time: "17:30", title: "è¿”å›é’æ£®å¸‚", tag: "Transport", desc: "å¤œé–“é›ªåœ°æ…¢è¡Œï¼Œæ³¨æ„å®‰å…¨ã€‚è¿”å› Dormy Innã€‚", img: "https://placehold.co/600x200/1C2541/FFF?text=Night+Drive" }
                ]
            },
            {
                day: 4, date: "02.05", week: "THU",
                heroTitle: "ç™»ä¸Šé›²æµ·é‚Šç•Œï¼šèˆ‡ã€Œé›ªæ¨¹ç²¾éˆã€çš„ç™½è‰²ç›Ÿç´„",
                heroImg: "https://placehold.co/800x600/E0E0E0/333333?text=Set+Day+4+Hero+Image",
                events: [
                    { time: "09:00", title: "å¤å·å¸‚å ´ æ—©é¤", tag: "Cuisine", desc: "å¿«å»å¿«å›ï¼Œäº«ç”¨è‡ªé¸ã®ã£ã‘ä¸¼ã€‚", pointSpeak: [{cn:"é£¯å°‘ä¸€é»", jp:"ã”é£¯å°‘ãªã‚ã§"}], img: "https://placehold.co/600x300/FFA500/FFF?text=Nokkedon" },
                    { time: "11:00", title: "å…«ç”²ç”°æ¨¹å†°è§€å…‰", tag: "Nature", desc: "æ­ä¹˜çºœè»Šæ¬£è³ Snow Monstersã€‚å±±é ‚æ¥µå†·ï¼Œå…¨å‰¯æ­¦è£ã€‚", img: "https://placehold.co/600x300/FFF/888?text=Hakkoda+Ropeway" },
                    { time: "14:00", title: "å‰å¾€æ˜Ÿé‡é’æ£®å±‹", tag: "Transport", desc: "ç´„ 2 å°æ™‚è»Šç¨‹ã€‚äº«å—æ²¿é€”é›ªæ™¯ã€‚", img: "https://placehold.co/600x200/555/FFF?text=Drive+to+Hoshino" },
                    { time: "16:00", title: "é’æ£®å±‹ Check-in", tag: "Hotel", desc: "æŠµé”æ˜Ÿé‡åº¦å‡æ‘ã€‚è¾¦ç†å…¥ä½ã€‚", img: "https://placehold.co/600x300/C5A059/FFF?text=Aomoriya" },
                    { time: "17:30", title: "æ™šé¤ï¼šNore Sore é£Ÿå ‚", tag: "Cuisine", desc: "å·²é ç´„è‡ªåŠ©é¤ã€‚ç›¡æƒ…äº«ç”¨é’æ£®ç¾é£Ÿã€‚", img: "https://placehold.co/600x200/FFA500/FFF?text=Buffet+Dinner" }
                ]
            },
            {
                day: 5, date: "02.06", week: "FRI",
                heroTitle: "å†¬æ—¥æˆ€æ­Œï¼šé¦¬è»Šæš–çˆè£¡çš„æº«æŸ”",
                heroImg: "https://placehold.co/800x600/8B4513/FFFFFF?text=Set+Day+5+Hero+Image",
                events: [
                    { time: "10:00", title: "æš–çˆé¦¬è»Š (Stove Carriage)", tag: "Experience", desc: "ã€é£¯åº—æ´»å‹•ã€‘åœ¨é¦¬è»Šä¸Šäº«ç”¨é»å¿ƒï¼Œç’°ç¹å…¬åœ’ã€‚", img: "https://placehold.co/600x300/8B4513/FFF?text=Horse+Carriage" },
                    { time: "14:00", title: "æ»‘é›ªé«”é©—", tag: "Activity", desc: "å‰å¾€ç¶ ä¹‹å¤§åœ°èˆ‡ç¾…æ›¼ä¹‹æ£®æ»‘é›ªå ´ã€‚ç·´ç¿’æ»‘é›ªã€‚", img: "https://placehold.co/600x300/ADD8E6/333?text=Skiing" },
                    { time: "17:30", title: "é£¯åº—æº«æ³‰èˆ‡ä¼‘æ¯", tag: "Relax", desc: "äº«å—éœ²å¤©æº«æ³‰ã€Œæµ®æ¹¯ã€ã€‚", img: "https://placehold.co/600x200/1C2541/FFF?text=Onsen" },
                    { time: "20:00", title: "é™¸å¥§ç¥­å…¸å±‹è¡¨æ¼”", tag: "Culture", desc: "ã€æ–‡åŒ–é«”é©—ã€‘è§€è³é’æ£®å››å¤§ç¥­å…¸è¡¨æ¼”ï¼Œæ„Ÿå—ç†±æƒ…ã€‚", img: "https://placehold.co/600x300/D32F2F/FFF?text=Matsuri+Show" }
                ]
            },
            {
                day: 6, date: "02.07", week: "SAT",
                heroTitle: "è¿”ç¨‹ï¼šæ»¿è¼‰å›æ†¶",
                heroImg: "https://placehold.co/800x600/555555/FFFFFF?text=Set+Day+6+Hero+Image",
                events: [
                    { time: "10:00", title: "æœ€çµ‚éµå¾‹ï¼šæº–æ™‚å‡ºç™¼", tag: "Transport", desc: "é–‹è»Šé›¢é–‹é£¯åº—ã€‚ä¸Šè·¯è«‹é–‹å¤§ç‡ˆï¼Œæ¥µè‡´æ…¢é€Ÿå®‰å…¨é§•é§›ã€‚", img: "https://placehold.co/600x300/333/FFF?text=Safe+Driving" },
                    { time: "13:00", title: "é’æ£®æ©Ÿå ´é‚„è»Š", tag: "Transport", desc: "æŠµé”æ©Ÿå ´ï¼ŒåŠ æ»¿æ²¹ï¼Œè¾¦ç†é‚„è»Šã€‚", img: "https://placehold.co/600x200/555/FFF?text=Car+Return" },
                    { time: "14:00", title: "æœ€çµ‚ä»»å‹™ï¼šä¼´æ‰‹ç¦®", tag: "Shopping", desc: "æ©Ÿå ´å…ç¨…åº—æœ€å¾Œæ¡è³¼ã€‚", pointSpeak: [{cn:"é€™æ˜¯é’æ£®é™å®šå—ï¼Ÿ", jp:"é€™æ˜¯é’æ£®é™å®šã§ã™ã‹ï¼Ÿ"}] },
                    { time: "15:30", title: "æ­æ©Ÿè¿”å° (BR 121)", tag: "Flight", desc: "å†è¦‹é’æ£®ï¼ŒæœŸå¾…ä¸‹æ¬¡æ—…ç¨‹ã€‚", img: "https://placehold.co/600x300/1C2541/FFF?text=Flight+BR121" }
                ]
            }
        ];

        let currentIdx = 0;
        let expenses = JSON.parse(localStorage.getItem('elegant_expenses')) || [];
        let currentImageConfig = {}; // Stores context for saving an image

        // --- INIT ---
        window.onload = function() {
            updateCountdown();
            setupFirebase(); // Start the Firebase and Firestore setup
        };

        function enterApp() {
            document.getElementById('intro-screen').style.transform = 'translateY(-100%)';
            // renderTrip is called by loadUserImages via onSnapshot
        }

        function updateCountdown() {
            const tripStartDate = new Date("2026-02-02");
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            const diffTime = tripStartDate.getTime() - today.getTime();
            const daysToStart = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            const totalDays = tripData.length;
            
            let displayValue, displayLabel;

            if (daysToStart > 0) {
                // å°šæœªé–‹å§‹
                displayValue = daysToStart;
                displayLabel = "è·é›¢å‡ºç™¼ (DAYS LEFT)";
            } else if (daysToStart <= 0 && daysToStart > -totalDays) {
                // æ—…ç¨‹ä¸­ (Day 1 is when daysToStart is 0, Day 2 is -1, etc.)
                const currentTripDay = Math.abs(daysToStart) + 1;
                displayValue = currentTripDay;
                displayLabel = `é’æ£®ä¹‹æ—… ç¬¬ ${currentTripDay} å¤©`;
                
                // Automatically switch to the current day if not already there
                if (currentIdx !== currentTripDay - 1) {
                    currentIdx = currentTripDay - 1;
                    renderTrip(); 
                }
            } else {
                // æ—…ç¨‹çµæŸ
                displayValue = "0";
                displayLabel = "æ—…ç¨‹å·²çµæŸ";
            }
            
            // Update displays
            const statusHtml = `
                <div class="status-value">${displayValue}</div>
                <div class="status-label">${displayLabel}</div>
            `;
            document.getElementById('countdown-status').innerHTML = statusHtml;
            document.getElementById('intro-days-left').innerText = daysToStart > 0 ? daysToStart : "0";
            
            // Rerun every hour (or closer if critical)
            setTimeout(updateCountdown, 3600000); 
        }

        // --- RENDER TRIP ---
        function renderTrip() {
            if (!isAuthReady) return; // Wait for Firebase auth to complete

            // Render Nav
            const nav = document.getElementById('date-nav');
            nav.innerHTML = tripData.map((d, i) => `
                <div class="d-item ${i === currentIdx ? 'active' : ''}" onclick="switchDay(${i})">
                    <div class="d-week">${d.week}</div>
                    <div class="d-num">${d.date.split('.')[1]}</div>
                </div>
            `).join('');

            // Render Timeline
            const day = tripData[currentIdx];
            const container = document.getElementById('timeline-container');
            
            // --- 1. HERO IMAGE LOGIC ---
            const heroKey = `day${currentIdx + 1}-hero`;
            const userHeroImg = userImages[heroKey] || day.heroImg;

            let html = `
                <div class="hero-card fade-in">
                    <img src="${userHeroImg}" onerror="this.onerror=null; this.src='https://placehold.co/800x600/1C2541/FFFFFF?text=Set+Your+Hero+Image';" class="hero-img">
                    <button class="image-config-btn hero-config-btn" onclick="openImageConfigModal(${currentIdx + 1}, -1, true, event)">
                        <i class="fa-solid fa-camera"></i>
                    </button>
                    <div class="hero-overlay">
                        <div class="hero-day">DAY ${day.day} / ${day.week}</div>
                        <h2 class="hero-title serif">${day.heroTitle}</h2>
                    </div>
                </div>
                <div class="timeline-block">
            `;

            // --- 2. EVENT TIMELINE LOGIC ---
            html += day.events.map((ev, i) => {
                const eventKey = `day${currentIdx + 1}-event${i}`;
                const userEventImg = userImages[eventKey] || ev.img;
                
                // Pass the final image URL back into dataStr for the detail modal
                const data = encodeURIComponent(JSON.stringify({...ev, userImg: userEventImg, dayIndex: currentIdx + 1, eventIndex: i}));
                
                const delay = i * 0.1;
                const isSpecial = ev.title.includes("ä»»å‹™") || ev.title.includes("éµå¾‹");
                const specialClass = isSpecial ? 'special-event' : '';
                
                return `
                    <div class="event-node visible" style="transition-delay: ${delay}s">
                        <div class="time-dot"></div>
                        <div class="time-label">${ev.time}</div>
                        <div class="event-card ${specialClass}" onclick="openDetail('${data}')">
                            <button class="image-config-btn" onclick="openImageConfigModal(${currentIdx + 1}, ${i}, false, event)">
                                <i class="fa-solid fa-camera"></i>
                            </button>
                            <span class="event-tag">${ev.tag}</span>
                            <div class="event-title">${ev.title}</div>
                            <div class="event-desc">${ev.desc}</div>
                            ${userEventImg ? `<img src="${userEventImg}" onerror="this.onerror=null; this.src='https://placehold.co/600x150/F4F4F4/CCCCCC?text=Set+Image';" class="event-img">` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            html += `</div>`; // Close timeline-block
            container.innerHTML = html;
            
            checkSmartReminder(); // Check reminder status on rendering the day
        }
        
        // --- TOUCH SWIPING LOGIC ---
        let initialX = null;
        function handleTouchStart(evt) {
            // Only capture touch start if not on a nested interactive element
            if (evt.target.closest('.d-item') || evt.target.closest('.image-config-btn') || document.getElementById('detail-modal').classList.contains('active')) return;
            initialX = evt.clientX || evt.touches[0].clientX;
        }

        function handleTouchMove(evt) {
            if (initialX === null) return;
            // Prevent scrolling horizontally for small movements, focus on swipe intent
            // evt.preventDefault(); // Sometimes overly restrictive in canvas
        }

        function handleTouchEnd(evt) {
            if (initialX === null) return;
            const currentX = evt.clientX || evt.changedTouches[0].clientX;
            const diffX = initialX - currentX;
            initialX = null; // Reset initial position

            const threshold = 70; // Minimum swipe distance in pixels

            if (Math.abs(diffX) > threshold) {
                if (diffX > 0) { // Swipe Left (Next Day)
                    switchDay(currentIdx + 1);
                } else { // Swipe Right (Previous Day)
                    switchDay(currentIdx - 1);
                }
            }
        }
        
        // --- SMART REMINDER LOGIC (Integrated with header) ---
        function checkSmartReminder() {
            const reminderEl = document.getElementById('smart-reminder-text');
            const weatherEl = document.getElementById('weather-status');
            const now = new Date();
            const tripStartDate = new Date("2026-02-02");
            const currentDayDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            
            const diffDays = Math.ceil((currentDayDate.getTime() - tripStartDate.getTime()) / (1000 * 60 * 60 * 24));
            
            // Placeholder Weather Status (can be fetched/dynamic in a real app)
            const weatherStatus = currentIdx === 0 ? "å‡½é¤¨: æ™´å¤©, -4Â°C" : (currentIdx < 3 ? "é’æ£®: é™°å¤©, -2Â°C" : "é’æ£®: é™é›ª, -3Â°C");
            weatherEl.innerText = weatherStatus;

            if (diffDays < 0 || diffDays >= tripData.length) {
                reminderEl.innerText = "æ—…ç¨‹å°šæœªé–‹å§‹ã€‚";
                return; 
            }

            const currentDayEvents = tripData[diffDays].events;
            let reminderMessage = "ä»Šæ—¥è¡Œç¨‹é †åˆ©ï¼";

            for (let i = 0; i < currentDayEvents.length; i++) {
                const event = currentDayEvents[i];
                if (!event.time || !event.time.includes(':')) continue;

                const [eventHour, eventMinute] = event.time.split(':').map(Number);
                const eventTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), eventHour, eventMinute);
                const timeDiffMinutes = (eventTime.getTime() - now.getTime()) / (1000 * 60);

                // --- Logic Triggers: 15 min early to 15 min late ---
                if (timeDiffMinutes > 0 && timeDiffMinutes <= 15) { 
                    reminderMessage = `ğŸ”” ${event.title} é‚„æœ‰ ${Math.round(timeDiffMinutes)} åˆ†é˜é–‹å§‹ï¼`;
                    break;
                } else if (timeDiffMinutes > -15 && timeDiffMinutes <= 0) {
                    reminderMessage = `ğŸš¨ ${event.title} å·²ç¶“é–‹å§‹ ${Math.abs(Math.round(timeDiffMinutes))} åˆ†é˜äº†ï¼`;
                    break;
                }
            }
            
            reminderEl.innerText = reminderMessage;
        }

        function switchDay(idx) {
            if (idx >= 0 && idx < tripData.length) {
                currentIdx = idx;
                renderTrip();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }
        
        // --- IMAGE CONFIGURATION LOGIC (Unchanged, relies on window export) ---
        function openImageConfigModal(dayIndex, eventIndex, isHero, e) {
            if (e) e.stopPropagation(); // Prevent card detail from opening if clicking button

            if (!userId) {
                // If auth is not successful, prevent configuration
                document.getElementById('img-config-title').innerText = "å„²å­˜å¤±æ•—ï¼šè«‹ç¢ºä¿ç¶²è·¯é€£ç·šï¼Œä¸¦é‡å•Ÿæ‡‰ç”¨ç¨‹å¼ä»¥è¼‰å…¥ä½¿ç”¨è€…èº«ä»½ã€‚";
                document.getElementById('img-config-url').value = "";
                document.getElementById('img-config-save').style.display = 'none';
                document.getElementById('img-config-modal').classList.add('active');
                document.getElementById('modal-overlay').classList.add('active');
                return;
            }
            
            currentImageConfig = { dayIndex, eventIndex, isHero };
            
            const titleEl = document.getElementById('img-config-title');
            const inputEl = document.getElementById('img-config-url');
            const saveBtn = document.getElementById('img-config-save');
            const day = tripData[dayIndex - 1]; // Use dayIndex - 1 for 0-indexed array access
            
            let currentUrl = '';
            
            if (isHero) {
                titleEl.innerText = `è¨­å®š DAY ${dayIndex} å°é¢åœ–ç‰‡`;
                currentUrl = userImages[`day${dayIndex}-hero`] || day.heroImg;
            } else {
                const event = day.events[eventIndex];
                titleEl.innerText = `è¨­å®šã€Œ${event.title}ã€åœ–ç‰‡`;
                currentUrl = userImages[`day${dayIndex}-event${eventIndex}`] || event.img;
            }
            
            // Filter out placeholder text
            inputEl.value = currentUrl.startsWith('https://placehold.co') ? '' : currentUrl;
            saveBtn.style.display = 'block';

            // Bind the save button's action dynamically
            saveBtn.onclick = handleSaveImage;

            document.getElementById('modal-overlay').classList.add('active');
            document.getElementById('img-config-modal').classList.add('active');
        }

        function handleSaveImage() {
            const newUrl = document.getElementById('img-config-url').value.trim();
            const { dayIndex, eventIndex, isHero } = currentImageConfig;
            
            // Save to Firestore. dayIndex is 1-based, eventIndex is 0-based or -1 for hero
            saveUserImage(dayIndex, eventIndex, newUrl, isHero);
            
            // Close modal happens in saveUserImage on success
        }


        // --- NAVIGATION ---
        function switchView(view, btn) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-' + view).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');

            if(view === 'wallet') renderExpenses();
            window.scrollTo(0,0);
        }

        // --- MODAL ---
        function openDetail(dataStr) {
            const data = JSON.parse(decodeURIComponent(dataStr));
            document.getElementById('m-title').innerText = data.title;
            document.getElementById('m-desc').innerText = data.desc;
            document.getElementById('m-tag').innerText = data.tag || "INFO";
            
            // Use userImg (which contains the user-set URL if available)
            const finalImgUrl = data.userImg || data.img || "https://placehold.co/800x600/F4F4F4/CCCCCC?text=L'VOYAGE";
            document.getElementById('m-img').src = finalImgUrl;
            
            const psDiv = document.getElementById('m-ps-content');
            if(data.pointSpeak) {
                document.getElementById('m-ps-area').style.display = 'block';
                psDiv.innerHTML = data.pointSpeak.map(p => `
                    <div style="margin-top:15px; padding:15px; background:#F9F9F9; border-left:3px solid var(--accent-gold);">
                        <div style="font-size:0.9rem; color:#666;">${p.cn}</div>
                        <div class="serif" style="font-size:1.4rem; color:var(--text-primary); margin-top:5px;">${p.jp}</div>
                    </div>
                `).join('');
            } else {
                document.getElementById('m-ps-area').style.display = 'none';
            }

            document.getElementById('detail-modal').classList.add('active');
            document.getElementById('modal-overlay').classList.add('active');
        }

        function closeModal() {
            document.getElementById('detail-modal').classList.remove('active');
            document.getElementById('img-config-modal').classList.remove('active');
            document.getElementById('modal-overlay').classList.remove('active');
        }

        // --- WALLET ---
        function addExpense() {
            const item = document.getElementById('ex-item').value;
            const price = parseInt(document.getElementById('ex-price').value);
            if(item && price) {
                expenses.unshift({ item, price, date: new Date().toLocaleDateString() });
                localStorage.setItem('elegant_expenses', JSON.stringify(expenses));
                renderExpenses();
                document.getElementById('ex-item').value = '';
                document.getElementById('ex-price').value = '';
            }
        }

        function renderExpenses() {
            let total = 0;
            const html = expenses.map(ex => {
                total += ex.price;
                return `
                    <div style="display:flex; justify-content:space-between; padding:15px 0; border-bottom:1px solid #EEE;">
                        <div>
                            <div style="font-weight:500;">${ex.item}</div>
                            <div style="font-size:0.8rem; color:#999;">${ex.date}</div>
                        </div>
                        <div class="serif" style="font-size:1.1rem;">Â¥${ex.price.toLocaleString()}</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('expense-list').innerHTML = html;
            document.getElementById('total-jpy').innerText = 'Â¥' + total.toLocaleString();
            document.getElementById('total-twd').innerText = (total * exchangeRate).toFixed(0);
            document.getElementById('current-rate').innerText = exchangeRate.toFixed(4);
        }

        // --- EXPORT GLOBAL FUNCTIONS FOR HTML HANDLERS (Fixing ReferenceError) ---
        window.enterApp = enterApp;
        window.switchDay = switchDay;
        window.switchView = switchView;
        window.openDetail = openDetail;
        window.closeModal = closeModal;
        window.addExpense = addExpense;
        window.openImageConfigModal = openImageConfigModal;
        window.handleSaveImage = handleSaveImage;
        window.handleTouchStart = handleTouchStart;
        window.handleTouchMove = handleTouchMove;
        window.handleTouchEnd = handleTouchEnd;
    </script>
</body>
</html>
