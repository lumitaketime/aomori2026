<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>L'VOYAGE | 函館-青森 林檎之旅</title>
    <meta name="theme-color" content="#1C2541">
    
    <link rel="manifest" href="manifest.json"> 
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&family=Noto+Serif+TC:wght@300;400;500;600;700&family=Noto+Sans+TC:wght@300;400;500&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    <style>
        /* ========================================================== */
        /* === 1. ROOT VARIABLES AND GLOBAL STYLES === */
        /* ========================================================== */
        :root {
            /* Palette: Luxury Winter (Original) */
            --bg-body: #F9F8F4;
            --bg-card: #FFFFFF;
            --text-primary: #1A1A1A;
            --text-secondary: #666666;
            --accent-main: #1C2541; /* 午夜藍 */
            --accent-gold: #B49B67; /* 香檳金 */
            --accent-red: #D9333F; /* 青森紅 */
            --line-light: #E0E0E0;
            --shadow-soft: 0 12px 45px -10px rgba(0,0,0,0.1); 
            --font-serif: 'Cormorant Garamond', 'Noto Serif TC', serif;
            --font-sans: 'Noto Sans TC', sans-serif;
            --safe-bottom: env(safe-area-inset-bottom);

            /* --- Receipt Printer Variables --- */
            --receipt-bg-body: #EAE8E0; 
            --machine-bg: #2C3550; 
            --machine-dark: #1a2033;
            --receipt-gold: #C5A870;
            --input-bg: #151b2b;
            --receipt-paper: #FDFDFD;
            
            /* Dynamic Width Logic */
            --machine-width: clamp(320px, 92vw, 420px);
            --paper-width: calc(100% - 40px); 
            
            --apple-red: #FF3B30;
            --status-green: #00FF94;
            --status-red: #FF453A;
            --status-orange: #FFaa00;
            --paper-texture: url("data:image/svg+xml,%3Csvg width='4' height='4' viewBox='0 0 4 4' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 3h1v1H1V3zm2-2h1v1H3V1z' fill='%23000000' fill-opacity='0.03' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: var(--font-sans);
            padding-bottom: calc(90px + var(--safe-bottom)); 
            overflow-x: hidden;
            overscroll-behavior-x: none; 
            overscroll-behavior-y: auto;
        }

        h1, h2, h3, .serif { font-family: var(--font-serif); }
        .hidden { display: none !important; }
        
        /* --- SYSTEM STATUS LIGHTS --- */
        .diag-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .diag-label { font-size: 0.85rem; color: #555; }
        .diag-status { width: 10px; height: 10px; border-radius: 50%; background: #DDD; transition: background 0.3s, box-shadow 0.3s; }
        .diag-status.ok { background: var(--status-green); box-shadow: 0 0 8px var(--status-green); }
        .diag-status.err { background: var(--status-red); box-shadow: 0 0 8px var(--status-red); }

        #m-desc a {
            color: var(--accent-main);
            text-decoration: underline;
            text-decoration-color: var(--accent-gold);
            text-underline-offset: 3px;
        }
        
        .info-group { padding: 15px 0; border-top: 1px solid #EEE; border-bottom: 1px solid #EEE; }
        .info-item { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: center; }
        .info-label { font-size: 0.85rem; color: #888; display: flex; align-items: center; }
        .info-label i { margin-right: 8px; color: var(--accent-gold); }
        .info-value { font-size: 0.95rem; font-weight: 500; color: var(--accent-main); text-align: right; }

        /* --- TOAST --- */
        #app-message {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: var(--accent-main); color: white;
            padding: 10px 20px; border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 2200; opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease, transform 0.3s ease;
            font-size: 0.9rem;
            min-width: 200px; text-align: center;
        }
        #app-message.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }

        /* --- INTRO SCREEN --- */
        #intro-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background: linear-gradient(180deg, #1C2541 0%, #151b30 100%);
            color: white;
            z-index: 9999; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            transition: transform 1s cubic-bezier(0.77, 0, 0.175, 1);
            padding: 0 30px;
            overflow: hidden; 
        }

        #snow-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1;
        }

        .snowflake {
            position: absolute; color: #FFF; opacity: 0.8; top: -20px;
            animation: fall linear infinite; font-size: 1rem;
            text-shadow: 0 0 5px rgba(255,255,255,0.8);
        }

        @keyframes fall { to { transform: translateY(105vh); } }

        .intro-text {
            position: relative; z-index: 10; text-align: center;
            display: flex; flex-direction: column; align-items: center;
            width: 100%; max-width: 400px;
        }

        .intro-main-icon {
            font-size: 2.2rem; color: var(--accent-gold); margin-bottom: 20px;
            filter: drop-shadow(0 0 10px rgba(180, 155, 103, 0.3));
            animation: floatIcon 6s ease-in-out infinite, fadeIn 1.5s ease forwards 0.2s;
            opacity: 0;
        }

        @keyframes floatIcon {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-8px) rotate(5deg); } 
        }

        .intro-countdown-block { 
            margin-bottom: 40px; opacity: 0; 
            animation: fadeIn 1.5s ease forwards 0.5s; 
            text-align: center; position: relative;
        }

        .countdown-value { 
            font-size: 6.5rem; line-height: 1; font-weight: 300; 
            color: var(--accent-gold); font-family: var(--font-serif);
            margin-bottom: 10px; text-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .countdown-label {
            font-size: 0.75rem; letter-spacing: 6px; 
            color: rgba(255,255,255,0.6); text-transform: uppercase;
            font-weight: 400; margin-top: -5px;
        }

        .intro-title {
            font-family: var(--font-serif); font-size: 1.8rem; letter-spacing: 2px;
            margin-bottom: 5px; font-weight: 500; opacity: 0;
            animation: fadeIn 1.5s ease forwards 0.8s;
        }

        .intro-subtitle {
            font-family: var(--font-serif); font-size: 0.9rem;
            color: rgba(255,255,255,0.5); letter-spacing: 1px;
            margin-bottom: 20px; opacity: 0;
            animation: fadeIn 1.5s ease forwards 0.8s;
        }

        #dynamic-intro-text {
            font-family: var(--font-sans); font-size: 0.95rem; 
            margin-top: 10px; color: rgba(255,255,255,0.9); 
            max-width: 320px; text-align: center; line-height: 1.6; 
            min-height: 60px; display: flex; align-items: center; justify-content: center;
            opacity: 0; animation: fadeIn 1.5s ease forwards 1s;
            padding: 5px 0; letter-spacing: 1px; font-weight: 300;
        }

        .intro-btn {
            margin-top: 40px; padding: 14px 50px; 
            border: 1px solid rgba(255,255,255,0.4); border-radius: 50px;
            background: rgba(255,255,255,0.05); backdrop-filter: blur(5px);
            color: white; font-family: var(--font-serif); font-size: 1.1rem; 
            letter-spacing: 3px; cursor: pointer; transition: all 0.4s ease;
            opacity: 0; animation: fadeIn 1.5s ease forwards 1.2s;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .intro-btn:hover { background: rgba(255,255,255,0.15); border-color: rgba(255,255,255,0.8); transform: translateY(-2px); }
        .intro-btn:active { transform: translateY(1px); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* --- HEADER --- */
        .elegant-header {
            padding: 40px 20px 20px;
            background: linear-gradient(to bottom, #F9F8F4 85%, rgba(249,248,244,0.8) 95%, rgba(249,248,244,0));
            position: sticky; top: 0; z-index: 100; transition: background 0.3s;
        }
        .wallet-mode .elegant-header {
            background: rgba(234, 232, 224, 0.95); 
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .top-meta { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .brand-container { display: flex; align-items: baseline; gap: 10px; }
        .brand { font-family: var(--font-serif); font-size: 1.4rem; font-weight: 700; letter-spacing: 1px; color: var(--accent-main); }
        
        /* AI Guide Widget */
        #ai-guide-widget { 
            display: flex; align-items: center; gap: 8px; opacity: 0; transition: opacity 0.5s; pointer-events: none;
        }
        #ai-guide-widget.visible { opacity: 1; pointer-events: auto; }
        
        .ai-btn {
            background: linear-gradient(135deg, #1C2541 0%, #3A506B 100%);
            color: var(--accent-gold); border: 1px solid var(--accent-gold);
            width: 30px; height: 30px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 0.9rem; cursor: pointer; box-shadow: 0 2px 10px rgba(180, 155, 103, 0.3);
            animation: pulseStar 3s infinite;
        }
        @keyframes pulseStar { 0% { transform: scale(1); } 50% { transform: scale(1.1); box-shadow: 0 0 15px rgba(180, 155, 103, 0.6); } 100% { transform: scale(1); } }
        
        .ai-suggestion-pill {
            font-size: 0.75rem; color: #555; background: rgba(255,255,255,0.8);
            padding: 4px 10px; border-radius: 20px; border: 1px solid rgba(0,0,0,0.05);
            max-width: 140px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            cursor: pointer; backdrop-filter: blur(5px);
        }

        .status-value { font-family: var(--font-serif); font-size: 2rem; line-height: 1; color: var(--accent-gold); text-align: right; }
        .status-label { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 2px; color: var(--text-secondary); text-align: right; margin-top: 5px; }

        /* DATE SCROLLER */
        .date-scroller { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; scroll-behavior: smooth; }
        .date-scroller::-webkit-scrollbar { display: none; }
        .d-item { 
            min-width: 60px; text-align: center; opacity: 0.4; transition: 0.4s; cursor: pointer; 
            display: flex; flex-direction: column; align-items: center;
            user-select: none; flex-shrink: 0; 
        }
        .d-item.active { opacity: 1; transform: scale(1.1); }
        .d-week { font-size: 0.7rem; letter-spacing: 1px; margin-bottom: 5px; text-transform: uppercase; }
        .d-num { font-family: var(--font-serif); font-size: 1.5rem; position: relative; line-height: 1;}
        .d-item.active .d-num::after {
            content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%);
            width: 4px; height: 4px; background: var(--accent-gold); border-radius: 50%;
        }
        .d-weather { font-size: 0.6rem; margin-top: 8px; color: var(--text-secondary); display: flex; flex-direction: column; align-items: center; gap: 2px; min-height: 25px; }
        .d-weather i { font-size: 0.8rem; margin-bottom: 2px; }
        .d-item.active .d-weather { color: var(--accent-main); font-weight: 600; }

        /* --- TRIP VIEW --- */
        .view-section { width: 100%; }
        #view-trip { overflow-x: hidden; min-height: 80vh; touch-action: pan-y; }

        .container { 
            padding: 0 20px; max-width: 600px; margin: 0 auto; 
            transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.35s ease; 
            will-change: transform, opacity;
        }

        .slide-out-left { transform: translateX(-50px); opacity: 0; }
        .slide-out-right { transform: translateX(50px); opacity: 0; }
        .slide-in-from-right { animation: slideInRight 0.35s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .slide-in-from-left { animation: slideInLeft 0.35s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }

        @keyframes slideInRight { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideInLeft { from { transform: translateX(-50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        .hero-card {
            position: relative; height: 280px; border-radius: 4px; overflow: hidden; margin-bottom: 20px;
            box-shadow: var(--shadow-soft);
        }
        .hero-img { width: 100%; height: 100%; object-fit: cover; transition: transform 10s ease; }
        .hero-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; padding: 25px;
            background: linear-gradient(to top, rgba(28,37,65,0.9), transparent); color: white;
        }
        .hero-title { font-size: 1.6rem; margin: 0; line-height: 1.3; font-weight: 500; color: white; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }

        .timeline-block { position: relative; padding-left: 20px; border-left: 1px solid var(--line-light); margin-left: 10px; }
        .event-node { position: relative; opacity: 0; transform: translateY(20px); transition: 0.6s ease; margin-bottom: 35px; }
        .event-node.visible { opacity: 1; transform: translateY(0); }
        
        .time-dot { 
            position: absolute; left: -25px; top: 0; width: 9px; height: 9px; 
            background: var(--bg-body); border: 2px solid var(--accent-main); border-radius: 50%; 
        }
        .event-card {
            background: var(--bg-card); padding: 20px; border-radius: 4px;
            box-shadow: var(--shadow-soft); cursor: pointer; transition: 0.3s;
            border-bottom: 2px solid transparent;
        }
        .event-card:active { transform: scale(0.98); }
        .event-tag { font-size: 0.6rem; text-transform: uppercase; letter-spacing: 2px; color: var(--text-secondary); margin-bottom: 8px; display: block; }
        .event-title { font-family: var(--font-serif); font-size: 1.25rem; margin-bottom: 6px; color: var(--accent-main); font-weight: 700; }
        
        .transport-card {
            background: #F0F4F8; border-left: 3px solid #4A5672;
            position: relative; box-shadow: 0 4px 15px -5px rgba(0,0,0,0.1); 
            padding: 20px 30px; margin-left: 10px; 
        }
        .transport-card::before, .transport-card::after {
            content: ''; position: absolute; top: 50%;
            width: 24px; height: 24px; background: var(--bg-body);
            border-radius: 50%; transform: translateY(-50%); z-index: 2; 
            box-shadow: var(--shadow-soft);
        }
        .transport-card::before { left: -12px; }
        .transport-card::after { right: -12px; }

        .alert-banner {
            background: rgba(217, 51, 63, 0.08); border-left: 3px solid var(--accent-red);
            padding: 15px; margin-bottom: 20px; border-radius: 0 4px 4px 0;
            display: flex; gap: 12px; align-items: flex-start;
        }
        .alert-highlight { color: var(--accent-red); font-weight: 700; display: block; margin-top: 4px; font-size: 0.85rem;}

        /* Active Event Animation (Low key luxury) */
        @keyframes subtleBreath {
            0% { box-shadow: 0 0 5px rgba(180, 155, 103, 0.1); }
            50% { box-shadow: 0 0 15px rgba(180, 155, 103, 0.6); }
            100% { box-shadow: 0 0 5px rgba(180, 155, 103, 0.1); }
        }
        .active-event .event-card {
            /* border: 1px solid rgba(180, 155, 103, 0.5); // Optional: Subtle border */
            animation: subtleBreath 3s infinite ease-in-out;
            background: rgba(255, 255, 255, 1); 
            transform: scale(1.02);
            position: relative;
            z-index: 5;
        }
        .active-event .time-dot {
            background: var(--accent-gold); border-color: var(--accent-gold);
            box-shadow: 0 0 10px var(--accent-gold);
        }
        .now-badge {
            display: inline-block; background: var(--accent-main); color: var(--accent-gold);
            font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; margin-left: 8px;
            vertical-align: middle; letter-spacing: 1px; font-weight: 700;
        }

        /* --- TRANSLATE VIEW (Updated) --- */
        #view-trans { padding-top: 20px; }
        
        .trans-card {
            background: var(--bg-card); border-radius: 8px;
            box-shadow: var(--shadow-soft); padding: 25px;
            margin-bottom: 25px; border: 1px solid #EEE;
        }

        .trans-input {
            width: 100%; border: 1px solid #E0E0E0; border-radius: 4px;
            padding: 15px; font-family: var(--font-sans); font-size: 1rem;
            resize: none; background: #FAFAFA; outline: none; transition: border 0.3s;
        }
        .trans-input:focus { border-color: var(--accent-gold); background: #FFF; }

        .trans-action-btn {
            width: 100%; margin-top: 15px; padding: 12px;
            background: var(--accent-main); color: white;
            border: none; border-radius: 4px; font-size: 1rem;
            cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .trans-action-btn:active { transform: translateY(1px); }

        /* Optimized Output Box for Translation */
        #trans-output-box {
            margin-top: 25px; 
            padding: 15px; 
            border-radius: 4px; 
            background: #F8F8F8; 
            border-left: 4px solid var(--accent-gold);
            word-break: break-word; /* Prevent layout breaking */
            overflow-wrap: break-word;
        }

        #trans-jp-result {
            font-family: var(--font-serif);
            font-size: 1.6rem; /* Increased size */
            color: var(--accent-main);
            margin-top: 10px;
            font-weight: 600;
            line-height: 1.4;
        }

        .romaji-text {
            display: block;
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-family: var(--font-sans);
            margin-top: 8px;
            font-weight: 400;
            letter-spacing: 0.5px;
            line-height: 1.4;
        }

        .ps-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .ps-card {
            background: var(--bg-card); padding: 20px 10px;
            border-radius: 8px; box-shadow: var(--shadow-soft);
            text-align: center; border: 1px solid #F0F0F0;
            cursor: pointer; transition: 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .ps-card:active { transform: scale(0.98); background: #FAFAFA; }
        .ps-icon { font-size: 1.8rem; margin-bottom: 10px; display: block; color: var(--accent-main); }
        .ps-title { font-size: 0.9rem; color: #555; }
        
        #fs-controls {
            margin-top: 30px; display: flex; gap: 10px;
            justify-content: center; width: 100%; flex-wrap: wrap;
        }
        .fs-ctrl-btn {
            background: transparent; border: 1px solid #DDD;
            padding: 8px 16px; border-radius: 50px;
            font-size: 0.9rem; color: #555; cursor: pointer; transition: 0.2s;
            min-width: 80px;
        }
        .fs-ctrl-btn.active {
            background: var(--accent-gold); color: white; border-color: var(--accent-gold);
        }
        .fs-qty-ctrl {
            display: flex; align-items: center; gap: 20px;
            background: #F5F5F5; padding: 10px 20px; border-radius: 50px;
        }
        .fs-qty-btn {
            width: 40px; height: 40px; border-radius: 50%;
            border: none; background: white; color: var(--accent-main);
            font-size: 1.2rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer;
        }
        .fs-qty-val { font-size: 1.5rem; font-weight: 700; width: 40px; text-align: center; }

        /* Checkout Matrix UI */
        .checkout-matrix { display: flex; flex-direction: column; gap: 15px; width: 100%; align-items: center;}
        .matrix-row { display: flex; gap: 10px; }

        .info-card { background: white; padding: 20px; border-radius: 8px; box-shadow: var(--shadow-soft); margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .info-icon { width: 40px; height: 40px; border-radius: 50%; background: #F5F5F5; display: flex; justify-content: center; align-items: center; color: var(--accent-main); margin-right: 15px; }
        .map-overview-card { background: white; padding: 15px; border-radius: 8px; box-shadow: var(--shadow-soft); margin-bottom: 30px; }
        .map-iframe { width: 100%; height: 350px; border: none; border-radius: 4px; }
        
        /* --- NAV BAR --- */
        .glass-nav {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: auto; min-width: 280px;
            background: rgba(28, 37, 65, 0.95); backdrop-filter: blur(10px);
            border-radius: 50px; padding: 10px 30px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 1000; gap: 25px;
        }
        .nav-btn { color: rgba(255,255,255,0.4); font-size: 1.4rem; cursor: pointer; transition: 0.3s; position: relative; padding: 10px; display: flex; justify-content: center; align-items: center; }
        .nav-btn.active { color: var(--accent-gold); transform: translateY(-2px); }
        .nav-btn.active::after { content: ''; position: absolute; bottom: 0; width: 4px; height: 4px; background: var(--accent-gold); border-radius: 50%; }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1900; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-full {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 90vh;
            background: var(--bg-body); z-index: 2000; border-radius: 20px 20px 0 0;
            transform: translateY(100%); transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            overflow-y: auto; padding-bottom: 40px;
        }
        .modal-full.active { transform: translateY(0); }
        .modal-header-img { height: 250px; width: 100%; object-fit: cover; }
        .modal-content { padding: 0 20px; }
        
        .note-edit-area { width: 100%; padding: 10px; border: 1px solid var(--accent-gold); border-radius: 4px; font-family: var(--font-sans); margin-bottom: 10px; font-size: 1rem; line-height: 1.5; }
        .note-save-btn { background: var(--accent-gold); color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
        .snowflake-icon { color: #B49B67; font-size: 1.1rem; cursor: pointer; margin-left: 10px; transition: transform 0.3s; display: inline-block; }
        .snowflake-icon:hover { transform: rotate(45deg); }

        #fs-text-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2100; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 40px; text-align: center; transform: scale(0.9); opacity: 0; pointer-events: none; transition: 0.3s; }
        #fs-text-modal.active { transform: scale(1); opacity: 1; pointer-events: auto; }
        .fs-jp { font-size: 2.5rem; font-weight: 700; margin-bottom: 20px; line-height: 1.4; color: var(--text-primary); }
        .fs-cn { font-size: 1.2rem; color: #666; background: #F5F5F5; padding: 10px 20px; border-radius: 20px; }

        /* ========================================================== */
        /* === RECEIPT PRINTER STYLES === */
        /* ========================================================== */
        #view-wallet {
            background-color: var(--receipt-bg-body);
            min-height: 100vh;
            padding: 110px 15px 160px; 
            display: flex; flex-direction: column; align-items: center;
        }

        .printer-assembly { position: relative; width: var(--machine-width); display: flex; flex-direction: column; align-items: center; z-index: 100; margin-top: 10px; margin-bottom: 50px; margin-left: auto; margin-right: auto; }
        .paper-input-feed { position: absolute; width: var(--paper-width); left: 50%; transform: translateX(-50%); top: -95px; height: 125px; background: var(--receipt-paper); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 10; background-image: var(--paper-texture); mask-image: linear-gradient(to bottom, transparent, black 15%); -webkit-mask-image: linear-gradient(to bottom, transparent, black 15%); overflow: hidden; cursor: pointer; transition: transform 0.3s, top 0.3s; }
        .paper-input-feed:hover { transform: translateX(-50%) translateY(-2px); }
        .paper-input-feed.expanded .feed-scroll-wrapper { transform: translate3d(0, -125px, 0); }
        @keyframes peekScroll { 0% { transform: translate3d(0, 0, 0); } 15% { transform: translate3d(0, -125px, 0); } 85% { transform: translate3d(0, -125px, 0); } 100% { transform: translate3d(0, 0, 0); } }
        .feed-scroll-wrapper.anim-peek { animation: peekScroll 2.0s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .feed-scroll-wrapper { width: 100%; height: 250px; display: flex; flex-direction: column; transform: translate3d(0, 0, 0); transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1); }
        .feed-section { width: 100%; height: 125px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; padding-bottom: 40px; }
        .input-header-content { text-align: center; color: #AAA; width: 80%; }
        .feed-total-view { text-align: center; width: 100%; }
        .input-brand { font-family: 'Cormorant Garamond', serif; font-size: 1.1rem; font-weight: 600; letter-spacing: 1px; color: #777; margin-bottom: 4px; text-transform: uppercase; }
        .input-date { font-family: 'Share Tech Mono', monospace; font-size: 0.7rem; color: #BBB; letter-spacing: 1px; margin-bottom: 8px; }
        .input-dash { width: 100%; height: 1px; border-bottom: 1px dashed #DDD; }
        .feed-total-label { font-family: 'Share Tech Mono', monospace; font-size: 0.65rem; color: #999; letter-spacing: 2px; margin-bottom: 4px; text-transform: uppercase; }
        .feed-total-amount { font-family: 'Cormorant Garamond', serif; font-size: 2rem; font-weight: 700; color: var(--machine-bg); line-height: 1; margin-bottom: 2px; }
        .feed-total-sub { font-family: 'Share Tech Mono', monospace; font-size: 0.7rem; color: #BBB; }
        .machine-body { width: 100%; background: var(--machine-bg); border-radius: 20px 20px 0 0; padding: 25px 25px 35px 25px; box-shadow: 0 5px 20px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.1), 0 0 0 1px rgba(0,0,0,0.2); position: relative; z-index: 50; }
        .machine-bottom-lip { width: 100%; height: 25px; background: #0a0a0a; border-radius: 0 0 20px 20px; position: relative; z-index: 30; margin-top: 0; box-shadow: inset 0 2px 10px rgba(0,0,0,0.9), 0 20px 40px -10px rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; }
        .lip-line { width: 80%; height: 2px; background: #222; border-radius: 2px; opacity: 0.5; }
        .continuous-receipt-container { position: relative; width: var(--paper-width); margin-top: -40px; z-index: 40; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.1)); margin-left: auto; margin-right: auto; }
        .receipt-strip { background: var(--receipt-paper); background-image: var(--paper-texture); min-height: 120px; display: flex; flex-direction: column; padding-top: 30px; position: relative; }
        .receipt-strip::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 30px; background: linear-gradient(to bottom, rgba(0,0,0,0.3), transparent); z-index: 2; pointer-events: none; }
        .receipt-strip::after { content: ""; position: absolute; bottom: -10px; left: 0; width: 100%; height: 10px; background: linear-gradient(45deg, transparent 33.333%, var(--receipt-paper) 33.333%, var(--receipt-paper) 66.667%, transparent 66.667%), linear-gradient(-45deg, transparent 33.333%, var(--receipt-paper) 33.333%, var(--receipt-paper) 66.667%, transparent 66.667%); background-size: 10px 20px; background-position: 0 -10px; }
        .machine-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .brand-plate { background: rgba(0,0,0,0.3); padding: 4px 10px; border-radius: 4px; border: 1px solid rgba(197, 168, 112, 0.2); display: flex; align-items: center; }
        .machine-label { font-family: 'Share Tech Mono', monospace; color: var(--receipt-gold); font-size: 0.65rem; letter-spacing: 2px; text-transform: uppercase; }
        .header-right-group { display: flex; align-items: center; gap: 12px; }
        .rate-display { font-family: 'Share Tech Mono', monospace; color: rgba(197, 168, 112, 0.5); font-size: 0.65rem; letter-spacing: 1px; }
        .rate-label-default { font-size: 0.5em; opacity: 0.7; margin-left: 4px; background: rgba(255,69,58,0.2); padding: 1px 3px; border-radius: 2px; color: #FF453A; }
        .status-light { width: 6px; height: 6px; border-radius: 50%; transition: background-color 0.3s, box-shadow 0.3s; }
        .status-light.online { background-color: var(--status-green); box-shadow: 0 0 8px var(--status-green); }
        .status-light.offline { background-color: var(--status-red); box-shadow: 0 0 8px var(--status-red); }
        .status-light.processing { background-color: var(--status-orange); box-shadow: 0 0 10px var(--status-orange); }
        .mode-tabs { display: flex; background: #1a2033; padding: 4px; border-radius: 8px; margin-bottom: 15px; border: 1px solid rgba(0,0,0,0.2); }
        .mode-tab { flex: 1; background: transparent; border: none; color: #888; padding: 8px 0; font-family: 'Share Tech Mono', monospace; font-size: 0.7rem; cursor: pointer; transition: 0.2s; border-radius: 6px; text-transform: uppercase; letter-spacing: 1px; }
        .mode-tab.active { background: var(--receipt-gold); color: var(--machine-dark); font-weight: 700; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .settings-toggle { color: rgba(255,255,255,0.3); font-size: 1rem; cursor: pointer; transition: 0.3s; margin-left: 10px; }
        .settings-toggle:hover, .settings-toggle.active { color: var(--receipt-gold); transform: rotate(90deg); }
        .settings-panel { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; background: rgba(0,0,0,0.2); border-radius: 6px; margin-bottom: 0; }
        .settings-panel.open { max-height: 600px; margin-bottom: 15px; padding: 10px; }
        .adv-setting-group { margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; }
        .adv-label { font-family:'Share Tech Mono'; color:#888; font-size:0.7rem; margin-bottom:8px; display:block; text-transform:uppercase; letter-spacing:1px; }
        .setting-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
        .setting-name { color: #ccc; font-size: 0.8rem; display: flex; align-items: center; gap: 8px; }
        .setting-status { width: 6px; height: 6px; border-radius: 50%; background: #444; }
        .setting-status.ok { background: var(--status-green); box-shadow: 0 0 5px var(--status-green); }
        .setting-status.err { background: var(--status-red); }
        .toggle-btn { background: transparent; border: none; cursor: pointer; color: #555; font-size: 1.2rem; transition: 0.3s; }
        .toggle-btn.on { color: var(--status-green); }
        .setting-input { width: 100%; background: #151b2b; border: 1px solid rgba(255,255,255,0.1); color: var(--receipt-gold); font-family: monospace; font-size: 0.8rem; padding: 5px 8px; border-radius: 4px; outline: none; margin-bottom: 10px; display: none; }
        .setting-input.visible { display: block; }
        .setting-input:focus { border-color: var(--receipt-gold); }
        .light-theme .setting-name { color: #333; }
        .light-theme .setting-status { background: #ccc; }
        .light-theme .setting-status.ok { background: var(--status-green); }
        .light-theme .setting-status.err { background: var(--status-red); }
        .info-setting-input { width: 100%; background: #F8F8F8; border: 1px solid #DDD; color: #333; font-family: monospace; font-size: 0.8rem; padding: 8px; border-radius: 4px; outline: none; margin-bottom: 10px; display: none; }
        .info-setting-input.visible { display: block; }
        .info-setting-input:focus { border-color: var(--accent-main); background: #FFF; }
        .input-deck { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px;}
        .skeuo-slot { background: var(--input-bg); border-radius: 8px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5), 0 1px 0 rgba(255,255,255,0.05); padding: 2px; border: 1px solid rgba(0,0,0,0.3); position: relative; transition: all 0.3s; }
        .skeuo-slot.hidden { display: none; }
        .machine-input { width: 100%; background: transparent; border: none; color: #E0E0E0; padding: 12px 15px; font-family: 'Noto Serif TC', serif; font-size: 0.95rem; outline: none; letter-spacing: 0.5px; position: relative; z-index: 5; }
        .machine-input::placeholder { font-family: 'Noto Serif TC', serif; color: rgba(255,255,255,0.15); font-style: normal; }
        .price-wrapper { display: flex; align-items: center; padding-left: 10px; height: 100%; }
        .currency-switch { font-family: 'Share Tech Mono', monospace; color: var(--receipt-gold); font-size: 0.9rem; margin-right: 5px; cursor: pointer; padding: 0 8px; display: flex; align-items: center; gap: 4px;}
        .price-input-container { flex: 1; position: relative; display: flex; align-items: center; }
        .price-input-container .machine-input { padding-right: 110px; font-size: 1.5rem; font-family: 'Cormorant Garamond', serif; font-weight: 600; color: var(--receipt-gold); padding-top: 12px; padding-bottom: 12px; }
        .input-subtext { position: absolute; right: 15px; font-family: 'Share Tech Mono', monospace; font-size: 0.75rem; color: rgba(180, 155, 103, 0.5); pointer-events: none; }
        .control-panel { display: flex; justify-content: space-between; gap: 15px; }
        .user-toggles-compact { flex: 1; display: flex; background: #0f1420; border-radius: 6px; padding: 4px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.5); border: 1px solid rgba(0,0,0,0.3); gap: 2px; }
        .u-btn { flex: 1; background: transparent; border: none; color: rgba(255,255,255,0.2); padding: 0; border-radius: 4px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: 0.2s; font-family: 'Noto Serif TC', serif; }
        .u-btn.active { background: var(--receipt-gold); color: var(--machine-dark); box-shadow: 0 2px 5px rgba(0,0,0,0.3); font-weight: bold; }
        .print-btn { width: 100px; height: 45px; background: linear-gradient(to bottom, #C5A870, #967d4d); border: none; color: #2b2b2b; font-family: 'Share Tech Mono', monospace; font-size: 0.8rem; border-radius: 4px; cursor: pointer; box-shadow: 0 5px 0 #5e4d2b; font-weight: 700; position: relative; letter-spacing: 1px; overflow: hidden; transition: all 0.1s; }
        .print-btn:active { transform: translateY(4px); box-shadow: 0 1px 0 #5e4d2b; }
        .print-btn.processing { opacity: 0.8; cursor: wait; pointer-events: none; color: rgba(43,43,43, 0.6); }
        .receipt-entry { position: relative; overflow: hidden; background: transparent; transition: max-height 0.4s ease-out, margin 0.4s ease-out, padding 0.4s ease-out, opacity 0.3s; max-height: 150px; transform: translate3d(0,0,0); }
        .receipt-content { position: relative; background: var(--receipt-paper); background-image: var(--paper-texture); padding: 12px 20px; z-index: 5; border-bottom: 1px dashed #DDD; transition: transform 0.25s cubic-bezier(0.2, 0.8, 0.2, 1); cursor: pointer; width: 100%; }
        .delete-underlay { position: absolute; top: 0; bottom: 0; right: 0; width: 100%; background-color: var(--apple-red); display: flex; align-items: center; justify-content: flex-end; padding-right: 25px; z-index: 1; color: white; font-size: 1.2rem; opacity: 0; transition: opacity 0.2s; }
        .receipt-entry.reveal-delete .delete-underlay { opacity: 1; }
        .receipt-entry.reveal-delete .receipt-content { transform: translate3d(-80px, 0, 0); }
        .receipt-entry.new-item { animation: printSlideOut 1.2s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        .receipt-entry.tearing .receipt-content { transition: transform 0.4s ease-in, opacity 0.3s ease-in; transform: translate3d(-120%, 0, 0) rotate(-10deg); opacity: 0; }
        .receipt-entry.tearing { max-height: 0; margin: 0; padding: 0; opacity: 0; }
        .receipt-entry.dimmed .receipt-content { opacity: 0.4; filter: grayscale(1); }
        @keyframes printSlideOut { from { opacity: 0; max-height: 0; padding-top: 0; padding-bottom: 0; transform: translateY(-30px); } to { opacity: 1; max-height: 150px; padding-top: 12px; padding-bottom: 12px; transform: translateY(0); } }
        .re-header { display: flex; justify-content: space-between; font-family: 'Share Tech Mono', monospace; font-size: 0.6rem; color: #999; margin-bottom: 4px; pointer-events: none;}
        .re-body { display: flex; justify-content: space-between; align-items: flex-end; pointer-events: none;}
        .re-item { font-family: 'Noto Serif TC', serif; font-weight: 700; color: #333; font-size: 1rem; }
        .re-user { display: inline-block; background: #333; color: #fff; font-size: 0.6rem; padding: 1px 5px; border-radius: 4px; margin-right: 5px; vertical-align: middle; min-width: 20px; text-align: center;}
        .receipt-entry:not(.dimmed) .re-user { background: var(--receipt-gold); color: var(--machine-dark); }
        .re-cost { text-align: right; }
        .re-price { font-family: 'Cormorant Garamond', serif; font-weight: 700; font-size: 1.2rem; color: var(--machine-bg); line-height: 1; }
        .re-sub { font-family: 'Share Tech Mono'; font-size: 0.65rem; color: #999; margin-top: 2px; }
        .re-note { font-family: var(--font-sans); font-size: 0.9rem; color: #555; white-space: pre-wrap; line-height: 1.4; margin-top: 5px; }
        .re-todo-check { color: #BBB; margin-right: 10px; font-size: 1.1rem; transition: 0.2s; }
        .receipt-entry.done .re-todo-check { color: var(--status-green); }
        .receipt-entry.done .re-item { position: relative; color: #AAA; }
        .receipt-entry.done .re-item::after { content: ''; position: absolute; left: 0; top: 50%; width: 100%; height: 2px; background: var(--accent-red); transform: rotate(-1deg); opacity: 0.7; }
        .receipt-total-section { margin-top: auto; padding: 20px 20px 20px; border-top: 2px solid #333; border-bottom: 4px double #333; margin-bottom: 10px; background: rgba(0,0,0,0.02); }
        .total-row { display: flex; justify-content: space-between; align-items: baseline; }
        .total-label { font-family: 'Cormorant Garamond', serif; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; font-size: 1rem; color: #333;}
        .total-amount { font-family: 'Cormorant Garamond', serif; font-weight: 700; font-size: 1.6rem; color: #333; }
        .trip-total-row { display: flex; justify-content: space-between; align-items: center; margin-top: 8px; padding-top: 8px; border-top: 1px dashed #DDD; color: #999; font-size: 0.7rem; font-family: 'Share Tech Mono'; }
        .receipt-empty { text-align: center; color: #CCC; font-family: 'Share Tech Mono'; font-size: 0.7rem; padding: 40px 20px; letter-spacing: 1px; }
        .sys-summary { background: #fff; padding: 15px; border-radius: 8px; margin-top: 15px; border: 1px solid #EEE; margin-bottom: 30px; }
        .sys-title { font-family: 'Share Tech Mono'; font-size: 0.75rem; color: #999; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; margin: 0;}

    </style>
</head>
<body>

    <div id="intro-screen">
        <div id="snow-container"></div>
        <div class="intro-text">
            <i class="fa-solid fa-snowflake intro-main-icon"></i>
            <div class="intro-countdown-block">
                <div class="countdown-value" id="days-left">--</div>
                <div class="countdown-label">DAYS TO DEPARTURE</div>
            </div>
            <div class="intro-title">林檎與白雪之旅</div>
            <div class="intro-subtitle">Hokkaido & Aomori Winter Adventure</div>
            <div id="dynamic-intro-text"></div> 
            <button class="intro-btn" onclick="window.initApp()">開始旅程</button>
        </div>
    </div>

    <div id="app-container">
        
        <div class="elegant-header" id="app-header">
            <div class="top-meta">
                <div class="brand-container">
                    <div class="brand">L'VOYAGE</div>
                    <div id="ai-guide-widget" class="hidden" onclick="window.askAiGuide()">
                        <div class="ai-btn">✨</div>
                        <div class="ai-suggestion-pill" id="ai-pill-text">AI Guide Ready...</div>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div class="status-value" id="header-days">--</div>
                    <div class="status-label">DAYS TO GO</div>
                </div>
            </div>
            <div class="date-scroller" id="date-nav"></div>
        </div>

        <div id="view-trip" class="view-section">
            <div class="container" id="timeline-container"></div>
        </div>

        <div id="view-wallet" class="view-section hidden" style="position:relative;">
            <div class="printer-assembly">
                <div class="paper-input-feed" onclick="window.toggleTopFeed()" id="top-paper-feed">
                    <div class="feed-scroll-wrapper" id="feed-scroll-wrapper">
                        <div class="feed-section header-view">
                            <div class="input-header-content">
                                <div class="input-brand">L'VOYAGE</div>
                                <div class="input-date" id="header-date">--</div>
                                <div class="input-dash"></div>
                            </div>
                        </div>
                        <div class="feed-section total-view">
                            <div class="feed-total-view">
                                <div class="feed-total-label" id="top-total-label">TRIP TOTAL</div>
                                <div class="feed-total-amount" id="top-total-amount">¥0</div>
                                <div class="feed-total-sub" id="top-total-sub">≈ TWD 0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="machine-body">
                    <div class="machine-header">
                        <div class="brand-plate">
                            <div class="machine-label">L'VOYAGE RECORDER</div>
                        </div>
                        <div class="header-right-group">
                            <div class="rate-display">RATE: <span id="rate-value">0.22</span></div>
                            <div class="status-light offline" id="status-light"></div>
                            <div class="settings-toggle" onclick="window.toggleSettings()"><i class="fa-solid fa-gear"></i></div>
                        </div>
                    </div>

                    <div class="settings-panel" id="settings-panel">
                        <div style="font-family:'Share Tech Mono'; color:#888; font-size:0.7rem; margin-bottom:5px;">DEFAULT USER</div>
                        <div class="user-toggles-compact" id="user-toggles">
                            <button class="u-btn active" onclick="window.selectUser(this, '奎')">奎</button>
                            <button class="u-btn" onclick="window.selectUser(this, '愉')">愉</button>
                            <button class="u-btn" onclick="window.selectUser(this, '舜')">舜</button>
                        </div>

                        <div style="margin-top:15px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                                <span style="font-family:'Share Tech Mono'; color:#888; font-size:0.7rem;">MANUAL RATE OVERRIDE</span>
                            </div>
                            <input type="number" id="inp-ex-manual" class="setting-input visible" placeholder="Manual Rate (e.g. 0.22)" step="0.01" onchange="window.saveApiSetting('ex_manual', this.value)">
                        </div>
                    </div>

                    <div class="mode-tabs">
                        <button class="mode-tab active" onclick="window.switchMode('spend')">SPEND</button>
                        <button class="mode-tab" onclick="window.switchMode('todo')">TODO</button>
                        <button class="mode-tab" onclick="window.switchMode('memo')">MEMO</button>
                    </div>

                    <div class="input-deck">
                        <div class="skeuo-slot">
                            <input type="text" id="input-item" class="machine-input" placeholder="ITEM NAME" autocomplete="off">
                        </div>
                        <div class="skeuo-slot" id="slot-price">
                            <div class="price-wrapper">
                                <div class="currency-switch" onclick="window.toggleCurrency(event)">
                                    <span id="curr-label">JPY</span> <i class="fa-solid fa-caret-down"></i>
                                </div>
                                <div class="price-input-container">
                                    <input type="tel" id="input-price" class="machine-input" placeholder="0" oninput="window.calculateConversion(this.value)">
                                    <div class="input-subtext" id="embedded-preview">≈ TWD 0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="control-panel">
                        <div style="flex:1;"></div> <button class="print-btn" onclick="window.printReceipt()" id="print-btn">
                            <span>PRINT</span>
                        </button>
                    </div>
                </div>

                <div class="machine-bottom-lip">
                    <div class="lip-line"></div>
                </div>

                <div class="continuous-receipt-container">
                    <div class="receipt-strip" id="receipt-strip">
                        <div id="receipt-items-anchor"></div>
                        <div class="receipt-empty" id="receipt-empty">READY TO PRINT...</div>
                        
                        <div class="receipt-total-section" id="total-section">
                            <div class="total-row">
                                <span class="total-label" id="total-label">TOTAL (奎)</span>
                                <span class="total-amount" id="personal-total">¥0</span>
                            </div>
                            <div class="trip-total-row">
                                <span>TRIP TOTAL</span>
                                <span id="trip-total">¥0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-trans" class="view-section hidden">
            <div class="container">
                <div class="trans-card">
                    <h3 class="serif" style="margin-top:0; margin-bottom: 20px; color: var(--accent-main); text-align: center;">即時翻譯 (Powered by Gemini)</h3>
                    <textarea id="trans-input" class="trans-input" rows="3" placeholder="輸入中文... (例如：請問這個多少錢？)"></textarea>
                    <button class="trans-action-btn" onclick="window.translateNow()">
                        <i class="fa-solid fa-language"></i> 翻譯成日文
                    </button>
                    
                    <div id="trans-output-box" class="hidden">
                        <div style="font-size: 0.75rem; color: #888;">中文原文: <span id="trans-zh"></span></div>
                        <div id="trans-jp-result"></div>
                        
                        <button onclick="window.showFs(document.getElementById('trans-jp-result').innerText, document.getElementById('trans-zh').innerText)" style="background: transparent; border: 1px solid #CCC; color: #666; padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; margin-top: 10px; cursor: pointer; display: block; margin-left: auto;">
                            <i class="fa-solid fa-expand"></i> 全螢幕
                        </button>
                    </div>
                </div>

                <h3 class="serif" style="margin: 30px 0 15px; text-align: center; color: #888;">指差確認</h3>
                <div class="ps-grid">
                    <div class="ps-card" onclick="window.showFs('免税をお願いします。', '我想退稅 / 請問退稅櫃台在哪？')">
                        <span class="ps-icon">💰</span>
                        <div class="ps-title">退稅</div>
                    </div>
                    <div class="ps-card" onclick="window.showFs('お手洗いはどこですか？', '請問廁所在哪裡？', 'toilet')">
                        <span class="ps-icon">🚻</span>
                        <div class="ps-title">找廁所</div>
                    </div>
                    <div class="ps-card" onclick="window.showFs('レギュラー満タンでお願いします。', '你好我想要95加滿油')">
                        <span class="ps-icon">⛽</span>
                        <div class="ps-title">加油 (Regular)</div>
                    </div>
                    <div class="ps-card" onclick="window.showFs('予約しています。', '你好我有預約', 'reservation')">
                        <span class="ps-icon">📅</span>
                        <div class="ps-title">我有預約</div>
                    </div>
                    <div class="ps-card" onclick="window.showFs('お会計をお願いします。', '麻煩結帳', 'checkout')">
                        <span class="ps-icon">💳</span>
                        <div class="ps-title">結帳</div>
                    </div>
                    <div class="ps-card" onclick="window.showFs('これを 1 個ください。', '我要這個', 'quantity')">
                        <span class="ps-icon">👉</span>
                        <div class="ps-title">我要這個</div>
                    </div>
                    <div class="ps-card" onclick="window.showFs('私は牛肉と豚肉と羊肉が食べられません。', '我不吃牛、豬、羊肉')">
                        <span class="ps-icon">🥩</span>
                        <div class="ps-title">不吃紅肉</div>
                    </div>
                    <div class="ps-card" onclick="window.showFs('助けてください！', '救命！')" style="border-color: #FFCDD2;">
                        <span class="ps-icon" style="color: var(--accent-red);">🆘</span>
                        <div class="ps-title" style="color: var(--accent-red);">緊急求救</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-info" class="view-section hidden">
            <div class="container">
                <div class="map-overview-card" style="margin-top: 20px;">
                    <h2 class="serif" style="margin-top: 0; color: var(--accent-main); font-size: 1.3rem;">旅行總覽地圖</h2>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 10px;">範圍：八戶、青森、函館、弘前</p>
                    <iframe id="trip-map-overview-iframe" class="map-iframe" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                </div>
                
                <details class="sys-summary">
                    <summary style="cursor:pointer; outline:none; list-style:none; display:flex; justify-content:space-between; align-items:center;">
                        <span class="sys-title">System Settings & Status</span>
                        <i class="fa-solid fa-chevron-down" style="font-size:0.7rem; color:#CCC;"></i>
                    </summary>
                    <div style="margin-top:15px;">
                        
                        <div class="setting-row light-theme">
                            <div class="setting-name"><div class="setting-status" id="st-sim"></div> Simulation Mode (2026)</div>
                            <button class="toggle-btn" id="tg-sim" onclick="window.toggleSetting('sim')"><i class="fa-solid fa-toggle-off"></i></button>
                        </div>
                        <input type="datetime-local" id="inp-sim-time" class="info-setting-input" onchange="window.saveApiSetting('sim_time', this.value)">

                        <div class="setting-row light-theme">
                            <div class="setting-name"><div class="setting-status" id="st-gm"></div> Google Maps</div>
                            <button class="toggle-btn" id="tg-gm" onclick="window.toggleSetting('gm')"><i class="fa-solid fa-toggle-off"></i></button>
                        </div>
                        <input type="password" id="inp-gm" class="info-setting-input" placeholder="API Key" onchange="window.saveApiSetting('gm', this.value)">

                        <div class="setting-row light-theme">
                            <div class="setting-name"><div class="setting-status" id="st-ai"></div> Gemini AI</div>
                            <button class="toggle-btn" id="tg-ai" onclick="window.toggleSetting('ai')"><i class="fa-solid fa-toggle-off"></i></button>
                        </div>
                        <input type="password" id="inp-ai" class="info-setting-input" placeholder="API Key" onchange="window.saveApiSetting('ai', this.value)">

                        <div class="setting-row light-theme">
                            <div class="setting-name"><div class="setting-status" id="st-ex"></div> Exchange Rate API</div>
                            <button class="toggle-btn" id="tg-ex" onclick="window.toggleSetting('ex')"><i class="fa-solid fa-toggle-off"></i></button>
                        </div>

                        <div class="setting-row light-theme">
                            <div class="setting-name"><div class="setting-status" id="st-wt"></div> Weather Feed</div>
                            <button class="toggle-btn" id="tg-wt" onclick="window.toggleSetting('wt')"><i class="fa-solid fa-toggle-off"></i></button>
                        </div>

                        <div class="setting-row light-theme">
                            <div class="setting-name"><div class="setting-status" id="st-fb"></div> Firebase DB</div>
                        </div>

                    </div>
                </details>

                <div class="wallet-card">
                    <h2 class="serif" style="margin-top: 0; color: var(--accent-main);">重要資訊彙整</h2>
                    <p style="color: #666; font-size: 0.9rem;">緊急時刻與通關必備</p>
                </div>
                <div class="info-card" onclick="window.open('https://vjw-lp.digital.go.jp/zh-hant/', '_blank')">
                    <div style="display:flex; align-items:center;">
                        <div class="info-icon" style="background: #FFF3E0; color: #E65100;"><i class="fa-solid fa-passport"></i></div>
                        <div class="info-text">
                            <h3>Visit Japan Web</h3>
                            <p>入境審查 & 海關申報 QR Code</p>
                        </div>
                    </div>
                    <i class="fa-solid fa-chevron-right" style="color:#CCC;"></i>
                </div>
                <div class="info-card" onclick="window.location.href='tel:110'">
                    <div style="display:flex; align-items:center;">
                        <div class="info-icon" style="background: #FFEBEE; color: #D32F2F;"><i class="fa-solid fa-shield-halved"></i></div>
                        <div class="info-text">
                            <h3>日本報警 110</h3>
                            <p>遇到事故或犯罪時</p>
                        </div>
                    </div>
                    <i class="fa-solid fa-phone" style="color:var(--accent-red);"></i>
                </div>
                <div class="info-card" onclick="window.location.href='tel:119'">
                    <div style="display:flex; align-items:center;">
                        <div class="info-icon" style="background: #FFEBEE; color: #D32F2F;"><i class="fa-solid fa-truck-medical"></i></div>
                        <div class="info-text">
                            <h3>火警/救護車 119 </h3>
                            <p>急病或受傷時</p>
                        </div>
                    </div>
                    <i class="fa-solid fa-phone" style="color:var(--accent-red);"></i>
                </div>
                <div class="info-card" onclick="window.location.href='tel:+81-11-222-2930'">
                    <div style="display:flex; align-items:center;">
                        <div class="info-icon" style="background: #E3F2FD; color: #1565C0;"><i class="fa-solid fa-building-flag"></i></div>
                        <div class="info-text">
                            <h3>駐日代表處 (札幌分處)</h3>
                            <p>北海道/青森緊急聯絡: +81-11-222-2930</p>
                        </div>
                    </div>
                    <i class="fa-solid fa-phone" style="color:#1565C0);"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="glass-nav">
        <div class="nav-btn active" onclick="window.switchView('trip', this)">
            <i class="fa-solid fa-map-location-dot"></i>
        </div>
        <div class="nav-btn" onclick="window.switchView('wallet', this)">
            <i class="fa-solid fa-wallet"></i>
        </div>
        <div class="nav-btn" onclick="window.switchView('trans', this)">
            <i class="fa-solid fa-comments"></i>
        </div>
        <div class="nav-btn" onclick="window.switchView('info', this)">
            <i class="fa-solid fa-circle-info"></i>
        </div>
    </div>

    <div class="modal-overlay" onclick="window.closeModal()"></div>
    <div class="modal-full" id="detail-modal">
        <div style="position: sticky; top: 0; padding: 10px; text-align: right; z-index: 10;">
            <button onclick="window.closeModal()" style="background: white; border: none; width: 36px; height: 36px; border-radius: 50%; box-shadow: 0 2px 10px rgba(0,0,0,0.1); color: #333;"><i class="fa-solid fa-times"></i></button>
        </div>
        <img src="" id="m-img" class="modal-header-img" onerror="this.onerror=null; this.src='https://placehold.co/800x600?text=No+Image';">
        <div class="modal-content">
            <span id="m-tag" style="font-size: 0.7rem; letter-spacing: 2px; color: var(--accent-gold); text-transform: uppercase;">TAG</span>
            <h2 id="m-title" class="serif" style="font-size: 1.8rem; margin: 5px 0 20px 0; line-height: 1.2;">Title</h2>
            
            <div id="m-map-section" style="background: #F0F4F8; padding: 15px; border-radius: 8px; margin-top: 20px; display: flex; justify-content: space-between; align-items: center;" class="hidden">
                <div>
                    <div style="font-size: 0.7rem; color: #666; letter-spacing: 1px;">NAVIGATE (MAPCODE)</div>
                    <div id="m-mapcode" style="font-family: monospace; font-size: 1.2rem; font-weight: 700; color: var(--accent-main);">--</div>
                </div>
                <button onclick="window.copyMapCode()" style="background: var(--accent-main); color: white; border: none; padding: 8px 15px; border-radius: 4px;">複製</button>
            </div>
            
            <div id="m-gmap-preview" class="hidden" style="margin-top: 20px; text-align: center;">
                <iframe id="m-gmap-iframe" class="map-iframe" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
                    <button onclick="window.openExternalMap()" style="background: #333; color: white; padding: 8px 15px; border-radius: 4px; border: none; cursor: pointer;"><i class="fa-solid fa-map-location-dot"></i> Google 地圖開啟</button>
                    <button id="btn-navigate" class="hidden" onclick="window.openNavigation()" style="background: #4285F4; color: white; padding: 8px 15px; border-radius: 4px; border: none; cursor: pointer;"><i class="fa-solid fa-diamond-turn-right"></i> 開始導航</button>
                </div>
            </div>

            <div id="m-detail-info" class="hidden info-group"></div>

            <div style="margin-top: 25px;">
                <div style="display:flex; align-items:center; margin-bottom: 10px; border-bottom: 1px solid #EEE; padding-bottom: 5px;">
                    <h3 class="serif" style="font-size: 1.2rem; margin: 0; color: var(--accent-main);">導遊筆記 / Local Insight</h3>
                    <i class="fa-regular fa-snowflake snowflake-icon" onclick="window.toggleEditNote()"></i>
                </div>
                <div id="m-desc" style="font-size: 1rem; line-height: 1.8; color: #555; white-space: pre-wrap; display: block;">Description</div>
                <div id="m-note-edit" class="hidden">
                    <textarea id="m-note-input" class="note-edit-area" rows="6"></textarea>
                    <div style="text-align: right;"><button class="note-save-btn" onclick="window.saveNote()">儲存筆記</button></div>
                </div>
            </div>
        </div>
    </div>

    <div id="fs-text-modal" onclick="if(event.target === this) window.closeFs()">
        <div class="fs-jp" id="fs-jp">--</div>
        <div class="fs-cn" id="fs-cn">--</div>
        <div id="fs-controls"></div>
        <div class="fs-close" style="position: absolute; bottom: 50px; color: #999; font-size: 0.9rem;">點擊背景關閉</div>
    </div>
    
    <div id="app-message">訊息</div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, serverTimestamp, setDoc, doc, deleteDoc, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // 1. CONFIGURATION (隱私設定集中區)
        // ==========================================
        const App = {
            Config: {
                DEFAULT_GOOGLE_KEY: "AIzaSyAX9nvh4bJpiM6-oTm8FoUSZeSBpxZBc1E", 
                DEFAULT_GEMINI_MODEL: 'gemini-2.5-flash-preview-09-2025',
                TRANSLATE_URL: `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`,
                TRIP_START_DATE: "2026-02-02",
                EXCHANGE_RATE_API: 'https://api.exchangerate-api.com/v4/latest/JPY',
                
                // Dynamic Settings stored in localStorage
                settings: {
                    gm: { enabled: true, key: "" },
                    ai: { enabled: true, key: "" },
                    ex: { enabled: true, manual: 0.22 },
                    wt: { enabled: true },
                    sim: { enabled: false, time: "" } // Simulation Mode
                }
            },
            State: {
                db: null, auth: null, expensesRef: null, notesRef: null, todosRef: null, memosRef: null,
                currentDayIndex: 0, localNotes: {}, currentEventId: null, currentNavLink: null, isAnimating: false,
                rate: 0.22, isOnline: false, receiptCount: 1, receiptsData: [], receiptsCache: { spend:[], todo:[], memo:[] }, 
                currentUser: '奎', isTopFeedExpanded: false, currentCurrency: 'JPY', currentMode: 'spend',
                currentQuantity: 1,
                checkoutState: { pay: '現金', split: '一起' } // For translate combination
            },
            Data: {
                Trip: [
                    { day: 1, date: "02.02", week: "MON", heroTitle: "函館：百元發熱衣與百萬夜景", heroImg: "https://i.imgur.com/RTJNqwv.jpg", fallbackImg: "https://images.unsplash.com/photo-1542640244-7e67286feb8f?q=80&w=800&auto=format&fit=crop", weather: { icon: "fa-spinner fa-spin", temp: "Loading..." }, events: [ { time: "11:10", title: "抵達 函館機場 (HKD)", tag: "Arrival", desc: "入境與準備。", detail: "【導遊筆記】函館機場雖小，但冬季運作非常有秩序。下機後的體感溫差會讓您瞬間清醒。入境審查通常很快，出關後，別急著離開，深呼吸一口北國冷冽的空氣，這就是北海道的味道。", to: "JR 函館站", location: "Hakodate Airport, Japan" }, { time: "12:00", title: "機場巴士 (往 JR 函館站)", tag: "Transport", desc: "移動至市區。", detail: "【導遊筆記】上車時請注意，日本巴士是「後門上車、前門下車」。沿途您會看到著名的「湯之川溫泉」區，若看到海邊有冒煙的景象，那就是溫泉流進海裡的證明。", navLink: "https://maps.app.goo.gl/SgEccLta3MTxhD4d9?g_st=ac", from: "Hakodate Airport", to: "JR Inn Hakodate", transport_info: {type: "機場巴士", departure: "12:00"} }, { time: "12:30", title: "JR Inn Hakodate (寄放)", tag: "Hotel", desc: "寄放行李。", detail: "【導遊筆記】選擇這間飯店是絕對正確的戰略！它與車站直結，不用拖著行李在雪地裡掙扎。寄放行李時，請順便確認一下大廳提供的「枕頭挑選區」，晚上下手太慢就被搶光了。", location: "JR Inn Hakodate", navLink: "https://maps.app.goo.gl/SgEccLta3MTxhD4d9?g_st=ac", to: "JR Inn Hakodate" }, { time: "12:50", title: "計程車 (趕時間首選)", tag: "Transport", desc: "前往 UNIQLO。", detail: "【導遊筆記】為了省下寶貴的 30-40 分鐘，這 2,500 日圓的車資絕對值得。去 UNIQLO 昭和店的巴士班次在離峰時間很稀疏。", navLink: "https://maps.app.goo.gl/s85bmZtawnf7EQY26?g_st=ac", from: "JR Inn Hakodate", to: "UNIQLO 函館昭和店", transport_info: { type: "計程車", note: "約2500日圓" } }, { time: "13:15", title: "任務 1：UNIQLO 昭和店", tag: "Shopping", desc: "採購發熱衣。", detail: "【導遊筆記】這是北海道的大型路面店，庫存通常比市區百貨店齊全。務必入手「超極暖 (Ultra Warm)」系列的發熱衣與發熱褲，這是為了全世界降雪量最大的青森做做的必要準備。", navLink: "https://maps.app.goo.gl/sDqtgs3kxsz7nGKU9", location: "UNIQLO Hakodate Showa" }, { time: "14:45", title: "計程車 (返回飯店卸貨)", tag: "Transport", desc: "回 JR Inn。", detail: "【導遊筆記】既然買了很多，我們直接搭車回 JR Inn。把戰利品丟回房間（或櫃台），一身輕便再出門。飯店門口排班計程車多，對接下來的行程更方便。", transport_info: { type: "計程車", note: "返回飯店" }, from: "UNIQLO 函館昭和店", to: "JR Inn Hakodate" }, { time: "15:15", title: "飯店卸貨 & 稍作整裝", tag: "Hotel", desc: "快速整裝。", detail: "【導遊提醒】動作要快，放好東西、上個廁所，15:30 準時出發，才趕得上夜景的最佳卡位時間。", location: "JR Inn Hakodate" }, { time: "15:30", title: "計程車 (前往纜車站)", tag: "Transport", desc: "JR 函館站 -> 纜車山麓站。", detail: "【行程】約 10-15 分鐘車程。", transport_info: { type: "計程車", note: "往纜車站" }, from: "JR Inn Hakodate", to: "Hakodate Ropeway" }, { time: "16:00", title: "函館山百萬夜景", tag: "Sightseeing", desc: "日落 Blue Hour。", detail: "【導遊筆記】冬天的日落約在 16:50。一定要待到日落後 20-30 分鐘，這時天空呈現深藍色 (Blue Hour)。記得帶暖暖包貼在手機背面。<br><br>【老鳥說故事】<br>函館夜景被稱為「百萬夜景」的關鍵在於絕無僅有的「地理奇蹟」。左邊是「津輕海峽」，右邊是「函館灣」，這兩片漆黑的大海將發光的城市夾在中間，形成了一個像是女性纖細腰身的形狀（扇形海峽）。冬天的夜景因為雪地反射，亮度提升了 30% 以上。", navLink: "https://maps.app.goo.gl/qcq17CBzd3miW9rM6", location: "Mt. Hakodate Observation Deck", nav: { mapcode: "86 041 028*25" } }, { time: "17:30", title: "纜車下山 -> 前往金森倉庫", tag: "Transport", desc: "步行或計程車。", detail: "【導遊筆記】下山時人潮會瞬間爆發。如果纜車排隊超過 30 分鐘，且戶外風雪不大，其實可以考慮搭乘巴士下山。下山後，金森倉庫就在山腳下不遠處。", transport_info: { type: "纜車/步行" }, to: "Kanemori Red Brick Warehouse" }, { time: "18:00", title: "金森紅磚倉庫群", tag: "Sightseeing", desc: "晚餐：幸運小丑漢堡。", detail: "【導遊筆記】這裡的紅磚在白雪覆蓋下，有一種歐洲聖誕市集的氛圍。著名的「幸運小丑漢堡」碼頭末廣店，座位數多且有無敵海景。強烈建議現在就吃！點人氣 No.1 的「中華雞腿漢堡」。", navLink: "https://maps.app.goo.gl/psd5nq2yRDC5zD3W6", location: "Kanemori Red Brick Warehouse" }, { time: "18:15", title: "Pastry Snaffle's", tag: "Food", desc: "金森洋物館店。", detail: "【導遊筆記】抵達倉庫後請先衝這裡！買一顆「Catch Cake (起司歐姆蕾)」，這不是普通起司蛋糕，口感像舒芙蕾般入口即化。不要買整盒，直接在櫃台買單顆站著現吃，這是函館限定的「黃金一口」。", location: "Pastry Snaffle's Kanemori" }, { time: "19:30", title: "返回飯店", tag: "Transport", desc: "散步或計程車。", detail: "【導遊筆記】吃飽後，沿著海邊或搭車回飯店。", transport_info: { type: "計程車/散步" }, to: "JR Inn Hakodate" }, { time: "20:00", title: "休息與大浴場", tag: "Hotel", desc: "JR Inn Hakodate。", detail: "【導遊筆記】經過寒風吹拂，現在最需要的是熱食與熱水。直奔頂樓大浴場，那裡的休息室有一整面的落地窗可以看到列車進出站的軌道夜景，配上一支冰牛奶，這才是完美的 Ending。", location: "JR Inn Hakodate" } ] },
                    { day: 2, date: "02.03", week: "TUE", heroTitle: "新幹線跨海，拜訪奈良美智", heroImg: "https://i.imgur.com/iqO53uS.jpg", fallbackImg: "https://images.unsplash.com/photo-1532236395709-7d70320fec2d?q=80&w=800", weather: { icon: "fa-spinner fa-spin", temp: "Loading..." }, events: [ { time: "07:30", title: "函館朝市 早餐", tag: "Food", desc: "釣烏賊體驗。", detail: "【導遊筆記】雖然說是觀光客聖地，但「釣烏賊」體驗真的很有趣，現釣現殺的烏賊肉是透明且爽脆的，完全沒有腥味。", location: "Hakodate Morning Market" }, { time: "09:30", title: "步行回飯店取行李", tag: "Transport", desc: "前往車站。", detail: "【導遊筆記】吃飽喝足散步回飯店拿行李。", from: "Hakodate Morning Market", to: "JR Hakodate Station", transport_info: { type: "步行" } }, { time: "10:00", title: "跨海移動：函館 -> 青森", tag: "Transport", desc: "三段式接力。", detail: "【導遊筆記】這是今天的重頭戲！<br>1. 函館 Liner：普通電車，搶窗邊位置看最後風景。<br>2. 新幹線隼號：全車指定席！鑽進「青函隧道」時會有廣播，這時您正位於深海之下。<br>3. 奧羽本線：抵達新青森後轉乘在來線，6分鐘到市區。", transport_info: { type: "JR/新幹線", departure: "10:00", note: "青函隧道" }, from: "JR Hakodate Station", to: "JR Aomori Station" }, { time: "12:15", title: "午餐：青森站周邊", tag: "Food", desc: "Osanai 食堂。", detail: "【導遊筆記】「Osanai (おさない)」是這裡的傳奇食堂，必點「帆立貝味噌燒」。", location: "Osanai Aomori" }, { time: "13:30", title: "計程車 (直奔美術館)", tag: "Transport", desc: "前往美術館。", detail: "【導遊筆記】不建議搭巴士，班距長。計程車費約 2000 多日圓。", transport_info: { type: "計程車" }, from: "JR Aomori Station", to: "Aomori Museum of Art" }, { time: "14:00", title: "青森縣立美術館", tag: "Sightseeing", desc: "奈良美智與青森犬。", detail: "【導遊筆記】這座美術館本身就是一件藝術品。一定要去看奈良美智的「青森犬」，冬天時工作人員會幫大狗戴上一頂「雪帽」！<br><br>【老鳥說故事】<br>美術館的設計理念非常深奧，它是由知名建築師青木淳所設計的。整座美術館並不是「蓋在地上」，而是「埋在土裡」的（靈感來自三內丸山遺跡的壕溝 Trench）。在館內行走像是在探險。那隻巨大的「青森犬」低著頭，在雪地中顯得特別孤獨卻又療癒。", location: "Aomori Museum of Art" }, { time: "16:00", title: "計程車 (前往 A-FACTORY)", tag: "Transport", desc: "前往港邊。", detail: "【導遊筆記】直接請美術館櫃檯叫車前往青森車站旁的 A-FACTORY。", transport_info: { type: "計程車" }, from: "Aomori Museum of Art", to: "A-FACTORY" }, { time: "16:30", title: "A-FACTORY (蘋果工廠)", tag: "Shopping", desc: "Cidre 試喝。", detail: "【導遊筆記】傍晚點燈後的氣氛極佳。這裡可以慢慢試喝不同濃度的 Cidre (蘋果酒)。<br><br>【老鳥說故事】<br>A-FACTORY 是青森蘋果的「文藝復興」。這棟在海邊發光的房子，代表青森從單純的「農業大縣」華麗轉身為「時尚品牌」。當您喝下那杯蘋果酒，您喝下的不只是酒，而是青森人為了生存與榮耀，在傳統中淬鍊出的新滋味。", location: "A-FACTORY" }, { time: "17:00", title: "ラグノオ (Raguenau)", tag: "Food", desc: "Polo Chocolat。", detail: "【導遊筆記】就在 A-FACTORY 賣場裡。雖然到處都有賣，但它是青森在地廠商做的，口感紮實濃郁，CP 值極高。", location: "A-FACTORY" }, { time: "17:30", title: "取行李 -> 計程車", tag: "Transport", desc: "前往飯店。", transport_info: { type: "計程車" }, to: "Dormy Inn Aomori" }, { time: "18:00", title: "入住 Dormy Inn Aomori", tag: "Hotel", desc: "換上館內服。", detail: "【導遊筆記】進房後先換上他們提供的舒適館內服 (Samue)，這套衣服可以穿著去吃早餐、泡溫泉甚至吃宵夜。", location: "Dormy Inn Aomori" }, { time: "19:00", title: "晚餐：青森市區", tag: "Food", desc: "津輕三味線演奏。", detail: "【導遊筆記】晚餐推薦去體驗「津輕三味線」的現場演奏。居酒屋「助六」或「Wasshoi」氣氛都很熱鬧。", location: "Aomori City Center" }, { time: "21:30", title: "飯店宵夜", tag: "Food", desc: "夜鳴拉麵。", detail: "【導遊筆記】絕對不能錯過的「夜鳴拉麵」！", location: "Dormy Inn Aomori" } ] },
                    { day: 3, date: "02.04", week: "WED", heroTitle: "雪地駕駛初體驗，暖爐列車與蘋果派", heroImg: "https://i.imgur.com/M2AVCI5.jpg", fallbackImg: "https://images.unsplash.com/photo-1549643276-fbc2bd5f4038?q=80&w=800&auto=format&fit=crop", weather: { icon: "fa-spinner fa-spin", temp: "Loading..." }, events: [ { time: "08:30", title: "步行至租車點", tag: "Transport", desc: "小心黑冰。", detail: "【導遊筆記】早上路面可能會有「黑冰 (Black Ice)」，看起來像濕潤的路面其實是薄冰，走路千萬要小心。", transport_info: { type: "步行" }, to: "Aomori Station Rental Car" }, { time: "09:00", title: "租車：青森站前", tag: "Transport", desc: "自駕開始。", detail: "【導遊筆記】取車關鍵動作：1. 確認雨刷立起。2. 檢查雪胎。3. 詢問油箱蓋位置。雪地駕駛心法：急煞車、急加速、急轉彎是絕對禁止的。", transport_info: { type: "自駕", car_type: "雪地裝備確認" }, from: "Aomori Rental Car", to: "Goshogawara" }, { time: "10:00", title: "移動：往五所川原", tag: "Drive", desc: "適應雪地駕駛。", detail: "【導遊筆記】剛上路的前 20 分鐘最緊張，請慢慢開，習慣雪地輪胎的抓地力。", transport_info: { type: "自駕" } }, { time: "10:30", title: "超商補給", tag: "Food", desc: "炸干貝美乃滋飯糰。", detail: "【導遊筆記】在開車途中若經過 Lawson 或 FamilyMart，進去早餐區找找看。青森限定的飯糰常會豪邁地包入「整顆帆立貝」拌美乃滋。", location: "Convenience Store" }, { time: "11:00", title: "任務 2：ELM 購物中心", tag: "Shopping", desc: "3COINS+plus。", detail: "【導遊筆記】直奔 3COINS+plus，這裡有很多便宜又好用的雪地小物。", nav: { mapcode: "168 649 346*52" }, location: "ELM Shopping Center" }, { time: "11:45", title: "抵達 津輕五所川原站", tag: "Drive", desc: "停車禮儀。", detail: "【導遊筆記】停好車後，記得把雨刷立起來，這是雪國禮儀。", location: "Tsugaru Goshogawara Station" }, { time: "12:00", title: "任務 3：津輕鐵道「暖爐列車」", tag: "Experience", desc: "烤魷魚與昭和感。", detail: "【導遊筆記】這是昭和時代的活古董！車廂內是真的燒煤炭的暖爐。上車後一定要買烤魷魚，列車長會幫你在暖爐上現烤。<br><br>【老鳥說故事】<br>這列火車是一台行駛在雪原上的「時光機」。外頭是零下幾度的暴風雪，車內卻因為那個燒著紅通通煤炭的「達摩火爐」而溫暖如春。文豪「太宰治」生前也搭過。當列車長把乾魷魚放在火爐頂蓋上「滋～」的一聲，配上一杯清酒，那種「赤裸裸的昭和感」會讓您感動。", location: "Tsugaru Railway" }, { time: "13:30", title: "移動：往弘前", tag: "Drive", desc: "津輕富士。", detail: "【導遊筆記】前往弘前的路上，若天氣晴朗，左手邊會出現壯麗的「岩木山」，被稱為津輕富士。", transport_info: { type: "自駕" }, to: "Hirosaki" }, { time: "14:30", title: "任務 4：藤田紀念庭園", tag: "Food", desc: "大正浪漫喫茶室。", detail: "【導遊筆記】這裡原本是富豪的別墅，洋館建築非常有氣氛。一定要搶窗邊的位置，看著雪覆蓋的日式庭園吃甜點。", nav: { mapcode: "71 071 513*78" }, location: "Fujita Memorial Garden" }, { time: "14:45", title: "星巴克 弘前公園前店", tag: "Sightseeing", desc: "最美星巴克之一。", detail: "【導遊筆記】如果喫茶室大排長龍，這裡是最強備案。它是利用「舊第八師團長官舍」改建的，保留了大正時代的洋風建築特色。", location: "Starbucks Hirosaki Park" }, { time: "15:45", title: "弘前城 (弘前公園)", tag: "Sightseeing", desc: "雪燈籠。", detail: "【導遊筆記】冬天的弘前城雖然天守閣可能會移動，但重點是「雪燈籠」。", location: "Hirosaki Castle" }, { time: "16:30", title: "移動：返回青森市", tag: "Drive", desc: "國道 7 號。", detail: "【導遊筆記】弘前到青森的國道 7 號非常容易塞車，請預留充裕時間。", transport_info: { type: "自駕" }, to: "Aomori City" }, { time: "18:00", title: "晚餐：青森市區", tag: "Food", desc: "味噌咖哩牛奶拉麵。", detail: "【導遊筆記】今晚推薦嘗試青森市的靈魂美食「味噌咖哩牛奶拉麵」。", location: "Aomori City Center" } ] },
                    { day: 4, date: "02.05", week: "THU", heroTitle: "勇闖八甲田，入住星野青森屋", heroImg: "https://i.imgur.com/xOsZDUG.jpg", fallbackImg: "https://images.unsplash.com/photo-1487667258413-5a089052b658?q=80&w=800", alert: "⚠️ 雪地駕駛警示：八甲田山路段積雪極深，請注意路面上方紅箭頭指標！", weather: { icon: "fa-spinner fa-spin", temp: "Loading..." }, events: [ { time: "08:00", title: "青森魚菜中心 (古川市場)", tag: "Food", desc: "自製海鮮丼。", detail: "【導遊筆記】這是最有趣的早餐體驗！拿著碗去各攤位「選妃」。一定要試試看青森特產「扇貝」。", location: "Furukawa Market" }, { time: "09:30", title: "開車上山：往八甲田", tag: "Drive", desc: "雪牆路段。", detail: "【導遊筆記】全行程最危險路段！隨著海拔升高，路旁積雪會變成兩三公尺高的雪牆。請務必注意路面上方的「紅箭頭」指標。", transport_info: { type: "自駕" }, from: "Aomori City", to: "Hakkoda Ropeway" }, { time: "10:30", title: "八甲田山樹冰 (纜車)", tag: "Nature", desc: "雪怪 (Ice Monsters)。", detail: "【導遊筆記】這裡的樹冰比藏王更原始、更狂野。搭纜車到山頂後，您會置身於冰封世界。<br><br>【老鳥說故事】<br>您即將見到的不只是樹和雪，而是大自然雕塑出的「雪怪」。樹冰形成需要三個奇蹟：1. 大量的「青森冷杉」；2. 來自西伯利亞的季風與過冷水滴；3. 氣溫持續低於零下 5 度。八甲田山的樹冰規模宏大，看著成千上萬隻「雪怪」沿著山坡排山倒海而來，那種震懾感與敬畏心油然而生。", location: "Hakkoda Ropeway" }, { time: "12:00", title: "午餐：纜車站食堂", tag: "Food", desc: "蕎麥麵或咖哩。", location: "Hakkoda Ropeway Station" }, { time: "12:45", title: "酸湯溫泉 (Sukayu Onsen)", tag: "Sightseeing", desc: "千人風呂外觀。", detail: "【導遊筆記】即使不進去泡，光是把車停下來，看那棟全檜木建造的古老建築，以及屋頂上厚達 3-4 公尺的驚人積雪，就非常值得。", location: "Sukayu Onsen" }, { time: "13:00", title: "移動：前往星野青森屋", tag: "Drive", desc: "導航設定注意。", detail: "【導遊筆記】導航陷阱警告！請務必設定經由「陸奧收費道路」往三澤方向。", transport_info: { type: "自駕", time_estimate: "2小時" }, to: "Hoshino Resorts Aomoriya" }, { time: "15:30", title: "入住：星野集團 青森屋", tag: "Hotel", desc: "祭典主題樂園。", detail: "【導遊筆記】歡迎來到祭典的主題樂園！一進門就會有服務員遞上迎賓蘋果汁。", nav: { mapcode: "84 583 002*44" }, reservation_info: { type: "Resort", number: "HOS-AOM-1234", name: "YK", check_in: "15:30" }, location: "Hoshino Resorts Aomoriya" }, { time: "17:00", title: "晚餐：Nore Sore 食堂", tag: "Food", desc: "媽媽的味道。", detail: "【導遊筆記】一定要進攻「現煎牛排」和「炸扇貝」。", location: "Nore Sore Dining" }, { time: "19:00", title: "溫泉：浮湯", tag: "Relax", desc: "露天溫泉。", detail: "【導遊筆記】這裡的露天溫泉設計得像漂浮在水池上。泡在熱湯裡，看著燈光映照在雪地上，夢幻指數破表。", location: "Aomoriya Onsen" } ] },
                    { day: 5, date: "02.06", week: "FRI", heroTitle: "馬車巡遊與輕鬆滑雪", heroImg: "https://i.imgur.com/ViOh2sW.jpg", fallbackImg: "https://images.unsplash.com/photo-1548777123-e213912bc571?q=80&w=800", weather: { icon: "fa-spinner fa-spin", temp: "Loading..." }, events: [ { time: "07:30", title: "Nore Sore 食堂 早餐", tag: "Food", desc: "自製海鮮丼。", detail: "【導遊筆記】早餐的亮點是「帆立貝味噌燒」和「自製海鮮丼」。", location: "Nore Sore Dining" }, { time: "09:00", title: "暖爐馬車 (需預約)", tag: "Experience", desc: "津輕方言導覽。", detail: "【導遊筆記】坐在有暖爐的馬車裡，馬夫會一邊趕馬一邊用津輕方言聊天。", location: "Aomoriya Park" }, { time: "11:00", title: "移動：前往滑雪場", tag: "Drive", desc: "莫蘭之森。", detail: "【導遊筆記】附近的「莫蘭之森 (Komaki Onsen Ski Area)」是個小而美的滑雪場，人通常不多。", transport_info: { type: "自駕" }, to: "Komaki Onsen Ski Area" }, { time: "11:30", title: "滑雪體驗", tag: "Activity", desc: "粉雪體驗。", detail: "【導遊筆記】即使不滑雪，租個雪盆 (Sled) 來玩也超開心！這裡的雪質是粉雪 (Powder Snow)。", location: "Komaki Onsen Ski Area" }, { time: "15:30", title: "移動：返回飯店", tag: "Drive", desc: "回溫。", detail: "【導遊筆記】玩雪後身體會濕冷，回到飯店第一件事就是直奔「元湯」或再次去「浮湯」回溫。", transport_info: { type: "自駕" }, to: "Hoshino Resorts Aomoriya" }, { time: "16:00", title: "歡騰廣場", tag: "Relax", desc: "Jawamegu Hiroba。", detail: "【導遊筆記】位於飯店地下樓層的廣場，永遠都在過節。", location: "Jawamegu Hiroba" }, { time: "18:00", title: "晚餐", tag: "Food", desc: "飯店內。", location: "Hoshino Resorts Aomoriya" }, { time: "20:00", title: "陸奧祭典屋", tag: "Culture", desc: "睡魔祭表演。", detail: "【導遊筆記】絕對必看！如果這趟旅程只能選一個表演，就是這個。<br><br>【老鳥說故事】<br>為什麼青森人對「祭典」這麼瘋狂？因為這裡的冬天太長、太冷、太黑了。睡魔祭 (Nebuta) 的原意是趕走夏日農忙時期的睡魔與災厄，但我認為，這更是喚醒人們靈魂的儀式。在陸奧祭典屋，您將聽到撼動心臟的太鼓聲，與「Rassera!」的吶喊。這不只是一場秀，這是青森人在宣告：「我們熬過了冬天，我們還活著！」", location: "Michinoku Matsuriya" } ] },
                    { day: 6, date: "02.07", week: "SAT", heroTitle: "踏著雪花滿載而歸", heroImg: "https://i.imgur.com/edlDbD7.jpg", fallbackImg: "https://images.unsplash.com/photo-1436491865332-7a61a109cc05?q=80&w=800", weather: { icon: "fa-spinner fa-spin", temp: "Loading..." }, events: [ { time: "08:00", title: "最後享受：早餐/溫泉", tag: "Relax", desc: "推薦元湯。", detail: "【導遊筆記】離別前的最後一泡。推薦去飯店園區入口處的「元湯」。", location: "Aomoriya Motoyu" }, { time: "10:00", title: "移動：前往青森機場", tag: "Drive", desc: "準時出發。", detail: "【導遊筆記】最後一次提醒：冬季趕飛機，寧可早到三小時，不可晚到一分鐘。", transport_info: { type: "自駕", time_estimate: "2.5小時" }, from: "Hoshino Resorts Aomoriya", to: "Aomori Airport" }, { time: "12:00", title: "機場周邊：午餐/加油", tag: "Food", desc: "加滿油。", detail: "【導遊筆記】進機場前最後一項任務：加滿油。", location: "Aomori Airport Area" }, { time: "12:30", title: "青森機場還車", tag: "Transport", desc: "檢查車況。", detail: "【導遊筆記】還車時，工作人員會檢查外觀。", location: "Aomori Airport Car Rental" }, { time: "13:00", title: "機場報到 (AOJ)", tag: "Transport", desc: "辦理登機。", detail: "【導遊筆記】青森機場小而美。", location: "Aomori Airport" }, { time: "13:30", title: "最後採買", tag: "Shopping", desc: "機場 2F 免稅店。", detail: "【導遊筆記】這裡是最後衝刺區！必買整顆蘋果、Patissier's 蘋果派、源垂燒肉醬。", location: "Aomori Airport Duty Free" }, { time: "15:30", title: "搭機返台", tag: "Flight", desc: "BR 121。", detail: "【導遊筆記】飛機起飛時，請往下看，那片白雪覆蓋的大地、八甲田山的輪廓、陸奧灣的深藍，將是您這趟旅程最美的句點。辛苦了！", reservation_info: { type: "Flight", number: "BR121", departure: "15:30" }, location: "Aomori Airport" } ] }
                ],
                Messages: {
                    work: ["每天都在處理突發狀況，這次唯一的突發狀況，只有「食物太好吃」。","那些表格、報告、SOP 都留在台灣，行李箱只裝得下期待。","總是為了別人忙得團團轉，Day 5 的暖爐馬車是專門為你們慢下來的。","不管是鈴聲、呼叫器還是電話聲，都比不上弘前雪地裡的寂靜好聽。"],
                    evening: ["每天都在講話安撫別人，去金森紅磚倉庫時，我們試著安靜地看著夕陽就好。","你的耐心餘額已不足？沒關係，函館的百萬夜景會幫你充值。"],
                    rest: ["總是聽別人的煩惱，這次換聽聽津輕海峽的海浪聲吧。","知道你肩膀很重，所以我們安排了溫泉，把那些責任都洗掉。"]
                }
            },
            Utils: {
                getPrinterDom: () => ({
                    headerDate: document.getElementById('header-date'),
                    inputItem: document.getElementById('input-item'),
                    inputPrice: document.getElementById('input-price'),
                    previewEmbed: document.getElementById('embedded-preview'),
                    printBtn: document.getElementById('print-btn'),
                    statusLight: document.getElementById('status-light'),
                    feed: document.querySelector('.paper-input-feed'),
                    feedWrapper: document.getElementById('feed-scroll-wrapper'),
                    listAnchor: document.getElementById('receipt-items-anchor'),
                    listEmpty: document.getElementById('receipt-empty'),
                    totalLabel: document.getElementById('total-label'),
                    totalPersonal: document.getElementById('personal-total'),
                    totalTrip: document.getElementById('trip-total'),
                    topTotalAmt: document.getElementById('top-total-amount'),
                    topTotalSub: document.getElementById('top-total-sub'),
                    rateValue: document.getElementById('rate-value'),
                    slotPrice: document.getElementById('slot-price'),
                    totalSection: document.getElementById('total-section'),
                    settingsPanel: document.getElementById('settings-panel')
                }),
                showToast: (message) => {
                    const toast = document.getElementById('app-message');
                    toast.innerText = message;
                    toast.classList.add('show');
                    setTimeout(() => toast.classList.remove('show'), 3000);
                },
                vibrate: (ms) => {
                    if (navigator.vibrate) {
                        navigator.vibrate(ms);
                    }
                },
                getFormattedTime: () => {
                    let now;
                    if (App.Config.settings.sim && App.Config.settings.sim.enabled) {
                        if (App.Config.settings.sim.time) {
                            now = new Date(App.Config.settings.sim.time);
                        } else {
                            now = new Date("2026-02-02T16:05:00");
                        }
                    } else {
                        now = new Date();
                    }
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    return `${year}.${month}.${day} ${hours}:${minutes}`;
                },
                fetchRetry: async (url, options, retries = 3) => {
                    for (let i = 0; i < retries; i++) {
                        try {
                            const response = await fetch(url, options);
                            if (response.status === 429) { 
                                await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000 + Math.random() * 1000));
                                continue;
                            }
                            if (!response.ok) throw new Error(`API failed: ${await response.text()}`);
                            return response;
                        } catch (error) {
                            if (i === retries - 1) throw error; 
                            await new Promise(r => setTimeout(r, Math.pow(2, i) * 1000));
                        }
                    }
                },
                getIconClass: (wmoCode) => {
                    if (wmoCode === 0) return "fa-sun";
                    if (wmoCode <= 3) return "fa-cloud-sun";
                    if (wmoCode === 45 || wmoCode === 48) return "fa-smog";
                    if (wmoCode <= 55) return "fa-cloud-rain";
                    if (wmoCode <= 65) return "fa-cloud-showers-heavy";
                    if (wmoCode <= 77) return "fa-snowflake";
                    if (wmoCode <= 82) return "fa-cloud-rain";
                    if (wmoCode <= 99) return "fa-bolt";
                    return "fa-cloud";
                },
                getMapUrl: (data) => {
                    if(!App.Config.settings.gm.enabled) return null;
                    const base = `https://www.google.com/maps/embed/v1/`;
                    const key = App.Config.settings.gm.key || App.Config.DEFAULT_GOOGLE_KEY;
                    if(!key) return null;
                    
                    if (data.location) return `${base}search?key=${key}&q=${encodeURIComponent(data.location)}`;
                    if (data.from && data.to) return `${base}directions?key=${key}&origin=${encodeURIComponent(data.from)}&destination=${encodeURIComponent(data.to)}&mode=driving`;
                    return null;
                },
                safeStringify: (obj) => encodeURIComponent(JSON.stringify(obj)).replace(/'/g, "%27"),
                createInfoItem: (icon, label, value) => !value ? '' : `<div class="info-item"><div class="info-label"><i class="fa-solid ${icon}"></i><span>${label}</span></div><div class="info-value">${value}</div></div>`,
                setDiag: (id, ok) => {
                    const el = document.getElementById(id);
                    if(el) {
                        el.className = `diag-status ${ok ? 'ok' : 'err'}`;
                    }
                }
            },
        Services: {
                Firebase: {
                    init: async () => {
                        setLogLevel('error'); 
                        try {
                            // ↓↓↓ 修改：直接填入 Firebase 設定資料 ↓↓↓
                            const configToUse = {
                                apiKey: "AIzaSyCbHhcAo25W6yDPNT05bDkxkRIrwFUM2o4", 
                                authDomain: "aomori2026-17310.firebaseapp.com",
                                projectId: "aomori2026-17310",
                                storageBucket: "aomori2026-17310.firebasestorage.app",
                                messagingSenderId: "645422415004",
                                appId: "1:645422415004:web:b8017ec6dd040d1dae4159",
                                measurementId: "G-2J6NCTHZ6B"
                            };

                            // 如果依然沒有config, 則報錯
                            if (!configToUse || Object.keys(configToUse).length === 0) {
                                console.warn("No Firebase Config found. App running in offline mode.");
                                App.Utils.setDiag('diag-fb', false);
                                return;
                            }

                            const app = initializeApp(configToUse);
                            App.State.db = getFirestore(app);
                            App.State.auth = getAuth(app);
                            
                            // 優先嘗試使用 Custom Token (系統注入)
                            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                            if (initialAuthToken) {
                                await signInWithCustomToken(App.State.auth, initialAuthToken);
                            } else {
                                await signInAnonymously(App.State.auth);
                            }

                            // 設定正確的路徑 artifacts/{appId}/public/data/...
                            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                            App.State.notesRef = collection(App.State.db, 'artifacts', appId, 'public', 'data', 'notes');
                            App.State.expensesRef = collection(App.State.db, 'artifacts', appId, 'public', 'data', 'expenses');
                            App.State.todosRef = collection(App.State.db, 'artifacts', appId, 'public', 'data', 'todos');
                            App.State.memosRef = collection(App.State.db, 'artifacts', appId, 'public', 'data', 'memos');
                            
                            App.Services.Firebase.subscribeNotes();
                            App.Services.Firebase.subscribeExpenses();
                            App.Services.Firebase.subscribeTodos();
                            App.Services.Firebase.subscribeMemos();
                            console.log("Firebase Connected Successfully");
                            App.Utils.setDiag('diag-fb', true);

                        } catch (error) {
                            console.error("Firebase Auth/Init Error:", error);
                            App.Utils.showToast("無法連線到資料庫");
                            App.Utils.setDiag('diag-fb', false);
                        }
                    },
                    subscribeExpenses: () => {
                        if (!App.State.expensesRef) return;
                        onSnapshot(query(App.State.expensesRef), (snapshot) => {
                            let isNewLocalWrite = snapshot.metadata.hasPendingWrites;
                            const newData = snapshot.docs.map(doc => {
                                const data = doc.data();
                                let dateStr = App.Utils.getFormattedTime();
                                if (data.timestamp) {
                                    const d = data.timestamp.toDate();
                                    dateStr = `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                                }
                                return { id: doc.id, type:'spend', user: data.user||'?', item: data.item||'Item', jpy: data.jpy||0, twd: data.twd||0, timestamp: data.timestamp, date: dateStr, no: "000" };
                            });
                            App.Services.Firebase.updateReceiptCache('spend', newData, isNewLocalWrite);
                        }, () => App.Utils.setDiag('diag-fb', false));
                    },
                    subscribeTodos: () => {
                        if (!App.State.todosRef) return;
                        onSnapshot(query(App.State.todosRef), (snapshot) => {
                            let isNewLocalWrite = snapshot.metadata.hasPendingWrites;
                            const newData = snapshot.docs.map(doc => {
                                const data = doc.data();
                                let dateStr = App.Utils.getFormattedTime();
                                if (data.timestamp) {
                                    const d = data.timestamp.toDate();
                                    dateStr = `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                                }
                                return { id: doc.id, type:'todo', user: data.user||'?', item: data.item||'Task', done: data.done||false, timestamp: data.timestamp, date: dateStr };
                            });
                            App.Services.Firebase.updateReceiptCache('todo', newData, isNewLocalWrite);
                        }, () => App.Utils.setDiag('diag-fb', false));
                    },
                    subscribeMemos: () => {
                        if (!App.State.memosRef) return;
                        onSnapshot(query(App.State.memosRef), (snapshot) => {
                            let isNewLocalWrite = snapshot.metadata.hasPendingWrites;
                            const newData = snapshot.docs.map(doc => {
                                const data = doc.data();
                                let dateStr = App.Utils.getFormattedTime();
                                if (data.timestamp) {
                                    const d = data.timestamp.toDate();
                                    dateStr = `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                                }
                                return { id: doc.id, type:'memo', user: data.user||'?', text: data.text||'', timestamp: data.timestamp, date: dateStr };
                            });
                            App.Services.Firebase.updateReceiptCache('memo', newData, isNewLocalWrite);
                        }, () => App.Utils.setDiag('diag-fb', false));
                    },
                    updateReceiptCache: (type, data, animate) => {
                        if(!App.State.receiptsCache) App.State.receiptsCache = { spend:[], todo:[], memo:[] };
                        App.State.receiptsCache[type] = data;
                        let all = [...App.State.receiptsCache.spend, ...App.State.receiptsCache.todo, ...App.State.receiptsCache.memo];
                        all.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                        App.State.receiptsData = all;
                        App.Controllers.Wallet.renderReceiptList(animate);
                    },
                    subscribeNotes: () => {
                        if (!App.State.notesRef) return;
                        onSnapshot(query(App.State.notesRef), (snap) => {
                            snap.docs.forEach(doc => { App.State.localNotes[doc.id] = doc.data().text; });
                            if(App.State.currentEventId) App.Controllers.Trip.updateModalNoteContent();
                        });
                    },
                    deleteItem: (id, type) => {
                        const el = document.getElementById(`entry-${id}`);
                        if(el) el.classList.add('tearing');
                        App.Utils.vibrate(80); // Vibrate on delete
                        let ref = App.State.expensesRef;
                        if(type === 'todo') ref = App.State.todosRef;
                        if(type === 'memo') ref = App.State.memosRef;
                        if (ref) {
                            setTimeout(() => deleteDoc(doc(ref, id)).catch(e => console.error(e)), 400);
                        }
                    },
                    toggleTodo: (id, currentStatus) => {
                        if(App.State.todosRef) {
                            updateDoc(doc(App.State.todosRef, id), { done: !currentStatus });
                            App.Utils.vibrate(40); // Vibrate on check
                        }
                    },
                    saveNote: async (id, text) => {
                        if (!id || !App.State.notesRef) return;
                        await setDoc(doc(App.State.notesRef, id), { text: text.replace(/\n/g, '<br>'), updatedAt: serverTimestamp() });
                        App.Utils.showToast("📝 筆記已儲存");
                    }
                },
                Weather: {
                    fetch: async () => {
                        if(!App.Config.settings.wt.enabled) {
                            App.Data.Trip.forEach(d => d.weather = { icon: "fa-cloud", temp: "N/A" });
                            App.Controllers.Trip.renderTrip();
                            App.Utils.setDiag('diag-wt', false);
                            return;
                        }
                        try {
                            const now = new Date();
                            const day = now.getDay();
                            const diff = now.getDate() - day + (day == 0 ? -6 : 1);
                            const monday = new Date(now.setDate(diff));
                            const saturday = new Date(now.setDate(diff + 5));
                            
                            const formatDate = (date) => date.toISOString().split('T')[0];
                            const startStr = formatDate(monday);
                            const endStr = formatDate(saturday);

                            const urlHak = `https://api.open-meteo.com/v1/forecast?latitude=41.7687&longitude=140.7290&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo&start_date=${startStr}&end_date=${endStr}`;
                            const urlAom = `https://api.open-meteo.com/v1/forecast?latitude=40.8244&longitude=140.7400&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo&start_date=${startStr}&end_date=${endStr}`;

                            const [resHak, resAom] = await Promise.all([ fetch(urlHak).then(r=>r.json()), fetch(urlAom).then(r=>r.json()) ]);

                            if (!resHak.daily || !resAom.daily) throw new Error("Weather incomplete");

                            App.Data.Trip.forEach((tripDay, idx) => {
                                let source = (idx === 0) ? resHak : resAom;
                                if (source.daily.temperature_2m_max[idx] !== undefined) {
                                    const min = Math.round(source.daily.temperature_2m_min[idx]);
                                    const max = Math.round(source.daily.temperature_2m_max[idx]);
                                    const code = source.daily.weather_code[idx];
                                    tripDay.weather = { icon: App.Utils.getIconClass(code), temp: `${min}° / ${max}°` };
                                }
                            });
                            App.Controllers.Trip.renderTrip(); 
                            App.Utils.setDiag('diag-wt', true);
                        } catch (e) {
                            console.error("Weather error", e);
                            App.Data.Trip.forEach(d => d.weather = { icon: "fa-cloud", temp: "N/A" });
                            App.Controllers.Trip.renderTrip();
                            App.Utils.setDiag('diag-wt', false);
                        }
                    }
                },
                Translator: {
                    translate: async (input) => {
                        if(!App.Config.settings.ai.enabled) return "AI Disabled";
                        try {
                            const key = App.Config.settings.ai.key || "";
                            // 如果沒key 就不送出
                            if(!key) return "Please set API Key";

                            // ============================================
                            // OPTIMIZED PROMPT FOR STRICT JAPANESE OUTPUT
                            // ============================================
                            const refinedPrompt = `你現在是一位專業的隨身旅遊翻譯官。
                            請將以下中文翻譯成日文，並附上羅馬拼音。
                            
                            規則：
                            1. 只輸出日文翻譯與羅馬拼音。
                            2. 格式嚴格要求：[日文原文] \n [羅馬拼音]
                            3. 不要包含任何解釋、備註、問候語或字典式的背景說明。
                            4. 針對旅遊場景，使用禮貌體（Desu/Masu）。
                            
                            待翻譯文字：${input}`;

                            const res = await App.Utils.fetchRetry(App.Config.TRANSLATE_URL + key, {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({ contents: [{ parts: [{ text: refinedPrompt }] }] })
                            });
                            const json = await res.json();
                            return json.candidates?.[0]?.content?.parts?.[0]?.text;
                        } catch (e) { return "Error"; }
                    },
                    fetchAdvice: async () => {
                        const widget = document.getElementById('ai-pill-text');
                        widget.innerText = "Thinking...";
                        
                        try {
                            const key = App.Config.settings.ai.key || "";
                            if(!key) { widget.innerText = "No API Key"; return; }

                            const dayIdx = App.State.currentDayIndex;
                            const dayInfo = App.Data.Trip[dayIdx];
                            const prompt = `You are a tour guide. Today is ${dayInfo.date}, location is ${dayInfo.heroTitle}. Weather is ${dayInfo.weather.temp}. Give a 15-word practical advice for a tourist now. Language: Traditional Chinese.`;

                            const res = await App.Utils.fetchRetry(App.Config.TRANSLATE_URL + key, {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                            });
                            const json = await res.json();
                            const advice = json.candidates?.[0]?.content?.parts?.[0]?.text;
                            if(advice) {
                                widget.innerText = advice.replace(/\n/g, ' ');
                                App.Utils.showToast("💡 導遊建議已更新");
                            } else {
                                widget.innerText = "AI Busy...";
                            }
                        } catch(e) {
                            widget.innerText = "AI Error";
                        }
                    }
                }
            },
            Controllers: {
                UI: {
                    createSnow: () => {
                        const c = document.getElementById('snow-container');
                        for(let i=0; i<50; i++) {
                            const s = document.createElement('div');
                            s.className = 'snowflake'; s.innerHTML = '❄';
                            s.style.left = Math.random()*100+'%';
                            const dur = (Math.random()*5+5);
                            s.style.animationDuration = dur + 's';
                            s.style.animationDelay = -(Math.random()*dur) + 's'; 
                            s.style.fontSize = (Math.random()*0.4+0.2)+'rem';
                            c.appendChild(s);
                        }
                    },
                    initApp: () => {
                        App.Utils.vibrate(100);
                        App.Controllers.Wallet.loadSettings();
                        document.getElementById('intro-screen').style.transform = 'translateY(-100%)';
                        App.Controllers.Trip.renderTrip();
                        App.Controllers.Trip.setupGestures();
                        App.Services.Weather.fetch();
                        App.Controllers.Trip.renderFullTripMap();
                        App.Controllers.Wallet.fetchExchangeRate();
                        App.Controllers.Wallet.initListInteractions();
                        setInterval(App.Controllers.Trip.checkActiveEvent, 60000);
                        App.Controllers.Trip.checkActiveEvent();
                        
                        // Set initial time on wallet
                        document.getElementById('header-date').innerText = App.Utils.getFormattedTime();
                        
                        // Init AI Widget State
                        if(App.Config.settings.ai.enabled && App.Config.settings.ai.key) {
                            document.getElementById('ai-guide-widget').classList.add('visible');
                        }
                    },
                    switchView: (view, btn) => {
                        document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                        document.getElementById('view-'+view).classList.remove('hidden');
                        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
                        if(btn) btn.classList.add('active');
                        document.body.className = (view === 'wallet') ? 'wallet-mode' : '';
                        
                        // Update time when switching to wallet
                        if(view === 'wallet') {
                            App.Controllers.Wallet.fetchExchangeRate();
                            document.getElementById('header-date').innerText = App.Utils.getFormattedTime();
                        }
                        
                        // Scroll top
                        window.scrollTo(0,0);
                    },
                    askAiGuide: () => {
                        App.Utils.vibrate(50);
                        App.Services.Translator.fetchAdvice();
                    },
                    translateNow: async () => {
                        const input = document.getElementById('trans-input').value;
                        if(!input) return;
                        
                        const outputBox = document.getElementById('trans-output-box');
                        const resultEl = document.getElementById('trans-jp-result');
                        const zhEl = document.getElementById('trans-zh');
                        
                        // 1. Show the output box and loading state
                        outputBox.classList.remove('hidden');
                        zhEl.innerText = input;
                        resultEl.innerHTML = "<i class='fa-solid fa-spinner fa-spin'></i> 翻譯中...";
                        
                        // 2. Call API
                        const res = await App.Services.Translator.translate(input);
                        
                        // 3. Render Result with Romaji Separation
                        if (res && res.includes('\n')) {
                            // Split by newline to separate Japanese and Romaji
                            const parts = res.split('\n');
                            const jp = parts[0].trim();
                            // Join the rest as Romaji just in case there are multiple lines
                            const romaji = parts.slice(1).join(' ').trim();
                            
                            resultEl.innerHTML = `${jp} <span class="romaji-text">${romaji}</span>`;
                        } else {
                            // Fallback if no newline found
                            resultEl.innerText = res || "Error";
                        }
                    },
                    showFs: (jp, cn, type) => {
                        document.getElementById('fs-jp').innerText = jp;
                        document.getElementById('fs-cn').innerText = cn;
                        const ctrl = document.getElementById('fs-controls');
                        ctrl.innerHTML = '';
                        if (type === 'toilet') {
                            const btnM = document.createElement('button'); btnM.className='fs-ctrl-btn'; btnM.innerText='男廁';
                            const btnF = document.createElement('button'); btnF.className='fs-ctrl-btn'; btnF.innerText='女廁';
                            btnM.onclick = (e) => { e.stopPropagation(); document.getElementById('fs-jp').innerText='男性用お手洗いはどこですか？'; };
                            btnF.onclick = (e) => { e.stopPropagation(); document.getElementById('fs-jp').innerText='女性用お手洗いはどこですか？'; };
                            ctrl.appendChild(btnM); ctrl.appendChild(btnF);
                        }
                        if (type === 'reservation') {
                            const types = { '租車':'レンタカー', '住宿':'宿泊', '活動':'アクティビティ' };
                            Object.keys(types).forEach(k => {
                                const b = document.createElement('button'); b.className='fs-ctrl-btn'; b.innerText=k;
                                b.onclick = (e) => { e.stopPropagation(); document.getElementById('fs-jp').innerText=`${types[k]}の予約をしています。`; };
                                ctrl.appendChild(b);
                            });
                        }
                        if (type === 'checkout') {
                            // Checkout Combo Logic
                            App.State.checkoutState = { pay: '現金', split: '一起' };
                            const updateSentence = () => {
                                const pay = App.State.checkoutState.pay === '現金' ? '現金' : 'カード';
                                const split = App.State.checkoutState.split === '一起' ? '一緒' : '別々';
                                const fullJp = `${pay}で、${split}でお願いします。`; // Genkin de, issho de onegaishimasu
                                document.getElementById('fs-jp').innerText = fullJp;
                            }
                            
                            // Row 1: Payment Method
                            const div1 = document.createElement('div'); div1.style.width='100%'; div1.style.display='flex'; div1.style.justifyContent='center'; div1.style.gap='10px'; div1.style.marginBottom='10px';
                            const btnCash = document.createElement('button'); btnCash.className='fs-ctrl-btn active'; btnCash.innerText='現金';
                            const btnCard = document.createElement('button'); btnCard.className='fs-ctrl-btn'; btnCard.innerText='刷卡';
                            
                            btnCash.onclick = (e) => { e.stopPropagation(); App.State.checkoutState.pay = '現金'; btnCash.classList.add('active'); btnCard.classList.remove('active'); updateSentence(); };
                            btnCard.onclick = (e) => { e.stopPropagation(); App.State.checkoutState.pay = '刷卡'; btnCard.classList.add('active'); btnCash.classList.remove('active'); updateSentence(); };
                            div1.appendChild(btnCash); div1.appendChild(btnCard);

                            // Row 2: Split Method
                            const div2 = document.createElement('div'); div2.style.width='100%'; div2.style.display='flex'; div2.style.justifyContent='center'; div2.style.gap='10px';
                            const btnTogether = document.createElement('button'); btnTogether.className='fs-ctrl-btn active'; btnTogether.innerText='一起付';
                            const btnSplit = document.createElement('button'); btnSplit.className='fs-ctrl-btn'; btnSplit.innerText='分開付';

                            btnTogether.onclick = (e) => { e.stopPropagation(); App.State.checkoutState.split = '一起'; btnTogether.classList.add('active'); btnSplit.classList.remove('active'); updateSentence(); };
                            btnSplit.onclick = (e) => { e.stopPropagation(); App.State.checkoutState.split = '分開'; btnSplit.classList.add('active'); btnTogether.classList.remove('active'); updateSentence(); };
                            div2.appendChild(btnTogether); div2.appendChild(btnSplit);

                            ctrl.appendChild(div1); ctrl.appendChild(div2);
                            updateSentence(); // Init text
                        }
                        if (type === 'quantity') {
                            App.State.currentQuantity = 1;
                            const wrap = document.createElement('div'); wrap.className='fs-qty-ctrl';
                            wrap.innerHTML = `<button class="fs-qty-btn" onclick="window.updateFsQty(-1)">-</button><div class="fs-qty-val" id="fs-qty-val">1</div><button class="fs-qty-btn" onclick="window.updateFsQty(1)">+</button>`;
                            wrap.onclick = e=>e.stopPropagation();
                            ctrl.appendChild(wrap);
                        }
                        document.getElementById('fs-text-modal').classList.add('active');
                    },
                    updateFsQty: (delta) => {
                        let q = App.State.currentQuantity + delta;
                        if(q<1) q=1; if(q>20) q=20;
                        App.State.currentQuantity = q;
                        document.getElementById('fs-qty-val').innerText = q;
                        document.getElementById('fs-jp').innerText = `これを ${q} 個ください。`;
                        document.getElementById('fs-cn').innerText = `我要 ${q} 個這個`;
                    },
                    closeFs: () => document.getElementById('fs-text-modal').classList.remove('active'),
                    startDynamicText: () => {
                        const msgs = App.Data.Messages.rest;
                        document.getElementById('dynamic-intro-text').innerText = msgs[Math.floor(Math.random()*msgs.length)];
                        document.getElementById('dynamic-intro-text').style.opacity = 1;
                    }
                },
                Trip: {
                    renderTrip: (dir=0) => {
                        const idx = App.State.currentDayIndex;
                        const day = App.Data.Trip[idx];
                        document.getElementById('date-nav').innerHTML = App.Data.Trip.map((d,i) => 
                            `<div class="d-item ${i===idx?'active':''}" onclick="window.switchDay(${i})">
                                <div class="d-week">${d.week}</div><div class="d-num">${d.date.split('.')[1]}</div>
                                <div class="d-weather"><i class="fa-solid ${d.weather.icon}"></i><span>${d.weather.temp}</span></div>
                            </div>`).join('');
                        
                        let html = `<div class="hero-card"><img src="${day.heroImg}" class="hero-img"><div class="hero-overlay"><div class="hero-title">${day.heroTitle}</div></div></div>`;
                        if(day.alert) html += `<div class="alert-banner"><span class="alert-highlight">${day.alert}</span></div>`;
                        html += `<div class="timeline-block">` + day.events.map((ev,i) => {
                            const data = App.Utils.safeStringify(ev);
                            const isTicket = ['Transport', 'Drive', 'Flight'].includes(ev.tag);
                            const eventId = `d${idx}_e${i}`; // Use consistent ID
                            return `<div class="event-node visible" style="transition-delay:${i*0.1}s">
                                <div class="time-dot" id="dot-${eventId}"></div>
                                <div class="event-card ${isTicket?'transport-card':''}" id="card-${eventId}" onclick="window.openDetail('${data}',${idx},${i})">
                                    <div style="display:flex;justify-content:space-between;"><span class="event-tag">${ev.tag}</span><span style="font-weight:700;color:var(--accent-red)">${ev.time}</span></div>
                                    <div class="event-title">${ev.title}<span class="now-badge hidden" id="badge-${eventId}">NOW</span></div>
                                    <div style="font-size:0.7rem;color:#888;">${ev.desc}</div>
                                </div></div>`;
                        }).join('') + `</div>`;
                        
                        const c = document.getElementById('timeline-container');
                        c.innerHTML = html;
                        c.className = "container " + (dir===1 ? 'slide-in-from-left' : dir===-1 ? 'slide-in-from-right' : '');
                        
                        // Re-check active event after rendering
                        setTimeout(App.Controllers.Trip.checkActiveEvent, 100);
                    },
                    switchDay: (i) => {
                        App.Utils.vibrate(30);
                        // Check if current view is trip view, if not switch back
                        const tripView = document.getElementById('view-trip');
                        if (tripView.classList.contains('hidden')) {
                            App.Controllers.UI.switchView('trip', document.querySelector('.nav-btn.active'));
                            // If coming from another view, we might not need animation or direction, just render
                            App.State.currentDayIndex = i;
                            App.Controllers.Trip.renderTrip();
                            return;
                        }

                        if(App.State.isAnimating || i === App.State.currentDayIndex) return;
                        const dir = i > App.State.currentDayIndex ? -1 : 1;
                        App.State.currentDayIndex = i;
                        App.State.isAnimating = true;
                        App.Controllers.Trip.renderTrip(dir);
                        setTimeout(() => App.State.isAnimating = false, 350);
                    },
                    openDetail: (str, di, ei) => {
                        const data = JSON.parse(decodeURIComponent(str));
                        App.State.currentEventId = `d${di}_e${ei}`;
                        document.getElementById('m-title').innerText = data.title;
                        document.getElementById('m-tag').innerText = data.tag;
                        document.getElementById('m-img').src = data.img || App.Data.Trip[di].heroImg;
                        App.Controllers.Trip.updateModalNoteContent(data.detail);
                        document.getElementById('detail-modal').classList.add('active');
                        document.querySelector('.modal-overlay').classList.add('active');
                    },
                    updateModalNoteContent: (def) => {
                        const note = App.State.localNotes[App.State.currentEventId] || def || "";
                        document.getElementById('m-desc').innerHTML = note;
                        document.getElementById('m-note-input').value = note.replace(/<br>/g, '\n');
                    },
                    toggleEditNote: () => {
                        const view = document.getElementById('m-desc'), edit = document.getElementById('m-note-edit');
                        const isEdit = !edit.classList.contains('hidden');
                        edit.classList.toggle('hidden', isEdit); view.classList.toggle('hidden', !isEdit);
                    },
                    closeModal: () => {
                        document.getElementById('detail-modal').classList.remove('active');
                        document.querySelector('.modal-overlay').classList.remove('active');
                    },
                    checkActiveEvent: () => {
                        // Determine current time
                        let now;
                        if (App.Config.settings.sim && App.Config.settings.sim.enabled) {
                            if (App.Config.settings.sim.time) {
                                now = new Date(App.Config.settings.sim.time);
                            } else {
                                now = new Date("2026-02-02T16:05:00"); // Simulation Time: Day 1, 16:05
                            }
                        } else {
                            now = new Date();
                        }

                        // Trip Start Logic
                        const tripStart = new Date(App.Config.TRIP_START_DATE); // 2026-02-02
                        // Calculate day index based on 'now'
                        // Day 1 is 2026-02-02.
                        // Diff in ms
                        const diffTime = now - tripStart;
                        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); 
                        
                        // If we are within trip dates (0 to 5)
                        if (diffDays >= 0 && diffDays < App.Data.Trip.length) {
                            // If current view day is different from 'now' day, user might be browsing
                            // We only highlight if we are viewing the correct day
                            if (diffDays === App.State.currentDayIndex) {
                                const currentH = now.getHours();
                                const currentM = now.getMinutes();
                                const currentTimeVal = currentH * 60 + currentM;

                                const events = App.Data.Trip[diffDays].events;
                                let activeIndex = -1;

                                // Find the latest event that has started
                                for (let i = 0; i < events.length; i++) {
                                    const [h, m] = events[i].time.split(':').map(Number);
                                    const eventVal = h * 60 + m;
                                    if (currentTimeVal >= eventVal) {
                                        activeIndex = i;
                                    } else {
                                        break; // Future event
                                    }
                                }

                                // Reset all highlights
                                document.querySelectorAll('.active-event').forEach(el => el.classList.remove('active-event'));
                                document.querySelectorAll('.now-badge').forEach(el => el.classList.add('hidden'));

                                if (activeIndex !== -1) {
                                    const eventId = `d${diffDays}_e${activeIndex}`;
                                    const card = document.getElementById(`card-${eventId}`);
                                    const dot = document.getElementById(`dot-${eventId}`);
                                    const badge = document.getElementById(`badge-${eventId}`);
                                    
                                    if (card && dot && badge) {
                                        card.parentElement.classList.add('active-event');
                                        badge.classList.remove('hidden');
                                    }
                                }
                            }
                        }
                    },
                    setupGestures: () => { 
                        const container = document.getElementById('view-trip');
                        let touchStartX = 0;
                        let touchEndX = 0;
                        
                        container.addEventListener('touchstart', e => {
                            touchStartX = e.changedTouches[0].screenX;
                        }, {passive: true});

                        container.addEventListener('touchend', e => {
                            touchEndX = e.changedTouches[0].screenX;
                            handleSwipe();
                        }, {passive: true});

                        function handleSwipe() {
                            const threshold = 50;
                            if (touchEndX < touchStartX - threshold) {
                                // Swiped Left -> Next Day
                                if (App.State.currentDayIndex < App.Data.Trip.length - 1) {
                                    window.switchDay(App.State.currentDayIndex + 1);
                                }
                            }
                            if (touchEndX > touchStartX + threshold) {
                                // Swiped Right -> Prev Day
                                if (App.State.currentDayIndex > 0) {
                                    window.switchDay(App.State.currentDayIndex - 1);
                                }
                            }
                        }
                    },
                    renderFullTripMap: () => { 
                        const mapIframe = document.getElementById('trip-map-overview-iframe');
                        if(mapIframe && App.Config.settings.gm.enabled) {
                            const key = App.Config.settings.gm.key || App.Config.DEFAULT_GOOGLE_KEY;
                            mapIframe.src = `https://www.google.com/maps/embed/v1/view?key=${key}&center=40.7,140.7&zoom=8`;
                            App.Utils.setDiag('diag-gm', true);
                        } else {
                            App.Utils.setDiag('diag-gm', false);
                        }
                    }
                },
                Wallet: {
                    loadSettings: () => {
                        const s = localStorage.getItem('appSettings');
                        if(s) {
                            try { App.Config.settings = JSON.parse(s); } catch(e) {}
                        }
                        // Update UI
                        const set = App.Config.settings;
                        const updateUI = (key, obj) => {
                            const btn = document.getElementById('tg-'+key);
                            const inp = document.getElementById('inp-'+key);
                            const st = document.getElementById('st-'+key);
                            if(btn) {
                                btn.innerHTML = obj.enabled ? '<i class="fa-solid fa-toggle-on"></i>' : '<i class="fa-solid fa-toggle-off"></i>';
                                btn.classList.toggle('on', obj.enabled);
                            }
                            if(inp) {
                                inp.classList.toggle('visible', obj.enabled);
                                inp.value = (key==='ex') ? obj.manual : obj.key;
                            }
                            if(st) st.className = `setting-status ${obj.enabled?'ok':'err'}`;
                        };
                        updateUI('gm', set.gm);
                        updateUI('ai', set.ai);
                        updateUI('ex', set.ex);
                        updateUI('wt', set.wt);
                        updateUI('sim', set.sim); // Simulation
                        
                        // Update Manual Rate Input in Wallet
                        const manualInp = document.getElementById('inp-ex-manual');
                        if(manualInp) manualInp.value = set.ex.manual;

                        // AI Widget Visiblity
                        const aiWidget = document.getElementById('ai-guide-widget');
                        if(set.ai.enabled && set.ai.key) {
                            aiWidget.classList.add('visible');
                        } else {
                            aiWidget.classList.remove('visible');
                        }
                    },
                    toggleSetting: (key) => {
                        const set = App.Config.settings;
                        if(key === 'ex_manual') return; 
                        set[key].enabled = !set[key].enabled;
                        localStorage.setItem('appSettings', JSON.stringify(set));
                        App.Controllers.Wallet.loadSettings();
                        
                        // Action based on key
                        if(key === 'wt') App.Services.Weather.fetch();
                        if(key === 'ex') App.Controllers.Wallet.fetchExchangeRate();
                        if(key === 'gm') App.Controllers.Trip.renderFullTripMap();
                        if(key === 'sim') {
                            if(set.sim.enabled) {
                                App.Utils.showToast("⏳ 時光機啟動：目標 2026.02.02");
                                // Switch to Day 1 automatically
                                App.Controllers.Trip.switchDay(0);
                            } else {
                                App.Utils.showToast("⏳ 時光機關閉：回到現在");
                            }
                            App.Controllers.Trip.checkActiveEvent();
                            document.getElementById('header-date').innerText = App.Utils.getFormattedTime();
                        }
                    },
                    saveApiSetting: (key, val) => {
                        const set = App.Config.settings;
                        if(key === 'ex_manual') {
                            set.ex.manual = parseFloat(val);
                        } else if (key === 'sim_time') {
                            set.sim.time = val;
                            App.Controllers.Trip.checkActiveEvent(); // Recheck active event
                            document.getElementById('header-date').innerText = App.Utils.getFormattedTime(); // Update wallet time
                        } else {
                            set[key].key = val;
                        }
                        localStorage.setItem('appSettings', JSON.stringify(set));
                        if(key === 'ex_manual') App.Controllers.Wallet.fetchExchangeRate(); // Recalc
                        // Re-eval AI visibility if key changed
                        if(key === 'ai') App.Controllers.Wallet.loadSettings();
                    },
                    fetchExchangeRate: async () => {
                        if(!App.Config.settings.ex.enabled) {
                            // Manual Mode
                            App.State.rate = App.Config.settings.ex.manual || 0.22;
                            App.State.isOnline = true; // Technically works
                            document.getElementById('rate-value').innerText = App.State.rate.toFixed(2);
                            document.getElementById('status-light').className = 'status-light online';
                            App.Utils.setDiag('diag-ex', false); // Not calling API
                            return;
                        }
                        try {
                            const res = await fetch(App.Config.EXCHANGE_RATE_API);
                            const data = await res.json();
                            App.State.rate = data.rates.TWD;
                            App.State.isOnline = true;
                            document.getElementById('rate-value').innerText = App.State.rate.toFixed(2);
                            document.getElementById('status-light').className = 'status-light online';
                            App.Utils.setDiag('diag-ex', true);
                        } catch(e) {
                            App.State.isOnline = false;
                            document.getElementById('status-light').className = 'status-light offline';
                            App.Utils.setDiag('diag-ex', false);
                        }
                    },
                    toggleTopFeed: () => {
                        document.querySelector('.paper-input-feed').classList.toggle('expanded');
                    },
                    toggleSettings: () => {
                        document.getElementById('settings-panel').classList.toggle('open');
                        document.querySelector('.settings-toggle').classList.toggle('active');
                    },
                    selectUser: (btn, u) => {
                        document.querySelectorAll('.u-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        App.State.currentUser = u;
                        localStorage.setItem('defaultUser', u); // Persist user
                        App.Controllers.Wallet.renderReceiptList();
                    },
                    switchMode: (mode) => {
                        App.State.currentMode = mode;
                        document.querySelectorAll('.mode-tab').forEach(b => b.classList.remove('active'));
                        document.querySelectorAll('.mode-tab')[mode==='spend'?0:mode==='todo'?1:2].classList.add('active');
                        
                        const slotPrice = document.getElementById('slot-price');
                        const inputItem = document.getElementById('input-item');
                        const btn = document.getElementById('print-btn');
                        
                        // Reset Inputs
                        inputItem.value = '';
                        document.getElementById('input-price').value = '';
                        
                        if (mode === 'spend') {
                            slotPrice.classList.remove('hidden');
                            inputItem.placeholder = 'ITEM NAME';
                            btn.innerHTML = '<span>PRINT</span>';
                            document.getElementById('total-section').style.display = 'block';
                        } else if (mode === 'todo') {
                            slotPrice.classList.add('hidden');
                            inputItem.placeholder = 'TASK TO DO';
                            btn.innerHTML = '<span>ADD</span>';
                            document.getElementById('total-section').style.display = 'none';
                        } else if (mode === 'memo') {
                            slotPrice.classList.add('hidden');
                            inputItem.placeholder = 'WRITE A NOTE...';
                            btn.innerHTML = '<span>POST</span>';
                            document.getElementById('total-section').style.display = 'none';
                        }
                        App.Controllers.Wallet.renderReceiptList();
                    },
                    toggleCurrency: (e) => {
                        e.stopPropagation();
                        App.State.currentCurrency = App.State.currentCurrency === 'JPY' ? 'TWD' : 'JPY';
                        document.getElementById('curr-label').innerText = App.State.currentCurrency;
                        App.Controllers.Wallet.calculateConversion(document.getElementById('input-price').value);
                    },
                    calculateConversion: (val) => {
                        const v = parseFloat(val);
                        const isJpy = App.State.currentCurrency === 'JPY';
                        const res = isJpy ? Math.round(v * App.State.rate) : Math.round(v / App.State.rate);
                        document.getElementById('embedded-preview').innerText = `≈ ${isJpy ? 'TWD' : 'JPY'} ${isNaN(res)?0:res}`;
                    },
                    printReceipt: () => {
                        const mode = App.State.currentMode;
                        const item = document.getElementById('input-item').value;
                        if(!item) return;
                        
                        const btn = document.getElementById('print-btn');
                        // Animation Logic Update:
                        // Instead of moving the paper container, we move the scroll wrapper inside to "peek" content
                        const wrapper = document.getElementById('feed-scroll-wrapper');
                        
                        btn.classList.add('processing');
                        
                        // Haptic
                        App.Utils.vibrate(50);

                        // Reset animation
                        wrapper.classList.remove('anim-peek');
                        void wrapper.offsetWidth; // Reflow
                        wrapper.classList.add('anim-peek');
                        
                        // Clean up animation class later (optional but good for state)
                        setTimeout(() => wrapper.classList.remove('anim-peek'), 2500);
                        
                        // Update Header Time Instantly
                        document.getElementById('header-date').innerText = App.Utils.getFormattedTime();

                        if (mode === 'spend') {
                            const val = parseFloat(document.getElementById('input-price').value);
                            if(!val) { btn.classList.remove('processing'); return; }
                            let jpy = App.State.currentCurrency === 'JPY' ? val : Math.round(val / App.State.rate);
                            let twd = App.State.currentCurrency === 'JPY' ? Math.round(val * App.State.rate) : val;
                            addDoc(App.State.expensesRef, { user: App.State.currentUser, item, jpy, twd, timestamp: serverTimestamp() })
                                .then(done).catch(fail);
                        } else if (mode === 'todo') {
                            addDoc(App.State.todosRef, { user: App.State.currentUser, item, done: false, timestamp: serverTimestamp() })
                                .then(done).catch(fail);
                        } else if (mode === 'memo') {
                            addDoc(App.State.memosRef, { user: App.State.currentUser, text: item, timestamp: serverTimestamp() })
                                .then(done).catch(fail);
                        }

                        function done() {
                            btn.classList.remove('processing');
                            document.getElementById('input-item').value = '';
                            if(mode==='spend') document.getElementById('input-price').value = '';
                            App.Utils.showToast("✅ 已記錄");
                        }
                        function fail() { btn.classList.remove('processing'); App.Utils.showToast("❌ 失敗"); }
                    },
                    renderReceiptList: (animateNew = false) => {
                        const mode = App.State.currentMode;
                        const data = App.State.receiptsData.filter(d => d.type === undefined && mode === 'spend' || d.type === mode); // Backwards compat for old spend data without type
                        const user = App.State.currentUser;
                        
                        // 修正：上方紙張資訊根據模式改變
                        const topLabel = document.getElementById('top-total-label');
                        const topAmount = document.getElementById('top-total-amount');
                        const topSub = document.getElementById('top-total-sub');

                        if(mode === 'spend') {
                            const myTotal = data.filter(d=>d.user===user).reduce((a,b)=>a+b.jpy,0);
                            const allTotal = data.reduce((a,b)=>a+b.jpy,0);
                            
                            topLabel.innerText = "TRIP TOTAL";
                            topAmount.innerText = "¥" + allTotal.toLocaleString();
                            topSub.innerText = "≈ TWD " + Math.round(allTotal * App.State.rate).toLocaleString();

                            document.getElementById('personal-total').innerText = '¥'+myTotal.toLocaleString();
                            document.getElementById('trip-total').innerText = '¥'+allTotal.toLocaleString();
                            document.getElementById('total-label').innerText = `TOTAL (${user})`;
                        } else if (mode === 'todo') {
                            const doneCount = data.filter(d => d.done).length;
                            topLabel.innerText = "TASKS PROGRESS";
                            topAmount.innerText = `${doneCount} / ${data.length}`;
                            topSub.innerText = "COMPLETED ITEMS";
                        } else if (mode === 'memo') {
                            // Count memos per user
                            const counts = data.reduce((acc, r) => {
                                acc[r.user] = (acc[r.user] || 0) + 1;
                                return acc;
                            }, {});
                            topLabel.innerText = "MEMO COUNT";
                            topAmount.innerText = `TOTAL ${data.length}`;
                            topSub.innerText = `奎:${counts['奎']||0} | 愉:${counts['愉']||0} | 舜:${counts['舜']||0}`;
                        }

                        document.getElementById('receipt-items-anchor').innerHTML = data.map((r, i) => {
                            const isNew = animateNew && i === 0 ? 'new-item' : '';
                            
                            if (mode === 'spend') {
                                return `
                                <div class="receipt-entry ${r.user===user?'':'dimmed'} ${isNew}" id="entry-${r.id}">
                                    <div class="delete-underlay" onclick="window.deleteItem('${r.id}', 'spend')"><i class="fa-solid fa-trash-can"></i></div>
                                    <div class="receipt-content">
                                        <div class="re-header"><span>${r.date}</span><span>NO.${i+1}</span></div>
                                        <div class="re-body"><div><span class="re-user">${r.user}</span><span class="re-item">${r.item}</span></div>
                                        <div class="re-cost"><div class="re-price">¥${r.jpy}</div></div></div>
                                    </div>
                                </div>`;
                            } else if (mode === 'todo') {
                                return `
                                <div class="receipt-entry ${r.done?'done':''} ${isNew}" id="entry-${r.id}" onclick="window.toggleTodo('${r.id}', ${r.done})">
                                    <div class="delete-underlay" onclick="window.deleteItem('${r.id}', 'todo')"><i class="fa-solid fa-trash-can"></i></div>
                                    <div class="receipt-content">
                                        <div class="re-header"><span>${r.date}</span><span>TODO</span></div>
                                        <div class="re-body" style="align-items:center;">
                                            <i class="fa-regular ${r.done?'fa-square-check':'fa-square'} re-todo-check"></i>
                                            <span class="re-item">${r.item}</span>
                                        </div>
                                    </div>
                                </div>`;
                            } else if (mode === 'memo') {
                                return `
                                <div class="receipt-entry ${isNew}" id="entry-${r.id}">
                                    <div class="delete-underlay" onclick="window.deleteItem('${r.id}', 'memo')"><i class="fa-solid fa-trash-can"></i></div>
                                    <div class="receipt-content">
                                        <div class="re-header"><span>${r.date}</span><span>MEMO</span></div>
                                        <div><span class="re-user">${r.user}</span></div>
                                        <div class="re-note">${r.text}</div>
                                    </div>
                                </div>`;
                            }
                        }).join('');
                        
                        // Re-bind click events for delete swipe logic (since HTML was replaced)
                        App.Controllers.Wallet.initListInteractions();
                    },
                    initListInteractions: () => {
                        const container = document.getElementById('receipt-items-anchor');
                        if(!container) return;
                        let startX=0, currentX=0, activeSwipeEl=null;
                        
                        // For mobile touch swipe
                        container.addEventListener('touchstart', (e) => {
                            const entry = e.target.closest('.receipt-entry');
                            if (!entry) return;
                            startX = e.touches[0].clientX;
                            activeSwipeEl = entry;
                        }, {passive: true});

                        container.addEventListener('touchmove', (e) => {
                            if (!activeSwipeEl) return;
                            currentX = e.touches[0].clientX - startX;
                            if (currentX < 0 && currentX > -100) {
                                const content = activeSwipeEl.querySelector('.receipt-content');
                                if(content) content.style.transform = `translate3d(${currentX}px, 0, 0)`;
                            }
                        }, {passive: true});

                        container.addEventListener('touchend', () => {
                            if (!activeSwipeEl) return;
                            const content = activeSwipeEl.querySelector('.receipt-content');
                            if (content) content.style.transform = ''; 
                            if (currentX < -60) { 
                                document.querySelectorAll('.receipt-entry').forEach(el => el.classList.remove('reveal-delete'));
                                activeSwipeEl.classList.add('reveal-delete');
                            } else {
                                activeSwipeEl.classList.remove('reveal-delete');
                            }
                            activeSwipeEl = null; currentX = 0;
                        });
                    }
                }
            },
            start: async () => {
                // Binding functions to window first so HTML can see them
                window.initApp = App.Controllers.UI.initApp;
                window.switchView = App.Controllers.UI.switchView;
                window.switchDay = App.Controllers.Trip.switchDay;
                window.openDetail = App.Controllers.Trip.openDetail;
                window.closeModal = App.Controllers.Trip.closeModal;
                window.toggleEditNote = App.Controllers.Trip.toggleEditNote;
                window.saveNote = App.Services.Firebase.saveNote;
                window.copyMapCode = App.Controllers.Trip.copyMapCode;
                window.openExternalMap = App.Controllers.Trip.openExternalMap;
                window.openNavigation = App.Controllers.Trip.openNavigation;
                window.translateNow = App.Controllers.UI.translateNow;
                window.showFs = App.Controllers.UI.showFs;
                window.updateFsQty = App.Controllers.UI.updateFsQty;
                window.closeFs = App.Controllers.UI.closeFs;
                window.toggleTopFeed = App.Controllers.Wallet.toggleTopFeed;
                window.toggleSettings = App.Controllers.Wallet.toggleSettings;
                window.switchMode = App.Controllers.Wallet.switchMode;
                window.toggleCurrency = App.Controllers.Wallet.toggleCurrency;
                window.calculateConversion = App.Controllers.Wallet.calculateConversion;
                window.selectUser = App.Controllers.Wallet.selectUser;
                window.printReceipt = App.Controllers.Wallet.printReceipt;
                window.deleteItem = App.Services.Firebase.deleteItem;
                window.toggleTodo = App.Services.Firebase.toggleTodo;
                window.toggleSetting = App.Controllers.Wallet.toggleSetting;
                window.saveApiSetting = App.Controllers.Wallet.saveApiSetting;
                window.askAiGuide = App.Controllers.UI.askAiGuide;

                App.Controllers.UI.createSnow();
                await App.Services.Firebase.init();
                const now = new Date();
                const start = new Date("2026-02-02");
                const diff = Math.ceil((start - now) / (1000 * 60 * 60 * 24));
                document.getElementById('days-left').innerText = diff > 0 ? diff : 0;
                document.getElementById('header-days').innerText = diff > 0 ? diff : 0;
                setTimeout(App.Controllers.UI.startDynamicText, 1000);
                
                // Load Default User
                const savedUser = localStorage.getItem('defaultUser');
                if(savedUser) {
                    App.State.currentUser = savedUser;
                    // Update UI button state
                    document.querySelectorAll('.u-btn').forEach(b => {
                        if(b.innerText === savedUser) {
                            document.querySelectorAll('.u-btn').forEach(btn=>btn.classList.remove('active'));
                            b.classList.add('active');
                        }
                    });
                }
            }
        };

        window.onload = App.start;
    </script>
</body>
</html>
