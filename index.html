<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>L'VOYAGE | 函館-青森 林檎之旅</title>
    <meta name="theme-color" content="#1C2541">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJkZWZhdWx0X25hbWUiOiAiTFZPWUFHRSIsICJuYW1lIjogIuaVmeeXheaVsS3mgqLmjI3lvojmsbwiLCAic2hvcnRfbmFtZSI6ICJcdTcyNDFcdTRmOTMiLCAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwgInN0YXJ0X3VybCI6ICIuLyIsICJpY29ucyI6IFt7ICJzcmMiOiAiaWNvbjE5Mi5wbmciLCAic2l6ZXMiOiAiMTkyeDE5MiIsICJ0eXBlIjogImltYWdlL3BuZyIgfSwgezogInNyYyI6ICJpY29uNTEyLnBuZyIsICJzaXplcyI6ICI1MTJ4NTEyIiwgInR5cGUiOiAiaW1hZ2UvcG5nIiB9XSwgImJhY2tncm91bmRfY29sb3IiOiAiIzFDMjU0MSIsICJ0aGVtZV9jb2xvciI6ICIjQjQ5QjY3IiB9">
    
    <!-- Fonts & Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Noto+Serif+TC:wght@300;500;700&family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'accent-main': '#1C2541',
                        'accent-gold': '#B49B67',
                        'accent-red': '#D9333F',
                        'bg-body': '#F9F8F4',
                    },
                    fontFamily: {
                        serif: ['"Cormorant Garamond"', '"Noto Serif TC"', 'serif'],
                        sans: ['"Noto Sans TC"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --safe-bottom: env(safe-area-inset-bottom);
        }

        /* 1. Mobile Interaction Fix: Optimize touch actions */
        html, body {
            touch-action: manipulation; /* Disables double-tap to zoom, making clicks faster */
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #F9F8F4;
            color: #1A1A1A;
            font-family: 'Noto Sans TC', sans-serif;
            padding-bottom: calc(100px + var(--safe-bottom));
            overflow-x: hidden;
        }

        .serif { font-family: 'Cormorant Garamond', 'Noto Serif TC', serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Interactive Feedback for Touch */
        .btn-touch { transition: transform 0.1s ease, opacity 0.1s ease; }
        .btn-touch:active { transform: scale(0.96); opacity: 0.8; }
        
        /* Toast Notification */
        #toast-container {
            position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%);
            z-index: 3000; pointer-events: none; width: 90%; max-width: 400px;
            display: flex; flex-direction: column; gap: 10px; align-items: center;
        }
        .toast {
            background: rgba(28, 37, 65, 0.95); color: white; padding: 12px 24px;
            border-radius: 50px; font-size: 0.9rem;
            animation: slideUp 0.3s ease-out; opacity: 0; transition: opacity 0.5s;
            display: flex; align-items: center; gap: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .toast.visible { opacity: 1; }

        /* Specific Component Styles */
        .hero-card { position: relative; height: 280px; border-radius: 4px; overflow: hidden; box-shadow: 0 10px 40px -10px rgba(0,0,0,0.08); }
        .hero-img { width: 100%; height: 100%; object-fit: cover; transition: transform 10s ease; }
        .hero-overlay { position: absolute; bottom: 0; left: 0; width: 100%; padding: 25px; background: linear-gradient(to top, rgba(28,37,65,0.9), transparent); color: white; }
        .timeline-block { border-left: 1px solid #E0E0E0; margin-left: 10px; padding-left: 20px; }
        .time-dot { position: absolute; left: -25px; top: 0; width: 9px; height: 9px; background: #F9F8F4; border: 2px solid #1C2541; border-radius: 50%; }
        
        /* Live Event Styling */
        .active-event .event-card { border: 1px solid #B49B67; box-shadow: 0 0 15px rgba(180, 155, 103, 0.3); background: #FFFBF0; }
        .active-event .time-dot { background: #B49B67; border-color: #B49B67; box-shadow: 0 0 8px #B49B67; }
    </style>
</head>
<body>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Intro Screen -->
    <div id="intro-screen" class="fixed inset-0 bg-accent-main text-white z-50 flex flex-col justify-center items-center transition-transform duration-1000 ease-in-out px-8">
        <div class="intro-text text-center flex flex-col items-center">
            <div class="mb-10 opacity-0 animate-[fadeIn_1.5s_ease_forwards_0.3s]">
                <div class="text-7xl font-light text-accent-gold serif leading-none" id="days-left">--</div>
                <div class="text-sm tracking-[0.2em] text-white/80 mt-2">DAYS LEFT</div>
            </div>
            <div class="tracking-[0.2em] text-lg mb-4">函館-青森 林檎之旅</div>
            
            <!-- 修正：重新加入動態訊息顯示元素 -->
            <div id="dynamic-intro-text" class="serif text-lg text-white/90 max-w-xs text-center leading-relaxed min-h-[60px] flex items-center justify-center opacity-0 transition-opacity duration-1000 mb-8"></div>
            
            <button class="mt-12 px-10 py-3 border border-white/30 bg-transparent text-white serif text-lg tracking-widest cursor-pointer opacity-0 animate-[fadeIn_1.5s_ease_forwards_1s] btn-touch hover:bg-white/10" onclick="window.enterApp()">
                開啟旅程
            </button>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container">
        
        <!-- Header -->
        <div class="sticky top-0 z-40 bg-gradient-to-b from-[#F9F8F4] via-[#F9F8F4] to-transparent pt-10 pb-4 px-5">
            <div class="flex justify-between items-end mb-5">
                <div class="serif text-2xl font-bold tracking-wider text-accent-main">L'VOYAGE</div>
                <div class="text-right">
                    <div class="serif text-3xl leading-none text-accent-gold" id="header-days">--</div>
                    <div class="text-[0.6rem] uppercase tracking-widest text-gray-500 mt-1">DAYS TO GO</div>
                </div>
            </div>
            <!-- Date Scroller -->
            <div class="flex gap-4 overflow-x-auto no-scrollbar pb-2" id="date-nav">
                <!-- JS Generated -->
            </div>
        </div>

        <!-- 1. TRIP VIEW -->
        <div id="view-trip" class="view-section px-5 max-w-2xl mx-auto">
            <div id="timeline-container">
                <!-- JS Generated -->
            </div>
        </div>

        <!-- 2. WALLET VIEW (Fixed Layout) -->
        <div id="view-wallet" class="view-section hidden px-5 max-w-2xl mx-auto">
            
            <!-- Total Card -->
            <div class="bg-accent-main text-white p-6 rounded-2xl shadow-lg text-center mb-8 relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-32 h-32 bg-accent-gold opacity-10 rounded-full blur-2xl"></div>
                <div class="text-xs text-gray-400 tracking-widest mb-1">ESTIMATED TOTAL</div>
                <div class="serif text-4xl text-accent-gold mb-1" id="total-jpy">¥0</div>
                <div class="text-sm text-gray-300">≈ TWD <span id="total-twd">0</span></div>
            </div>

            <!-- 3. Fix Layout: Distinct Section for Tools (Converter/Todo) -->
            <section id="tools-section" class="bg-white rounded-2xl shadow-sm p-1 mb-8 border border-gray-100">
                <div class="text-xs font-bold text-gray-400 uppercase tracking-wider px-4 pt-3 mb-2">旅行小工具 Tools</div>
                
                <!-- Tabs -->
                <div class="flex bg-gray-100 rounded-xl p-1 mx-3 mb-4">
                    <div class="flex-1 text-center py-2 text-sm text-gray-500 rounded-lg cursor-pointer transition-all btn-touch w-tab active" id="tab-converter" onclick="window.switchWidget('converter')">匯率換算</div>
                    <div class="flex-1 text-center py-2 text-sm text-gray-500 rounded-lg cursor-pointer transition-all btn-touch w-tab" id="tab-todo" onclick="window.switchWidget('todo')">待辦清單</div>
                </div>

                <!-- Widget Container -->
                <div class="px-4 pb-4">
                    <!-- Converter Widget (Fixed API) -->
                    <div id="currency-converter">
                        <div class="flex items-center justify-between gap-4 mb-2">
                            <div class="flex-1 flex flex-col items-center">
                                <input type="tel" id="calc-jpy" class="w-full text-center text-2xl border-b border-accent-gold bg-transparent pb-1 outline-none font-serif text-accent-main" placeholder="0" oninput="window.calcFromJpy(this.value)">
                                <div class="text-xs text-gray-400 font-bold mt-1">JPY ¥</div>
                            </div>
                            <i class="fa-solid fa-arrow-right-arrow-left text-gray-300"></i>
                            <div class="flex-1 flex flex-col items-center">
                                <input type="tel" id="calc-twd" class="w-full text-center text-2xl border-b border-gray-200 bg-transparent pb-1 outline-none font-serif text-gray-600" placeholder="0" oninput="window.calcFromTwd(this.value)">
                                <div class="text-xs text-gray-400 font-bold mt-1">TWD $</div>
                            </div>
                        </div>
                        <div class="text-center text-[0.7rem] text-gray-500 mt-2 bg-gray-50 py-1 rounded">
                            即時匯率: <span id="current-rate">載入中...</span>
                        </div>
                    </div>

                    <!-- Todo Widget (Isolated Logic) -->
                    <div id="todo-widget" class="hidden">
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="new-todo-text" class="flex-1 border-b border-gray-200 py-2 outline-none text-base" placeholder="新增待辦...">
                            <button class="bg-accent-main text-white w-10 h-10 rounded-lg shadow-md btn-touch flex items-center justify-center" onclick="window.addTodo()"><i class="fa-solid fa-plus"></i></button>
                        </div>
                        <ul id="todo-list-ul" class="space-y-2">
                            <!-- JS Generated -->
                        </ul>
                    </div>
                </div>
            </section>

            <!-- 3. Fix Layout: Distinct Section for Expense Input & Filters -->
            <section id="ledger-section">
                <div class="flex items-center justify-between px-2 mb-3">
                    <div class="text-xs font-bold text-gray-400 uppercase tracking-wider">消費記錄 Ledger</div>
                    <button id="reset-filter-btn" class="hidden text-xs bg-gray-200 text-gray-600 px-3 py-1 rounded-full btn-touch" onclick="window.filterExpenses(null)">
                        <i class="fa-solid fa-times mr-1"></i> 清除篩選
                    </button>
                </div>

                <!-- Expense Input Card -->
                <div class="bg-white rounded-2xl shadow-sm p-5 mb-6 border border-gray-100">
                    <!-- User Selector -->
                    <div class="flex gap-3 mb-5">
                        <button class="flex-1 py-3 border border-gray-200 rounded-xl text-gray-500 font-serif text-lg btn-touch user-btn active" onclick="window.selectUser('YK', this)">YK</button>
                        <button class="flex-1 py-3 border border-gray-200 rounded-xl text-gray-500 font-serif text-lg btn-touch user-btn" onclick="window.selectUser('YY', this)">YY</button>
                        <button class="flex-1 py-3 border border-gray-200 rounded-xl text-gray-500 font-serif text-lg btn-touch user-btn" onclick="window.selectUser('YS', this)">YS</button>
                    </div>
                    
                    <div class="space-y-4">
                        <input type="text" id="ex-item" class="w-full border-b border-gray-200 py-2 outline-none text-lg bg-transparent" placeholder="項目名稱">
                        <div class="relative">
                            <input type="tel" id="ex-price" class="w-full border-b border-gray-200 py-2 outline-none text-lg bg-transparent" placeholder="金額 (日幣)" oninput="window.calculatePreview(this.value)">
                            <div class="absolute right-0 bottom-2 text-sm text-accent-gold font-serif" id="preview-twd">≈ TWD 0</div>
                        </div>
                        <button class="w-full bg-accent-main text-white py-3 rounded-xl tracking-widest font-serif btn-touch mt-2" onclick="window.addExpense()">記錄支出</button>
                    </div>
                </div>

                <!-- Dashboard Filters -->
                <div class="grid grid-cols-3 gap-3 mb-6">
                    <div class="bg-white p-3 rounded-xl border border-gray-100 text-center cursor-pointer btn-touch dashboard-item" onclick="window.filterExpenses('YK')">
                        <div class="w-8 h-8 bg-accent-main text-white rounded-full flex items-center justify-center mx-auto mb-2 text-xs">YK</div>
                        <div class="serif text-accent-main font-bold text-sm" id="dash-yk">¥0</div>
                    </div>
                    <div class="bg-white p-3 rounded-xl border border-gray-100 text-center cursor-pointer btn-touch dashboard-item" onclick="window.filterExpenses('YY')">
                        <div class="w-8 h-8 bg-accent-main text-white rounded-full flex items-center justify-center mx-auto mb-2 text-xs">YY</div>
                        <div class="serif text-accent-main font-bold text-sm" id="dash-yy">¥0</div>
                    </div>
                    <div class="bg-white p-3 rounded-xl border border-gray-100 text-center cursor-pointer btn-touch dashboard-item" onclick="window.filterExpenses('YS')">
                        <div class="w-8 h-8 bg-accent-main text-white rounded-full flex items-center justify-center mx-auto mb-2 text-xs">YS</div>
                        <div class="serif text-accent-main font-bold text-sm" id="dash-ys">¥0</div>
                    </div>
                </div>

                <!-- List -->
                <h3 class="serif text-lg mb-3 pl-2 border-l-4 border-accent-gold">近期紀錄 History</h3>
                <div id="expense-list" class="space-y-2">
                    <!-- JS Generated -->
                </div>
            </section>
        </div>

        <!-- 3. TRANSLATE VIEW -->
        <div id="view-trans" class="view-section hidden px-5 max-w-2xl mx-auto">
            <!-- ... existing translate code ... -->
            <div class="bg-white p-6 rounded-lg shadow-sm mb-6 mt-4">
                <h3 class="serif text-xl mb-4">即時翻譯</h3>
                <textarea id="trans-input" class="w-full border border-gray-200 rounded p-3 text-lg mb-4 h-24 outline-none focus:border-accent-gold" placeholder="輸入中文..."></textarea>
                <button class="w-full bg-accent-main text-white py-3 rounded mb-4 btn-touch" onclick="window.translateNow()">
                    <i class="fa-solid fa-language mr-2"></i> 翻譯成日文
                </button>
                <div id="trans-output-box" class="hidden bg-gray-50 border-l-4 border-accent-gold p-4 rounded-r">
                    <div class="serif text-2xl text-accent-main font-bold mb-3" id="trans-jp-result"></div>
                </div>
            </div>
        </div>

        <!-- 4. INFO VIEW -->
        <div id="view-info" class="view-section hidden px-5 max-w-2xl mx-auto">
            <div class="bg-white p-4 rounded-lg shadow-sm mt-4 mb-6">
                <h2 class="serif text-xl text-accent-main mb-2">旅行總覽地圖</h2>
                <iframe id="trip-map-overview-iframe" class="w-full h-80 border-0 rounded" allowfullscreen="" loading="lazy"></iframe>
            </div>
        </div>

    </div>

    <!-- Nav Bar -->
    <div class="fixed bottom-8 left-1/2 -translate-x-1/2 w-auto min-w-[280px] bg-[#1C2541]/95 backdrop-blur-md rounded-full py-3 px-8 flex justify-between items-center shadow-2xl z-40 gap-6">
        <div class="nav-btn text-white/40 text-2xl cursor-pointer transition-all p-2 active btn-touch" onclick="window.switchView('trip', this)">
            <i class="fa-solid fa-map-location-dot"></i>
        </div>
        <div class="nav-btn text-white/40 text-2xl cursor-pointer transition-all p-2 btn-touch" onclick="window.switchView('wallet', this)">
            <i class="fa-solid fa-wallet"></i>
        </div>
        <div class="nav-btn text-white/40 text-2xl cursor-pointer transition-all p-2 btn-touch" onclick="window.switchView('trans', this)">
            <i class="fa-solid fa-comments"></i>
        </div>
        <div class="nav-btn text-white/40 text-2xl cursor-pointer transition-all p-2 btn-touch" onclick="window.switchView('info', this)">
            <i class="fa-solid fa-circle-info"></i>
        </div>
    </div>

    <!-- Detail Modal (Condensed for brevity, keeps logic) -->
    <div class="modal-overlay fixed inset-0 bg-black/60 z-[60] opacity-0 pointer-events-none transition-opacity" onclick="window.closeModal()"></div>
    <div class="modal-full fixed bottom-0 left-0 w-full h-[90vh] bg-[#F9F8F4] z-[70] rounded-t-3xl translate-y-full transition-transform duration-500 ease-out overflow-y-auto pb-20" id="detail-modal">
        <div class="sticky top-0 right-0 p-4 text-right z-10 pointer-events-none">
            <button onclick="window.closeModal()" class="pointer-events-auto bg-white w-10 h-10 rounded-full shadow-lg text-gray-600 flex items-center justify-center text-lg btn-touch">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        <img src="" id="m-img" class="w-full h-64 object-cover -mt-16 bg-gray-200">
        <div class="px-6 relative top-[-20px] bg-[#F9F8F4] rounded-t-3xl pt-8">
            <h2 id="m-title" class="serif text-3xl text-accent-main my-2 leading-tight">Title</h2>
            <div id="m-desc" class="text-gray-600 leading-relaxed whitespace-pre-wrap mt-4"></div>
        </div>
    </div>

    <script>
        const GOOGLE_MAPS_API_KEY = "AIzaSyAX9nvh4bJpiM6-oTm8FoUSZeSBpxZBc1E"; 
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, serverTimestamp, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- MOCK DATA (Simplified for brevity) ---
        const tripData = [
            { day: 1, date: "02.02", week: "MON", heroTitle: "函館：百元發熱衣與百萬夜景", heroImg: "https://i.imgur.com/RTJNqwv.jpg", weather: {icon:"fa-snowflake", temp:"-2°"}, events: [{time:"11:10", title:"抵達函館", tag:"Arrival", desc:"機場", location:"Hakodate Airport"}] },
            { day: 2, date: "02.03", week: "TUE", heroTitle: "乘著隼-飛越大海到蘋果之鄉", heroImg: "https://i.imgur.com/iqO53uS.jpg", weather: {icon:"fa-snowflake", temp:"-3°"}, events: [] },
            { day: 3, date: "02.04", week: "WED", heroTitle: "津輕鐵道與弘前雪景", heroImg: "https://i.imgur.com/M2AVCI5.jpg", weather: {icon:"fa-snowflake", temp:"-4°"}, events: [] },
            { day: 4, date: "02.05", week: "THU", heroTitle: "八甲田：登上纜車去看看雪怪", heroImg: "https://i.imgur.com/xOsZDUG.jpg", weather: {icon:"fa-snowflake", temp:"-5°"}, events: [] },
            { day: 5, date: "02.06", week: "FRI", heroTitle: "星野青森屋 與 雪地華爾茲", heroImg: "https://i.imgur.com/ViOh2sW.jpg", weather: {icon:"fa-snowflake", temp:"-4°"}, events: [] },
            { day: 6, date: "02.07", week: "SAT", heroTitle: "返程-踏著雪花滿載而歸", heroImg: "https://i.imgur.com/edlDbD7.jpg", weather: {icon:"fa-snowflake", temp:"-2°"}, events: [] }
        ];

        // --- DYNAMIC MESSAGE DATA (已重新加入) ---
        const timeSensitiveMessages = {
            work: [
                "每天都在處理突發狀況，這次唯一的突發狀況，只有「食物太好吃」。",
                "那些表格、報告、SOP 都留在台灣，行李箱只裝得下期待。",
                "總是為了別人忙得團團轉，Day 5 的暖爐馬車是專門為你們慢下來的。",
                "不管是鈴聲、呼叫器還是電話聲，都比不上弘前雪地裡的寂靜好聽。",
                "每天都要「保持冷靜」，但在青森的蘋果派面前，允許你激動一點。",
                "這次旅行沒有「長官」也沒有「家屬/家長」，只有這群懂你的旅伴。",
                "把「解決問題」的能力先關掉，我們去古川市場只負責「解決海鮮丼」。",
                "每天都在跟時間賽跑，但在暖爐列車上，時間是被炭火慢慢烤熱的。",
                "辛苦了，這趟旅行就是你們最好的績效獎金。",
                "那些讓你理智斷線的瞬間都過去了，現在連線的是青森的 WiFi。",
                "每天都要武裝自己，這次去 UNIQLO 買件毛茸茸的外套，把自己裹得軟軟的吧。",
                "暫時把「責任感」調成飛航模式，準備出發？",
                "逃離那些不講理的人事物，去見見只會點頭吃草的馬兒吧。",
                "在職場上看了太多無奈，去看看奈良美智的作品，找回純真的眼神。",
                "上班的空氣太悶了，好想快點聞到烤魷魚的香氣。",
                "讓弘前城的白色雪景，覆蓋掉腦中那些雜亂的待辦事項。",
                "當你覺得這週很漫長時，想想函館朝市的海膽正在慢慢變甜。",
                "咖啡已經提不了神了嗎？那你需要的是奧入瀨溪流的冷冽空氣。",
                "那些難搞的公事，丟進津輕海峽裡應該會沉下去吧？",
                "把過度使用的腦容量清空，留給藤田紀念庭園的美景。",
                "即使今天遇到鳥事，想著「我要去青森了」，心情也會變好。",
                "今天的努力，都是為了那天在雪地裡能無憂無慮地漫步。",
                "墨鏡準備好了嗎？我們要去面對比現實更刺眼、更燦爛的雪白。",
                "總是擔心這個、擔心那個，這次唯一要擔心的是「不想回去怎麼辦」。",
                "距離出發又近了一天，你的心是不是已經偷偷溜去機場了？",
                "再撐一下，那些煩人的事，過幾天都會變成遙遠的故事。"
            ],
            evening: [
                "每天都在講話安撫別人，去金森紅磚倉庫時，我們試著安靜地看著夕陽就好。",
                "你的耐心餘額已不足？沒關係，函館的百萬夜景會幫你充值。",
                "總是把別人的需求擺第一，這次，請把「我想吃這個」大聲說出來。",
                "想像一下，幸運小丑漢堡的醬汁滴下來的熱度，是不是餓了？",
                "手指敲鍵盤/寫字太久了，它們現在只想握著暖暖的清酒杯。",
                "你的眼睛看太多螢幕了，函館的夜景是最好的眼藥水。",
                "在 Dormy Inn 的夜鳴拉麵面前，減肥什麼的都明天再說。",
                "你的胃是不是在抗議都亂吃？準備好用鄉土料理來安撫它。",
                "期待一下，在唐吉訶德迷路時，那種被商品包圍的無腦快樂。",
                "餓了嗎？古川市場的「Nokke Don」，想好要蓋幾層生魚片了嗎？",
                "讓陸奧祭典屋的鼓聲，震碎你心裡的煩悶。",
                "在函館山看夜景時，許個願吧，關於自己，不是關於工作。",
                "每天晚上回到飯店，都要喝一杯，慶祝我們又征服了一天。",
                "遇到好吃的一定要分一口，遇到雷的也要一人一口（有難同當）。",
                "嘿，今天過得還好嗎？函館的風在等你。",
                "如果在唐吉訶德失心瘋，記得提醒對方：「行李箱還塞得下嗎？」",
                "為了那一口蘋果派的酥脆，今天的午餐隨便吃也沒關係。",
                "買伴手禮的時候，記得先買給自己，再買給別人。"
            ],
            rest: [
                "總是聽別人的煩惱，這次換聽聽津輕海峽的海浪聲吧。",
                "知道你肩膀很重，所以我們安排了溫泉，把那些責任都洗掉。",
                "平常照顧大家，這次讓星野集團的服務人員來寵壞你。",
                "脫下制服的你，都只是渴望被大自然擁抱的孩子。",
                "今天如果覺得很累，想著 星野青森屋，深呼吸一次。",
                "閉上眼睛，想像一下零下五度的空氣吸進肺裡，那種乾淨的感覺。",
                "聽說津輕鐵道的暖爐很溫暖，就像我們聚在一起的溫度。",
                "想像腳踩在厚厚的新雪上，「噗滋」一聲，那是療癒的聲音。",
                "青森蘋果咬下去清脆的聲音，會讓你忘記所有的噪音。",
                "讓星野青森屋的露天溫泉，蒸發掉你累積一整年的疲憊。",
                "想像大正浪漫喫茶室的陽光灑在臉上，那天下午我們什麼都不做。",
                "當新幹線穿過隧道，眼前豁然開朗的那一刻，心情也會跟著打開。",
                "讓弘前的粉雪，輕輕落在你的睫毛上，那是冬天的親吻。",
                "想像一下，自駕在雪牆中間，全世界只剩下我們這台車。",
                "最後一天在機場的霜淇淋，是這趟旅程最甜美的句點。",
                "雖然大家都很會照顧人，但這次我們要互相照顧，或者一起擺爛。",
                "如果誰在弘前城滑倒了，先拍照再扶起來。",
                "這次租的車就是我們的移動城堡，裡面只裝笑聲。",
                "回程時，不准哭喪著臉，要笑著說「下次再去哪裡」。",
                "約好了，要把這幾天的快樂，儲存成回台灣後的能量包。",
                "就算迷路了，只要三個人在一起，那裡就是景點。",
                "你的雪靴準備好了嗎？它迫不及待要在青森留下腳印。",
                "生活偶爾需要暫停，我們正在前往按暫停鍵的路上。",
                "檢查一下，好奇心帶了嗎？那是比護照更重要的東西。",
                "護照檢查過了嗎？那是通往自由的入場券。",
                "想像一下，此刻的弘前城，雪正靜靜地落下，等待著你的到來。",
                "行李箱拿出來了嗎？把它攤開在地上，就是一種儀式感。",
                "日幣換好了嗎？那些硬幣到時候都會變成扭蛋和飲料。",
                "保暖做好了嗎？心很熱，但身體還是要顧喔。",
                "手機記憶體清空了嗎？別讓容量限制了你的回憶。",
                "駕照譯本在皮夾裡了嗎？那是我們馳騁青森的鑰匙。",
                "歌單整理好了嗎？那是公路旅行的靈魂。",
                "每天看著倒數數字變少，嘴角是不是會不自覺上揚？",
                "讓期待感像雪球一樣，越滾越大吧。",
                "記得帶上面膜/保濕品，在飯店敷臉聊天的時光很珍貴。",
                "倒數計時中...深呼吸，聞到日本空氣的味道了嗎？",
                "所有的等待，都是為了相遇時的那一刻美好。",
                "把心清空，準備裝滿青森的藍天與白雪。",
                "準備好了嗎？去擁抱那個「只屬於你自己」的假期。"
            ]
        };

        // --- STATE ---
        let db, auth, expensesRef, todosRef;
        let currentRate = 0.22; // Default fallback
        let currentIdx = 0;
        let currentUser = localStorage.getItem('lv_user') || 'YK';
        let expenses = [];
        let todos = [];
        let currentFilterUser = null;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // --- DYNAMIC TEXT LOGIC (已重新加入) ---
        function startDynamicText() {
            const textElement = document.getElementById('dynamic-intro-text');
            const hour = new Date().getHours();
            let key = 'rest'; // Default to rest (0:00 - 7:59)
            if (hour >= 8 && hour <= 17) key = 'work'; // Day/Work (8:00 - 17:59)
            else if (hour >= 18 && hour <= 23) key = 'evening'; // Evening (18:00 - 23:59)

            const messages = timeSensitiveMessages[key];
            const msg = messages[Math.floor(Math.random() * messages.length)];
            
            if(textElement) {
                textElement.innerText = msg;
                // 確保元素在設定內容後淡入
                textElement.classList.add('opacity-100'); 
            }
        }
        window.startDynamicText = startDynamicText; // Make accessible if needed
        // --- 1. Mobile UX: Toast ---
        function showToast(msg, isError = false) {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'toast';
            if (isError) el.style.background = '#D9333F';
            el.innerHTML = `<i class="fa-solid ${isError ? 'fa-circle-exclamation' : 'fa-check-circle'}"></i> <span>${msg}</span>`;
            container.appendChild(el);
            requestAnimationFrame(() => el.classList.add('visible'));
            setTimeout(() => { el.classList.remove('visible'); setTimeout(() => el.remove(), 500); }, 3000);
        }

        // --- 4. API: Live Exchange Rate ---
        async function fetchLiveRate() {
            const rateEl = document.getElementById('current-rate');
            try {
                // Using a reliable free API (Base JPY is easier for travel "How many TWD is this JPY item?")
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                if (!res.ok) throw new Error("Network response was not ok");
                
                const data = await res.json();
                if (data.rates && data.rates.TWD) {
                    currentRate = data.rates.TWD;
                    rateEl.innerHTML = `1 JPY = <span class="font-bold text-accent-main">${currentRate.toFixed(3)}</span> TWD`;
                    rateEl.classList.add('text-green-600');
                    
                    // Recalculate dashboard totals with new rate if needed
                    renderExpenses();
                }
            } catch (e) {
                console.error("Rate Fetch Error:", e);
                rateEl.innerText = `離線匯率: ${currentRate} (更新失敗)`;
                rateEl.classList.add('text-red-500');
            }
        }

        // --- FIREBASE ---
        async function setupFirebase() {
            try {
                if (!firebaseConfig.apiKey) { renderTrip(); return; }
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
                else await signInAnonymously(auth);

                if (!auth.currentUser) throw new Error("Auth failed");

                expensesRef = collection(db, `artifacts/${appId}/public/data/expenses`);
                todosRef = collection(db, `artifacts/${appId}/public/data/todos`);

                onSnapshot(query(expensesRef), (snap) => {
                    expenses = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                    renderExpenses();
                    updateExpenseDashboard();
                });

                // 2. Logic Separation: Todos are handled independently
                onSnapshot(query(todosRef), (snap) => {
                    todos = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                    renderTodos();
                });

            } catch (e) { renderTrip(); showToast("離線模式", true); }
        }

        // --- LOGIC 1: TRIP & EVENTS ---
        function renderTrip() {
            const nav = document.getElementById('date-nav');
            nav.innerHTML = tripData.map((d, i) => `
                <div class="flex-shrink-0 w-16 text-center cursor-pointer transition-all duration-300 btn-touch ${i === currentIdx ? 'scale-110 opacity-100' : 'opacity-40 scale-90'}" onclick="window.switchDay(${i})">
                    <div class="text-xs font-bold mb-1">${d.week}</div>
                    <div class="serif text-3xl leading-none relative ${i === currentIdx ? 'text-accent-main' : 'text-gray-400'}">
                        ${d.date.split('.')[1]}
                        ${i === currentIdx ? '<div class="absolute -bottom-2 left-1/2 -translate-x-1/2 w-1 h-1 bg-accent-gold rounded-full"></div>' : ''}
                    </div>
                </div>
            `).join('');

            const day = tripData[currentIdx];
            const container = document.getElementById('timeline-container');
            
            let html = `
                <div class="hero-card mb-6 group bg-white">
                    <img src="${day.heroImg}" class="hero-img" onerror="this.src='https://placehold.co/600x400'">
                    <div class="hero-overlay">
                        <h2 class="text-2xl font-serif font-medium drop-shadow-md">${day.heroTitle}</h2>
                    </div>
                </div>
                <div class="timeline-block">
            `;
            html += day.events.map((ev, i) => `
                <div class="relative mb-8 pl-2 opacity-0 animate-[slideUp_0.5s_ease_forwards]" style="animation-delay: ${i*100}ms">
                    <div class="time-dot"></div>
                    <div class="event-card bg-white p-5 rounded shadow-sm btn-touch cursor-pointer" onclick="window.openDetail('${encodeURIComponent(JSON.stringify(ev))}')">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[0.6rem] tracking-widest text-gray-400 uppercase">${ev.tag}</span>
                            <span class="serif font-bold text-accent-red text-lg">${ev.time}</span>
                        </div>
                        <h3 class="serif text-xl text-accent-main font-bold mb-2">${ev.title}</h3>
                    </div>
                </div>
            `).join('');
            html += '</div>';
            container.innerHTML = html;
        }

        // --- LOGIC 2: CONVERTER & TODO (Separated) ---
        window.switchWidget = (type) => {
            // UI Toggle only
            document.querySelectorAll('.w-tab').forEach(el => el.classList.remove('active', 'bg-white', 'text-accent-main', 'font-bold', 'shadow-sm'));
            document.getElementById('tab-' + type).classList.add('active', 'bg-white', 'text-accent-main', 'font-bold', 'shadow-sm');
            
            if (type === 'converter') {
                document.getElementById('currency-converter').classList.remove('hidden');
                document.getElementById('todo-widget').classList.add('hidden');
            } else {
                document.getElementById('currency-converter').classList.add('hidden');
                document.getElementById('todo-widget').classList.remove('hidden');
            }
        };

        window.calcFromJpy = (v) => {
            if(!v) { document.getElementById('calc-twd').value = ''; return; }
            document.getElementById('calc-twd').value = Math.round(v * currentRate);
        };
        window.calcFromTwd = (v) => {
            if(!v) { document.getElementById('calc-jpy').value = ''; return; }
            document.getElementById('calc-jpy').value = Math.round(v / currentRate);
        };

        // Todo Render Logic (Pure, no exchange rate dependency)
        function renderTodos() {
            const list = document.getElementById('todo-list-ul');
            if(todos.length === 0) { list.innerHTML = '<div class="text-center text-gray-400 py-4 text-sm">無待辦事項</div>'; return; }
            list.innerHTML = todos.map(t => `
                <li class="flex items-center bg-gray-50 p-3 rounded hover:bg-white transition-colors">
                    <i class="fa-regular ${t.completed ? 'fa-square-check text-accent-gold' : 'fa-square text-gray-300'} text-xl cursor-pointer mr-3 btn-touch" onclick="window.toggleTodo('${t.id}', ${t.completed})"></i>
                    <span class="flex-1 text-sm ${t.completed ? 'line-through text-gray-400' : 'text-gray-800'}">${t.text}</span>
                    <i class="fa-solid fa-trash text-gray-300 hover:text-red-400 cursor-pointer p-2 btn-touch" onclick="window.deleteTodo('${t.id}')"></i>
                </li>
            `).join('');
        }

        window.addTodo = async () => {
            const input = document.getElementById('new-todo-text');
            const text = input.value.trim();
            if(!text || !todosRef) return;
            await addDoc(todosRef, { text, completed: false, timestamp: serverTimestamp() });
            input.value = '';
            showToast("已新增待辦");
        };
        window.toggleTodo = (id, s) => updateDoc(doc(todosRef, id), { completed: !s });
        window.deleteTodo = (id) => { deleteDoc(doc(todosRef, id)); showToast("已刪除"); };

        // --- LOGIC 3: EXPENSES ---
        window.selectUser = (user, btn) => {
            currentUser = user;
            localStorage.setItem('lv_user', user);
            document.querySelectorAll('.user-btn').forEach(el => {
                el.classList.remove('active', 'bg-accent-main', 'text-white', 'border-accent-main');
                el.classList.add('text-gray-500', 'border-gray-200');
            });
            btn.classList.add('active', 'bg-accent-main', 'text-white', 'border-accent-main');
            btn.classList.remove('text-gray-500', 'border-gray-200');
        };

        window.calculatePreview = (v) => {
            if(!v) document.getElementById('preview-twd').innerText = "≈ TWD 0";
            else document.getElementById('preview-twd').innerText = "≈ TWD " + Math.round(v * currentRate).toLocaleString();
        };

        window.addExpense = async () => {
            const item = document.getElementById('ex-item').value.trim();
            const price = parseInt(document.getElementById('ex-price').value);
            if(!item || !price) { showToast("請輸入完整資訊", true); return; }
            if(!expensesRef) { showToast("資料庫連線中...", true); return; }
            
            await addDoc(expensesRef, { user: currentUser, item, price, timestamp: serverTimestamp(), rate: currentRate });
            document.getElementById('ex-item').value = '';
            document.getElementById('ex-price').value = '';
            document.getElementById('preview-twd').innerText = "≈ TWD 0";
            showToast("記帳成功！");
        };

        function renderExpenses() {
            let filtered = currentFilterUser ? expenses.filter(e => e.user === currentFilterUser) : expenses;
            const total = filtered.reduce((sum, e) => sum + e.price, 0);
            document.getElementById('total-jpy').innerText = "¥" + total.toLocaleString();
            document.getElementById('total-twd').innerText = (total * currentRate).toFixed(0).toLocaleString();

            const list = document.getElementById('expense-list');
            if(filtered.length === 0) { list.innerHTML = '<div class="text-center text-gray-400 py-8 text-sm">尚無紀錄</div>'; return; }

            list.innerHTML = filtered.map(e => `
                <div class="flex items-center justify-between bg-white p-3 rounded-xl shadow-sm">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-accent-main text-white flex items-center justify-center text-xs font-serif">${e.user}</div>
                        <div>
                            <div class="font-medium text-gray-800 text-sm">${e.item}</div>
                            <div class="text-xs text-gray-400">${new Date(e.timestamp?.toDate()).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div class="serif text-base font-bold text-accent-main">¥${e.price.toLocaleString()}</div>
                </div>
            `).join('');
        }

        window.filterExpenses = (user) => {
            currentFilterUser = user;
            document.querySelectorAll('.dashboard-item').forEach(el => el.classList.remove('border-accent-gold', 'bg-orange-50'));
            if(user) {
                const idx = ['YK', 'YY', 'YS'].indexOf(user);
                document.querySelectorAll('.dashboard-item')[idx].classList.add('border-accent-gold', 'bg-orange-50');
                document.getElementById('reset-filter-btn').classList.remove('hidden');
            } else {
                document.getElementById('reset-filter-btn').classList.add('hidden');
            }
            renderExpenses();
        };

        function updateExpenseDashboard() {
            const totals = { 'YK': 0, 'YY': 0, 'YS': 0 };
            expenses.forEach(e => { if(totals[e.user] !== undefined) totals[e.user] += e.price; });
            document.getElementById('dash-yk').innerText = "¥" + totals['YK'].toLocaleString();
            document.getElementById('dash-yy').innerText = "¥" + totals['YY'].toLocaleString();
            document.getElementById('dash-ys').innerText = "¥" + totals['YS'].toLocaleString();
        }

        // --- UTILS ---
        window.switchDay = (i) => { currentIdx = i; renderTrip(); };
        window.switchView = (view, btn) => {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-' + view).classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(el => { el.classList.remove('active', 'text-accent-gold', 'scale-110'); el.classList.add('text-white/40'); });
            if(btn) { btn.classList.add('active', 'text-accent-gold', 'scale-110'); btn.classList.remove('text-white/40'); }
            window.scrollTo(0,0);
        };
        window.enterApp = () => document.getElementById('intro-screen').style.transform = 'translateY(-100%)';
        window.openDetail = (d) => {
            const data = JSON.parse(decodeURIComponent(d));
            document.getElementById('m-title').innerText = data.title;
            document.getElementById('m-desc').innerText = data.desc;
            document.getElementById('detail-modal').classList.remove('translate-y-full');
            document.querySelector('.modal-overlay').classList.remove('opacity-0', 'pointer-events-none');
        };
        window.closeModal = () => {
            document.getElementById('detail-modal').classList.add('translate-y-full');
            document.querySelector('.modal-overlay').classList.add('opacity-0', 'pointer-events-none');
        };
        window.translateNow = () => { 
            document.getElementById('trans-output-box').classList.remove('hidden');
            document.getElementById('trans-jp-result').innerText = "翻譯功能演示..."; 
        };

        // --- INIT ---
        window.onload = async () => {
            setupFirebase();
            fetchLiveRate(); // Start Live Rate Fetch
            renderTrip();
            
            // Countdown
            const diff = Math.ceil((new Date("2026-02-02") - new Date())/(1000*60*60*24));
            document.getElementById('days-left').innerText = diff > 0 ? diff : 0;
            document.getElementById('header-days').innerText = diff > 0 ? diff : 0;

            const savedUser = localStorage.getItem('lv_user');
            if(savedUser) {
                const idx = ['YK','YY','YS'].indexOf(savedUser);
                if(idx > -1) window.selectUser(savedUser, document.querySelectorAll('.user-btn')[idx]);
            }
            
            // 修正：在畫面載入後，重新啟動動態文字功能
            setTimeout(startDynamicText, 1000); 
        };
    </script>
</body>
</html>
